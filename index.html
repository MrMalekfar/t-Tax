<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simin.Gold</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Main CSS variables for the application theme */
        :root {
            --color-gold-light: #FFD700; /* Light Gold */
            --color-gold-dark: #DAA520; /* Dark Gold */
            --color-light-bg: #F8F8F8; /* Light Gray Background */
            --color-card-light-bg: #FFFFFF; /* White Card Background */
            --color-dark-text: #333333; /* Dark Gray Text */
            --color-gold-accent: #FFC107; /* Amber Gold for Accents */
            --color-input-bg-light: #F0F0F0; /* Light Input Background */
            --color-input-border-light: #E0E0E0; /* Light Input Border */
            --color-results-bg: #FFFBF0; /* Very Light Gold Background for Results */
            --color-results-border: #FFD700; /* Gold Border for Results */
        }

        /* Base styles and main font */
        body {
            font-family: "IranSans", sans-serif;
            direction: rtl;
            text-align: right;
            background-color: var(--color-light-bg);
            color: var(--color-dark-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        
        /* Add top padding for the fixed navbar */
        body.app-view {
             padding-top: 60px; /* Default value; will be adjusted by JavaScript */
        }

        /* Style for calculation result text */
        .highlighted-result {
            font-size: 1.125rem; /* اندازه فونت برای موبایل */
            color: var(--color-gold-dark);
            font-weight: bold;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--color-gold-light);
            padding-bottom: 0.5rem;
        }
        @media (min-width: 768px) {
             .highlighted-result {
                 font-size: 1.25rem; /* اندازه فونت برای دسکتاپ */
            }
        }

        /* Style for gold gradient buttons */
        .btn-gold-gradient {
            background: linear-gradient(145deg, var(--color-gold-light), var(--color-gold-dark));
            color: var(--color-dark-text);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-gold-gradient:hover {
            background: linear-gradient(145deg, var(--color-gold-dark), var(--color-gold-light));
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }

        /* Style for focused inputs */
        input:focus, select:focus {
            outline: none;
            border-color: var(--color-gold-accent);
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.5);
        }

        /* Style for tab buttons (tools) */
        .tab-button {
            font-weight: 600;
            background-color: var(--color-card-light-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            font-size: 0.8rem;
        }
        @media (min-width: 640px) {
            .tab-button {
                font-size: 0.9rem;
            }
        }
        
        .tab-button:hover {
            background-color: #fcfcfc;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        /* Active state styling for tab buttons */
        .tab-button.active {
            background-color: var(--color-results-bg);
            border-color: var(--color-gold-dark) !important;
        }
        
        @media (min-width: 768px) {
            .tab-button.active {
                box-shadow: 4px 0 20px rgba(255, 193, 7, 0.4);
            }
        }
         @media (max-width: 767px) {
            .tab-button.active {
                box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4);
            }
        }

        /* Color for tab button text and icons */
        .tab-button .tab-button-content,
        .tab-button .icon-placeholder {
            color: var(--color-dark-text);
            transition: color 0.3s ease;
        }
        
        .tab-button:hover .tab-button-content,
        .tab-button:hover .icon-placeholder {
            color: var(--color-gold-dark);
        }

        /* Keep icon and text color gold on active state */
        .tab-button.active .tab-button-content,
        .tab-button.active .icon-placeholder,
        .tab-button.active:hover .tab-button-content,
        .tab-button.active:hover .icon-placeholder {
            color: var(--color-gold-dark);
        }
        
        /* Size and alignment for tab button icons */
        .tab-button .icon-placeholder {
            width: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .tab-button-content {
            flex-grow: 1;
            text-align: right;
            padding-right: 1rem; /* space between icon and text */
            font-size: 0.9rem;
        }
        @media (max-width: 767px) {
            .tab-button-content {
                /* padding-right: 0.5rem; */
                padding-left: 0;
            }
        }

        /* Animation for displaying tab content */
        .tab-content {
            display: none;
            animation: fadeInSlideUp 0.5s ease-in-out forwards;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Top Info Navbar Styles --- */
        .navbar-top {
            background-color: var(--color-gold-dark);
            color: #333;
            padding: 10px 20px;
            font-size: 0.9rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: padding 0.3s ease;
        }

        .navbar-content-wrapper {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            align-items: center; 
            overflow: hidden; /* Hide items that don't fit on one line */
            flex-grow: 1;
            min-width: 0; /* Prevent flex items from overflowing the container */
        }

        .navbar-top.expanded .navbar-content-wrapper { 
            flex-wrap: wrap;
            justify-content: flex-start; /* چینش از راست در حالت باز شده */
            padding-bottom: 10px;
        }

        .navbar-content-wrapper > * {
            white-space: nowrap;
            font-weight: 500;
            flex-shrink: 0;
            display: block; /* Default display */
        }

        /* This class is added by JavaScript to hide items */
        .navbar-content-wrapper > .nav-item-hidden {
            display: none;
        }

        /* In expanded mode, hidden items are displayed */
        .navbar-top.expanded .navbar-content-wrapper > .nav-item-hidden {
            display: block;
        }
        
        .navbar-top span strong {
            font-weight: 700;
            color: rgb(98, 37, 37);
        }

        #navbar-toggle-btn {
            /* This button's visibility is controlled by JavaScript */
            background: transparent;
            border: none;
            color: #333;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px;
            margin-right: 10px; /* فاصله در حالت راست‌چین */
            flex-shrink: 0;
        }

        #navbar-toggle-btn.hidden {
            display: none;
        }

        #navbar-toggle-btn i {
            transition: transform 0.3s ease;
        }

        .navbar-top.expanded #navbar-toggle-btn i {
            transform: rotate(180deg);
        }
        
        /* --- Sidebar Tools Menu Styles --- */
        .tools-sidebar {
            transition: width 0.3s ease-in-out;
        }

        .tools-sidebar .tab-button-content {
            transition: width 0.2s 0.1s ease-in-out, opacity 0.2s 0.1s ease-in-out, padding 0.2s 0.1s ease-in-out;
        }
        
        /* Mobile styles: Menu is collapsed by default */
        @media (max-width: 767px) {
            .main-app-container {
                flex-direction: row;
                gap: 0; /* حذف فاصله برای چسبیدن منو به لبه */
            }

            .tools-sidebar {
                width: 60px; /* Smaller width for a compact look */
                flex-shrink: 0;
                overflow: hidden;
                border-left: 1px solid var(--color-input-border-light);
            }

            .tools-sidebar.is-expanded {
                width: 250px;
            }

            .tools-sidebar .tab-button {
                justify-content: center; /* Center the icon */
                padding: 0.75rem 0; /* Equivalent to p-3 vertical, p-0 horizontal */
            }

            .tools-sidebar.is-expanded .tab-button {
                justify-content: flex-start;
                padding: 1rem; /* Restore p-4 in expanded state */
            }

            .tools-sidebar .tab-button-content {
                width: 0;
                padding-right: 0;
                opacity: 0;
                white-space: nowrap;
            }
            
            .tools-sidebar.is-expanded .tab-button-content {
                width: auto;
                flex-grow: 1;
                padding-right: 1rem;
                opacity: 1;
            }
        }

        #logout-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .navbar-top.expanded #logout-btn {
            padding: 5px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 5px;
        }

        /* Style for the message box (for errors and success messages) */
        #messageBox {
            background-color: #4a5568; /* Gray-700 */
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            min-width: 300px;
        }

        /* Login Page Styles */
        #login-page {
            /* This section's display is controlled by JavaScript */
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            width: 100%;
            min-height: 100vh;
        }
        
        /* Print-related styles */
        @media print {
            body { display: none; } /* مخفی کردن بدنه اصلی برنامه هنگام چاپ */
        }
        .print-only {
            display: none;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block; } 
            body { display: block !important; } /* نمایش مجدد بدنه برای چاپ */

            @page {
                size: A5 landscape;
                margin: 5mm;
            }

            #invoicePreviewContainer {
                display: block !important;
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: 100% !important;
            }
        }
    </style>
</head>
<body>

    <!-- Login Page Container -->
    <div id="login-page" class="w-full p-4">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-2xl shadow-lg border border-gold-dark/20">
            <div class="text-center">
                <img src="logo.png" alt="لوگو" class="w-20 h-20 mx-auto mb-4" onerror="this.style.display='none'">
                <h2 class="text-2xl font-bold text-gold-dark">ورود به حساب کاربری</h2>
                <p class="mt-2 text-sm text-gray-600">لطفا اطلاعات خود را وارد کنید</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="text-sm font-bold text-gray-700 tracking-wide">نام کاربری</label>
                    <input id="username" type="text" class="w-full p-3 mt-2 text-gray-700 bg-input-bg-light rounded-md border border-input-border-light focus:border-gold-accent focus:bg-white focus:outline-none" required>
                </div>
                <div>
                    <label for="password" class="text-sm font-bold text-gray-700 tracking-wide">رمز عبور</label>
                    <input id="password" type="password" class="w-full p-3 mt-2 text-gray-700 bg-input-bg-light rounded-md border border-input-border-light focus:border-gold-accent focus:bg-white focus:outline-none" required>
                </div>
                <div>
                    <button type="submit" class="btn-gold-gradient w-full py-3 rounded-lg font-bold text-lg">
                        ورود
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="navbar-top no-print">
        <div class="navbar-content-wrapper">
            <span>دلار: <strong id="display-dollar-price">--</strong> تومان</span>
            <span>گرم: <strong id="display-gold18k-price">--</strong> تومان</span>
            <span>اونس: <strong id="display-ounce-price">--</strong> دلار</span>
            <span>مثقال: <strong id="display-mesghal-price">--</strong> تومان</span>
            <span>سکه: <strong id="display-sekke-jadid-price">--</strong> تومان</span>
            <span>نیم سکه: <strong id="display-sekke-nim-price">--</strong> تومان</span>
            <span>ربع سکه: <strong id="display-sekke-rob-price">--</strong> تومان</span>
            <span class="last-updated-span">
                <strong id="display-last-updated">--</strong>
            </span>
            <span>گرم (دلار واونس): <strong id="display-gold18k-ounce-price">--</strong> تومان</span>
        </div>

        <!-- Toggle button for mobile -->
        <button id="navbar-toggle-btn">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>

    <!-- Main Application Container -->
    <div class="main-app-container flex flex-row md:justify-center gap-4 md:gap-10 max-w-7xl mx-auto w-full p-4 md:p-8 rounded-3xl shadow-[0_15px_60px_rgba(0,0,0,0.1)] bg-card-light-bg border border-gold-dark/20 transition-all duration-500 no-print">

        <div class="md:w-1/5 flex flex-col justify-start items-stretch min-w-[unset] md:min-w-[200px] tools-sidebar">
            <div class="flex items-center justify-between border-b-2 border-gold-dark pb-2 md:pb-3 mb-4 md:mb-8 flex-shrink-0">
                <button id="tools-toggle-btn" class="md:hidden p-2 text-gold-dark text-xl">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="text-xl md:text-2xl font-bold text-gold-dark tab-button-content flex-grow text-right pr-2">
                    ابزارها
                </h2>
                <button id="logout-btn" class="text-red-800 font-bold hover:text-red-600 transition-colors p-2 rounded-md hover:bg-red-100/50">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </button>
            </div>
            <div id="tools-menu" class="flex flex-col">
                <button id="btn-tab1" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-balance-scale-left text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه وزن طلا</div>
                </button>
                <button id="btn-tab2" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-calculator text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه‌گر جامع</div>
                </button>
                <button id="btn-tab3" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-ring text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه طلای کهنه</div>
                </button>
                <button id="btn-tab6" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-fire text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه آبشده</div>
                </button>
                <button id="btn-tab7" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-coins text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه‌گر سکه</div>
                </button>
                <button id="btn-tab4" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-file-invoice-dollar text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">صدور فاکتور</div>
                </button>
                <button id="btn-tab5" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-gem text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">مدیریت اجناس</div>
                </button>
                <button id="btn-tab-archive" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-archive text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">آرشیو فاکتورها</div>
                </button>
                <button id="btn-tab-customers" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-users text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">مدیریت مشتریان</div>
                </button>
                <!-- NEW SETTINGS BUTTON -->
                <button id="btn-tab-settings" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-cog text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">تنظیمات</div>
                </button>
            </div>
        </div>

        <div class="w-full md:w-4/5 relative mt-4 md:mt-0 flex-grow min-w-0"> 
            <div id="tab-column1" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه وزن طلا (بر اساس قیمت هدف)
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="price_gram1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نرخ گرم (18):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_gram1" value="" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="goldPurity1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="goldPurity1" list="purity-list" value="750" step="any" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="wage1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">اجرت (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="wage1" value="5" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="profit1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">سود (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="profit1" value="5" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="VAT1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">مالیات (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="VAT1" value="10" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="price_whole1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">قیمت هدف :</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_whole1" value="68,000,000" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                </div>
                <button id="calculateBtn1" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه و ذخیره
                </button>

                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">وزن محاسبه شده: <span id="display-weight1" class="font-bold text-gold-dark">0</span> گرم</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">مالیات بر ارزش افزوده : <span id="display-tax1" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">قیمت قبل از محاسبه مالیات : <span id="display-price-before-tax1" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <button id="invoiceFromCalc1" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>صدور فاکتور برای این محاسبه
                    </button>
                </div>
            </div>

            <div id="tab-column2" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه‌گر جامع
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="price_gram2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نرخ گرم (18):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_gram2" value="" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="goldPurity2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                             <input type="number" id="goldPurity2" list="purity-list" value="750" step="any" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="weight2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="weight2" value="0" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                            <span class="text-gold-dark mr-2 text-sm"></span>
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="wage2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">اجرت (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="wage2" value="20" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="profit2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">سود (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="profit2" value="7" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="VAT2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">مالیات (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="VAT2" value="10" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                </div>
                <button id="calculateBtn2" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه و ذخیره
                </button>

                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">قیمت نهایی: <span id="display-price-after-tax2" class="font-bold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">وزن در عیار 750: <span id="display-adjusted_wheight_to_750" class="font-bold text-gold-dark">0</span> گرم</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">مالیات بر ارزش افزوده: <span id="display-tax2" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">قیمت قبل از محاسبه مالیات: <span id="display-weight2" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">قیمت هر گرم با احتساب اجرت و سود: <span id="display-gram-price-after-tax2" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <button id="invoiceFromCalc2" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>صدور فاکتور برای این محاسبه
                    </button>
                </div>
            </div>

            <div id="tab-column3" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه طلای کهنه
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="price_gram3" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نرخ گرم (18):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_gram3" value="" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="goldPurity3" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                             <input type="number" id="goldPurity3" list="purity-list" value="750" step="any" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="weight_input3" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="weight_input3" value="1" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                            <span class="text-gold-dark mr-2 text-sm"></span>
                        </div>
                    </div>
                </div>
                <button id="calculateBtn3" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه و ذخیره
                </button>

                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">قیمت نهایی: <span id="display-total-price3" class="font-bold text-gold-dark">0</span> تومان</p>
                    <button id="invoiceFromCalc3" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>صدور فاکتور برای این محاسبه
                    </button>
                </div>
            </div>
            
            <div id="tab-column6" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه خرید و فروش آبشده
                </h2>
        
                <div class="flex items-center justify-center gap-6 mb-6">
                    <label class="flex items-center gap-2 cursor-pointer text-lg font-semibold">
                        <input type="radio" name="transaction_type6" value="sell" class="form-radio h-5 w-5 text-gold-dark focus:ring-gold-accent" checked>
                        <span>فروش</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-lg font-semibold">
                        <input type="radio" name="transaction_type6" value="buy" class="form-radio h-5 w-5 text-gold-dark focus:ring-gold-accent">
                        <span>خرید</span>
                    </label>
                </div>
        
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label id="price_gram6_label" for="price_gram6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نرخ گرم (۱۸):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_gram6" value="" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="goldPurity6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                             <input type="number" id="goldPurity6" list="purity-list" value="750" step="any" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="weight_gram6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن (گرم):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="weight_gram6" value="1" step="0.01" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="profit_melted" class="text-sm sm:text-base font-semibold text-dark-text mb-2">سود (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="profit_melted" value="2" step="0.5" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="VAT6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">مالیات (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="VAT6" value="10" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div id="buyDeductionContainer6" class="responsive-input-group flex-col mb-4 hidden">
                        <label for="buy_deduction6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">کسری خرید (تومان):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="buy_deduction6" value="100,000" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                </div>
                <button id="calculateBtn6" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه
                </button>
        
                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">قیمت نهایی: <span id="display-total-price6" class="font-bold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">وزن در عیار 750: <span id="display-adjusted-weight-750-6" class="font-bold text-gold-dark">0</span> گرم</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">مالیات بر ارزش افزوده: <span id="display-tax-6" class="font-extrabold text-gold-dark">0</span> تومان</p>
                </div>

                <button id="invoiceFromCalc6" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>صدور فاکتور برای این محاسبه
                </button>
            </div>

            <div id="tab-column7" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه‌گر خرید و فروش سکه
                </h2>
        
                <div class="flex items-center justify-center gap-6 mb-6">
                    <label class="flex items-center gap-2 cursor-pointer text-lg font-semibold">
                        <input type="radio" name="transaction_type7" value="sell" class="form-radio h-5 w-5 text-gold-dark focus:ring-gold-accent" checked>
                        <span>فروش</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-lg font-semibold">
                        <input type="radio" name="transaction_type7" value="buy" class="form-radio h-5 w-5 text-gold-dark focus:ring-gold-accent">
                        <span>خرید</span>
                    </label>
                </div>
        
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="coin_type7" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نوع سکه:</label>
                        <select id="coin_type7" class="w-full p-2 sm:p-3 rounded-md border bg-input-bg-light text-dark-text border-input-border-light">
                            <option value="sekke_jadid">سکه تمام (جدید)</option>
                            <option value="sekke_ghadim">سکه تمام (قدیم)</option>
                            <option value="sekke_nim">نیم سکه</option>
                            <option value="sekke_rob">ربع سکه</option>
                            <option value="sekke_gerami">سکه گرمی</option>
                            <option value="parsian">پارسیان</option>
                        </select>
                    </div>
                    <div id="parsian_weight_container7" class="responsive-input-group flex flex-col mb-4 hidden">
                        <label for="parsian_weight7" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن پارسیان (گرم):</label>
                        <input type="number" id="parsian_weight7" value="1" step="0.01" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="coin_quantity7" class="text-sm sm:text-base font-semibold text-dark-text mb-2">تعداد:</label>
                        <input type="number" id="coin_quantity7" value="1" min="1" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="coin_price7" class="text-sm sm:text-base font-semibold text-dark-text mb-2">قیمت واحد (تومان):</label>
                        <input type="text" id="coin_price7" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                    </div>
                </div>
                <button id="calculateBtn7" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه
                </button>
        
                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">مبلغ کل: <span id="display-total-price7" class="font-bold text-gold-dark">0</span> تومان</p>
                </div>

                <button id="invoiceFromCalc7" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>افزودن به فاکتور
                </button>
            </div>
            
            <div id="tab-column4" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    صدور فاکتور طلا
                </h2>

                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">مشخصات مشتری</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="responsive-input-group flex flex-col mb-4">
                            <label for="customerName" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نام مشتری (برای جستجو تایپ کنید):</label>
                            <div class="input-wrapper relative flex-1 flex items-center w-full">
                                <input type="text" id="customerName" class="w-full p-2 rounded-md border text-right bg-input-bg-light border-input-border-light text-sm">
                                <div id="customer-suggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md mt-1 z-10 shadow-lg hidden max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>
                        <div class="responsive-input-group flex flex-col mb-4">
                            <label for="customerPhone" class="text-sm sm:text-base font-semibold text-dark-text mb-2">شماره تماس:</label>
                            <div class="input-wrapper flex-1 flex items-center w-full">
                                <input type="text" id="customerPhone" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm" placeholder="مثال: 09121234567">
                            </div>
                        </div>
                        <div class="responsive-input-group flex flex-col mb-4">
                            <label for="invoiceDate" class="text-sm sm:text-base font-semibold text-dark-text mb-2">تاریخ فاکتور:</label>
                            <div class="input-wrapper flex-1 flex items-center w-full">
                                <input type="text" id="invoiceDate" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm" placeholder="به صورت خودکار تکمیل می شود" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">تنظیمات پیش‌فرض فاکتور (از بخش تنظیمات خوانده می‌شود)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="responsive-input-group flex flex-col">
                            <label for="invoiceProfit" class="text-sm sm:text-base font-semibold text-dark-text mb-2">سود پیش‌فرض (%):</label>
                            <input type="number" id="invoiceProfit" value="7" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="invoiceVAT" class="text-sm sm:text-base font-semibold text-dark-text mb-2">مالیات پیش‌فرض (%):</label>
                            <input type="number" id="invoiceVAT" value="10" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark flex justify-between items-center">
                        جزئیات اقلام طلا
                        <button id="addGoldItemBtn" class="px-4 py-2 text-white rounded-md text-sm hover:bg-gold-dark transition-colors inline-flex items-center justify-center" style="background-color: var(--color-gold-accent);">
                            <i class="fas fa-plus ml-1"></i>افزودن آیتم
                        </button>
                    </h3>
                    <div id="goldItemsContainer" class="p-2">
                    </div>
                </div>

                <div id="invoiceSummary" class="mt-6 p-4 border rounded-lg bg-results-bg border-results-border">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">خلاصه فاکتور</h3>
                    <div class="space-y-2">
                        <p class="text-dark-text flex justify-between"><span>جمع کل فروش:</span> <strong id="summaryTotalSales" class="text-gold-dark">0 تومان</strong></p>
                        <p class="text-dark-text flex justify-between"><span>جمع کل خرید:</span> <strong id="summaryTotalPurchases" class="text-gold-dark">0 تومان</strong></p>
                        <hr class="my-2">
                        <p class="text-dark-text flex justify-between text-xl">
                            <span id="summaryFinalAmountLabel">مبلغ نهایی پرداختی:</span>
                            <strong id="summaryFinalAmount" class="text-gold-dark">0 تومان</strong>
                        </p>
                    </div>
                </div>

                <!-- NEW: Payment Section -->
                <div id="invoicePaymentSection" class="mt-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">تسویه حساب</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Cash Payment -->
                        <div>
                            <label for="cashPayment" class="text-sm sm:text-base font-semibold text-dark-text mb-2">پرداخت نقدی (تومان):</label>
                            <input type="text" id="cashPayment" oninput="App.Utils.formatNumberInput(this); App.Invoice.updateTotal();" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm" placeholder="0">
                        </div>
                        <!-- Old Gold Payment -->
                        <div>
                            <h4 class="text-sm sm:text-base font-semibold text-dark-text mb-2">پرداخت با طلای کهنه:</h4>
                            <div class="flex gap-4">
                                <input type="number" id="oldGoldPaymentWeight" class="w-1/2 p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm" placeholder="وزن (گرم)" oninput="App.Invoice.updateTotal()">
                                <input type="number" id="oldGoldPaymentPurity" list="purity-list" class="w-1/2 p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm" value="750" placeholder="عیار" oninput="App.Invoice.updateTotal()">
                            </div>
                        </div>
                    </div>
                    <p class="text-dark-text flex justify-between text-lg mt-4 pt-2 border-t"><span>مبلغ باقیمانده:</span> <strong id="summaryRemainingAmount" class="text-red-600">0 تومان</strong></p>
                </div>

                <div class="flex gap-4 mt-4 sm:mt-6 no-print">
                    <button id="generateInvoiceBtn" class="btn-gold-gradient flex-1 py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold">
                        صدور و پیش‌نمایش فاکتور
                    </button>
                    <button id="printInvoiceBtn" class="hidden flex-1 py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold text-white bg-green-600 hover:bg-green-700 transition-colors">
                        <i class="fas fa-print mr-2"></i>چاپ
                    </button>
                </div>
                <div id="invoicePreviewContainerWrapper" class="hidden mt-6">
                         <h3 class="text-lg font-semibold mb-3 text-gold-dark">پیش‌نمایش فاکتور (سایز A5 Landscape)</h3>
                         <div id="invoicePreviewContainer" class="p-4 bg-white border border-gray-300 rounded-lg shadow-lg mx-auto" style="width: 210mm; min-height: 148mm; box-sizing: border-box;">
                               </div>
                </div>
            </div>

            <div id="tab-column5" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    مدیریت اجناس (آفلاین)
                </h2>

                <div id="product-form-container" class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 id="product-form-title" class="text-lg font-semibold mb-3 text-gold-dark">افزودن جنس جدید</h3>
                    <form id="product-form">
                        <input type="hidden" id="productId">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <div class="responsive-input-group flex flex-col mb-4 lg:col-span-2">
                                <label for="productName" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نام/شرح کالا:</label>
                                <div class="input-wrapper flex-1 flex items-center w-full">
                                    <input type="text" id="productName" required class="w-full p-2 rounded-md border text-right bg-input-bg-light border-input-border-light text-sm">
                                </div>
                            </div>
                            <div class="responsive-input-group flex flex-col mb-4">
                                <label for="productBarcode" class="text-sm sm:text-base font-semibold text-dark-text mb-2">بارکد:</label>
                                <div class="input-wrapper flex-1 flex items-center w-full">
                                    <input type="text" id="productBarcode" readonly class="w-full p-2 rounded-md bg-gray-200 border border-input-border-light text-left text-sm cursor-not-allowed" placeholder="خودکار">
                                </div>
                            </div>
                            <div class="responsive-input-group flex flex-col mb-4">
                                <label for="productWeight" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن:</label>
                                <div class="input-wrapper flex-1 flex items-center w-full">
                                    <input type="number" id="productWeight" step="0.01" required class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                                </div>
                            </div>
                            <div class="responsive-input-group flex flex-col mb-4">
                                <label for="productPurity" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                                <div class="input-wrapper flex-1 flex items-center w-full">
                                    <input type="number" id="productPurity" list="purity-list" value="750" step="any" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                                </div>
                            </div>
                            <div class="responsive-input-group flex flex-col mb-4">
                                <label for="productWage" class="text-sm sm:text-base font-semibold text-dark-text mb-2">اجرت (%):</label>
                                <div class="input-wrapper flex-1 flex items-center w-full">
                                    <input type="number" id="productWage" value="20" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-4">
                            <button type="submit" class="btn-gold-gradient py-2 rounded-lg text-sm font-bold flex-1">
                                <i class="fas fa-save mr-2"></i><span id="product-form-submit-btn-text">ذخیره جنس</span>
                            </button>
                            <button type="button" id="cancelEditBtn" class="hidden py-2 px-4 rounded-lg text-sm font-bold bg-gray-400 text-white hover:bg-gray-500 transition-colors">
                                <i class="fas fa-times mr-2"></i>لغو ویرایش
                            </button>
                        </div>
                    </form>
                </div>

                <div class="p-4 border rounded-lg bg-gray-50">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-gold-dark">لیست اجناس ذخیره شده</h3>
                        <div class="flex gap-2">
                            <button id="import-btn" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors inline-flex items-center justify-center">
                                <i class="fas fa-file-import ml-2"></i>وارد کردن
                            </button>
                            <button id="export-btn" class="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors inline-flex items-center justify-center">
                                <i class="fas fa-file-excel ml-2"></i>خروجی اکسل
                            </button>
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4 mt-4">
                        <label for="productSearch" class="text-sm sm:text-base font-semibold text-dark-text mb-2">جستجو بر اساس نام یا بارکد:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="productSearch" class="w-full p-2 rounded-md border text-right bg-input-bg-light border-input-border-light text-sm" placeholder="نام کالا یا بارکد را وارد کنید...">
                        </div>
                    </div>
                    <div id="productList" class="overflow-x-auto">
                        <!-- Product cards will be injected here -->
                    </div>
                </div>
            </div>

            <div id="tab-column-archive" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    آرشیو فاکتورها
                </h2>

                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">جستجو و نمایش</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="responsive-input-group flex flex-col">
                            <label for="invoiceSearchNumber" class="text-sm sm:text-base font-semibold text-dark-text mb-2">شماره فاکتور:</label>
                            <input type="text" id="invoiceSearchNumber" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm" placeholder="شماره فاکتور...">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="invoiceSearchCustomer" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نام مشتری:</label>
                            <input type="text" id="invoiceSearchCustomer" class="w-full p-2 rounded-md border text-right bg-input-bg-light border-input-border-light text-sm" placeholder="بخشی از نام مشتری را وارد کنید...">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="invoiceSearchDate" class="text-sm sm:text-base font-semibold text-dark-text mb-2">تاریخ (مثال: 1403/05/01):</label>
                            <input type="text" id="invoiceSearchDate" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm" placeholder="تاریخ دقیق یا بخشی از آن...">
                        </div>
                        <!-- NEW: Customer Balance Filter -->
                        <div class="responsive-input-group flex flex-col">
                            <label for="customerBalanceFilter" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وضعیت حساب:</label>
                            <select id="customerBalanceFilter" class="w-full p-2 rounded-md border bg-input-bg-light border-input-border-light text-sm">
                                <option value="all">همه</option>
                                <option value="debtor">بدهکار</option>
                                <option value="creditor">بستانکار</option>
                                <option value="zero">بی حساب</option>
                            </select>
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemsPerPage" class="text-sm sm:text-base font-semibold text-dark-text mb-2">تعداد در صفحه:</label>
                            <select id="itemsPerPage" class="w-full p-2 rounded-md border bg-input-bg-light border-input-border-light text-sm">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="invoice-archive-list" class="overflow-x-auto">
                    <!-- Invoice cards will be injected here -->
                </div>
                <div id="pagination-controls" class="flex justify-center items-center gap-4 mt-4"></div>
            </div>

            <div id="tab-column-customers" class="tab-content p-2 sm:p-4">
                <div id="customer-list-view">
                    <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                        مدیریت مشتریان
                    </h2>

                    <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-3 text-gold-dark">افزودن مشتری جدید</h3>
                        <form id="add-customer-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div class="responsive-input-group flex flex-col">
                                <label for="newCustomerName" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نام مشتری:</label>
                                <input type="text" id="newCustomerName" class="w-full p-2 rounded-md border text-right bg-input-bg-light border-input-border-light text-sm" required>
                            </div>
                            <div class="responsive-input-group flex flex-col">
                                <label for="newCustomerPhone" class="text-sm sm:text-base font-semibold text-dark-text mb-2">شماره تماس (اختیاری):</label>
                                <input type="text" id="newCustomerPhone" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                            </div>
                            <div class="responsive-input-group flex flex-col">
                                <button type="submit" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold">
                                    <i class="fas fa-plus mr-2"></i>افزودن مشتری
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-3 text-gold-dark">جستجوی مشتری</h3>
                        <div class="responsive-input-group flex flex-col">
                            <label for="customerSearch" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نام یا شماره تماس مشتری:</label>
                            <input type="text" id="customerSearch" class="w-full p-2 rounded-md border text-right bg-input-bg-light border-input-border-light text-sm" placeholder="بخشی از نام یا شماره تماس را وارد کنید...">
                        </div>
                    </div>

                    <div id="customer-list" class="overflow-x-auto">
                        <!-- Customer cards will be injected here -->
                    </div>
                </div>

                <div id="customer-details-view" class="hidden">
                    <div class="flex justify-between items-center mb-4 sm:mb-6 border-b border-gold-dark pb-2 sm:pb-3">
                        <h2 class="text-lg sm:text-xl font-bold text-gold-dark">
                            جزئیات مشتری: <span id="details-customer-name" class="text-gray-700"></span>
                        </h2>
                        <button id="back-to-customer-list" class="px-4 py-2 text-sm bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors inline-flex items-center justify-center">
                            <i class="fas fa-arrow-right ml-2"></i> بازگشت به لیست
                        </button>
                    </div>
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-md font-semibold text-blue-800">مانده حساب کل: <strong id="details-customer-balance">0 تومان</strong></p>
                    </div>
                    <div id="customer-invoice-list" class="overflow-x-auto">
                        <!-- Customer invoice list will be injected here -->
                    </div>
                </div>
            </div>

            <!-- NEW SETTINGS TAB CONTENT -->
            <div id="tab-column-settings" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    تنظیمات برنامه
                </h2>

                <!-- Store Profile Settings -->
                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">مشخصات فروشگاه (برای فاکتور)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="responsive-input-group flex flex-col">
                            <label for="settingStoreName" class="text-sm font-semibold text-dark-text mb-2">نام فروشگاه:</label>
                            <input type="text" id="settingStoreName" class="w-full p-2 rounded-md border bg-input-bg-light border-input-border-light text-sm" placeholder="مثال: جواهری فانی">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="settingStorePhone" class="text-sm font-semibold text-dark-text mb-2">شماره تماس:</label>
                            <input type="text" id="settingStorePhone" class="w-full p-2 rounded-md border bg-input-bg-light border-input-border-light text-sm" placeholder="مثال: 09121234567">
                        </div>
                        <div class="responsive-input-group flex flex-col col-span-1 md:col-span-2">
                            <label for="settingStoreAddress" class="text-sm font-semibold text-dark-text mb-2">آدرس:</label>
                            <input type="text" id="settingStoreAddress" class="w-full p-2 rounded-md border bg-input-bg-light border-input-border-light text-sm" placeholder="مثال: خوی، مجتمع تجاری ...">
                        </div>
                        <div class="responsive-input-group flex flex-col col-span-1 md:col-span-2">
                            <label for="settingStoreLogo" class="text-sm font-semibold text-dark-text mb-2">لوگو (اختیاری):</label>
                            <input type="file" id="settingStoreLogo" class="text-sm" accept="image/png, image/jpeg">
                            <img id="logoPreview" src="" alt="پیش‌نمایش لوگو" class="hidden mt-2 h-16 w-16 object-contain border p-1 rounded-md">
                        </div>
                    </div>
                </div>

                <!-- Default Values Settings -->
                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">مقادیر پیش‌فرض فاکتور</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="responsive-input-group flex flex-col">
                            <label for="settingDefaultProfit" class="text-sm font-semibold text-dark-text mb-2">سود پیش‌فرض (%):</label>
                            <input type="number" id="settingDefaultProfit" class="w-full p-2 rounded-md border bg-input-bg-light border-input-border-light text-left text-sm" placeholder="مثال: 7">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="settingDefaultVAT" class="text-sm font-semibold text-dark-text mb-2">مالیات پیش‌فرض (%):</label>
                            <input type="number" id="settingDefaultVAT" class="w-full p-2 rounded-md border bg-input-bg-light border-input-border-light text-left text-sm" placeholder="مثال: 10">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="settingOldGoldDeduction" class="text-sm font-semibold text-dark-text mb-2">کسری بار طلای کهنه (از 750):</label>
                            <input type="number" id="settingOldGoldDeduction" class="w-full p-2 rounded-md border bg-input-bg-light border-input-border-light text-left text-sm" placeholder="مثال: 15">
                        </div>
                    </div>
                </div>
                
                <!-- Save All Settings Button -->
                <button id="saveSettingsBtn" class="btn-gold-gradient w-full py-3 rounded-lg font-bold text-lg mb-6">
                    <i class="fas fa-save mr-2"></i>ذخیره تمام تنظیمات
                </button>
                
                <!-- Data Management -->
                <div class="mb-6 p-4 border rounded-lg bg-red-50 border-red-200">
                    <h3 class="text-lg font-semibold mb-3 text-red-700">مدیریت داده‌ها (بسیار مهم)</h3>
                    <p class="text-sm text-red-600 mb-4">تمام اطلاعات شما در همین مرورگر ذخیره می‌شود. برای جلوگیری از حذف ناگهانی اطلاعات، به طور منظم از داده‌های خود فایل پشتیبان تهیه کنید.</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="backupDataBtn" class="flex-1 px-4 py-2 text-white rounded-md bg-blue-600 hover:bg-blue-700 transition-colors inline-flex items-center justify-center">
                            <i class="fas fa-download ml-2"></i>تهیه فایل پشتیبان (Backup)
                        </button>
                        <button id="restoreDataBtn" class="flex-1 px-4 py-2 text-white rounded-md bg-green-600 hover:bg-green-700 transition-colors inline-flex items-center justify-center">
                            <i class="fas fa-upload ml-2"></i>بازیابی از فایل (Restore)
                        </button>
                        <input type="file" id="restoreFileInput" class="hidden" accept=".json">
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="messageBox" class="hidden">
    </div>
    
    <div id="print-area" class="print-only"></div>
    <input type="file" id="import-file-input" class="hidden" accept=".csv">


    <datalist id="purity-list">
        <option value="750">18 عیار</option>
        <option value="583.3">14 عیار</option>
        <option value="708.3">17 عیار</option>
        <option value="791.6">19 عیار</option>
        <option value="875">21 عیار</option>
        <option value="916">22 عیار</option>
        <option value="999.9">24 عیار</option>
    </datalist>

<script>
    // Main application object to organize the code
    const App = {
        appLogicInitialized: false, // Flag to prevent running the app logic multiple times
        liveGoldPrice18k: 0, 
        liveMesghalPrice: 0,
        livePrices: {}, // Store all live prices
        userModifiedPrices: {},

        Auth: { // مدیریت احراز هویت، ورود و خروج کاربر

            SECRET_SALT: 'fghfgjkfggirokdldd545gregd546fg4rgfg45sg5g4rs6f5dsrg46sd45h5j4ukiu5!@#',                                    
            CORRECT_USERNAME_HASH: '905c26e1ffc9dfd6f34d48c9534033db3b914204bd7af7d3f50c8f1856aa5fe5',
            CORRECT_PASSWORD_HASH: 'ded0a1a73e6dbceb9db5c9e62ef553c30ab3f94c857c4a582d3af80e5b4572d8',

            async hashString(str) {
                const textAsBuffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', textAsBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },

            init: function() {
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                this.checkSession();
            },

            handleLogin: async function() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                const storedUserHash = localStorage.getItem('usernameHash') || this.CORRECT_USERNAME_HASH;
                const storedPassHash = localStorage.getItem('passwordHash') || this.CORRECT_PASSWORD_HASH;

                const usernameHash = await this.hashString(username + this.SECRET_SALT);
                const passwordHash = await this.hashString(password + this.SECRET_SALT);

                if (usernameHash === storedUserHash && passwordHash === storedPassHash) {
                    // On first successful login with default credentials, store them if not already stored.
                    if (!localStorage.getItem('usernameHash')) {
                        localStorage.setItem('usernameHash', usernameHash);
                        localStorage.setItem('passwordHash', passwordHash);
                    }
                    sessionStorage.setItem('isLoggedIn', 'true');
                    this.showApp();
                } else {
                    App.UI.showMessage('نام کاربری یا رمز عبور اشتباه است.');
                }
            },
            
            handleLogout: function() {
                sessionStorage.removeItem('isLoggedIn');
                location.reload(); // The simplest way to reset the app and show the login page
            },

            checkSession: function() {
                if (sessionStorage.getItem('isLoggedIn') === 'true') { 
                    this.showApp();
                } else {
                    this.showLogin();
                }
            },

            showLogin: function() {
                document.body.classList.remove('app-view');
                document.getElementById('login-page').style.display = 'flex';
                document.querySelector('.main-app-container').style.display = 'none';
                document.querySelector('.navbar-top').style.display = 'none';
            },

            showApp: function() {
                document.body.classList.add('app-view');
                document.getElementById('login-page').style.display = 'none';
                document.querySelector('.main-app-container').style.display = 'flex';
                document.querySelector('.navbar-top').style.display = 'flex';
                
                // The main app logic runs only once after a successful login
                if (!App.appLogicInitialized) {
                    App.initAppLogic();
                    App.appLogicInitialized = true;
                }
            },
        },
        
        // NEW SETTINGS OBJECT
        Settings: {
            init: function() {
                // Load settings when the app starts
                this.loadSettings();

                // Event Listeners
                document.getElementById('saveSettingsBtn').addEventListener('click', () => this.saveSettings());
                document.getElementById('backupDataBtn').addEventListener('click', () => this.backupData());
                document.getElementById('restoreDataBtn').addEventListener('click', () => {
                    document.getElementById('restoreFileInput').click();
                });
                document.getElementById('restoreFileInput').addEventListener('change', (e) => this.handleRestoreFile(e));
                document.getElementById('settingStoreLogo').addEventListener('change', (e) => this.previewLogo(e));
            },

            loadSettings: function() {
                const settings = {
                    storeName: localStorage.getItem('settingStoreName') || '',
                    storeAddress: localStorage.getItem('settingStoreAddress') || '',
                    storePhone: localStorage.getItem('settingStorePhone') || '',
                    defaultProfit: localStorage.getItem('settingDefaultProfit') || '7',
                    defaultVAT: localStorage.getItem('settingDefaultVAT') || '10',
                    oldGoldDeduction: localStorage.getItem('settingOldGoldDeduction') || '15', // Load new setting
                    storeLogo: localStorage.getItem('settingStoreLogo') || ''
                };

                document.getElementById('settingStoreName').value = settings.storeName;
                document.getElementById('settingStoreAddress').value = settings.storeAddress;
                document.getElementById('settingStorePhone').value = settings.storePhone;
                document.getElementById('settingDefaultProfit').value = settings.defaultProfit;
                document.getElementById('settingDefaultVAT').value = settings.defaultVAT;
                document.getElementById('settingOldGoldDeduction').value = settings.oldGoldDeduction;

                // Update default invoice profit/VAT inputs as well
                document.getElementById('invoiceProfit').value = settings.defaultProfit;
                document.getElementById('invoiceVAT').value = settings.defaultVAT;

                const logoPreview = document.getElementById('logoPreview');
                if (settings.storeLogo) {
                    logoPreview.src = settings.storeLogo;
                    logoPreview.classList.remove('hidden');
                } else {
                    logoPreview.classList.add('hidden');
                }
            },

            saveSettings: function() {
                const logoFile = document.getElementById('settingStoreLogo').files[0];
                
                const saveToStorage = (logoDataUrl = null) => {
                    localStorage.setItem('settingStoreName', document.getElementById('settingStoreName').value);
                    localStorage.setItem('settingStoreAddress', document.getElementById('settingStoreAddress').value);
                    localStorage.setItem('settingStorePhone', document.getElementById('settingStorePhone').value);
                    localStorage.setItem('settingDefaultProfit', document.getElementById('settingDefaultProfit').value);
                    localStorage.setItem('settingDefaultVAT', document.getElementById('settingDefaultVAT').value);
                    localStorage.setItem('settingOldGoldDeduction', document.getElementById('settingOldGoldDeduction').value); // Save new setting
                    if (logoDataUrl) {
                        localStorage.setItem('settingStoreLogo', logoDataUrl);
                    }
                    App.UI.showMessage('تنظیمات با موفقیت ذخیره شد.', 'success');
                    this.loadSettings(); // Reload to reflect changes everywhere
                };

                if (logoFile) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        saveToStorage(reader.result);
                    };
                    reader.readAsDataURL(logoFile);
                } else {
                    // If no new file is selected, we don't overwrite the existing logo
                    // The user must explicitly choose a file to change it.
                    // We can check if a logo is already there and decide not to pass null.
                    const existingLogo = localStorage.getItem('settingStoreLogo');
                    saveToStorage(existingLogo);
                }
            },

            previewLogo: function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    const logoPreview = document.getElementById('logoPreview');
                    reader.onload = (e) => {
                        logoPreview.src = e.target.result;
                        logoPreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            },

            backupData: async function() {
                if (!App.DB.db) {
                    App.UI.showMessage('پایگاه داده برای پشتیبان‌گیری در دسترس نیست.');
                    return;
                }

                App.UI.showMessage('در حال جمع‌آوری اطلاعات برای پشتیبان‌گیری... لطفاً صبر کنید.', 'info');
                
                try {
                    const stores = ['products', 'invoices', 'customers'];
                    const backupObject = {};

                    const transaction = App.DB.db.transaction(stores, 'readonly');
                    
                    const promises = stores.map(storeName => {
                        return new Promise((resolve, reject) => {
                            const request = transaction.objectStore(storeName).getAll();
                            request.onsuccess = () => resolve({ storeName, data: request.result });
                            request.onerror = () => reject(request.error);
                        });
                    });
                    
                    const results = await Promise.all(promises);
                    results.forEach(result => {
                        backupObject[result.storeName] = result.data;
                    });

                    const jsonString = JSON.stringify(backupObject, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const date = new Date().toLocaleDateString('fa-IR-u-nu-latn').replace(/\//g, '-');
                    a.href = url;
                    a.download = `simin-gold-backup-${date}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    App.UI.showMessage('فایل پشتیبان با موفقیت دانلود شد.', 'success');

                } catch (error) {
                    console.error('Backup failed:', error);
                    App.UI.showMessage('خطا در تهیه فایل پشتیبان.');
                }
            },

            handleRestoreFile: function(event) {
                const file = event.target.files[0];
                if (!file) return;

                App.UI.showConfirmation(
                    'توجه! با بازیابی اطلاعات، تمام داده‌های فعلی شما (اجناس، فاکتورها، مشتریان) پاک شده و اطلاعات فایل پشتیبان جایگزین می‌شود. آیا ادامه می‌دهید؟',
                    () => {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            try {
                                const backupObject = JSON.parse(e.target.result);
                                if (!backupObject.products || !backupObject.invoices || !backupObject.customers) {
                                    throw new Error('Invalid backup file structure.');
                                }

                                const stores = ['products', 'invoices', 'customers'];
                                const transaction = App.DB.db.transaction(stores, 'readwrite');
                                
                                const promises = stores.map(storeName => {
                                    return new Promise((resolve, reject) => {
                                        const store = transaction.objectStore(storeName);
                                        const clearRequest = store.clear();
                                        clearRequest.onsuccess = () => {
                                            let count = 0;
                                            const items = backupObject[storeName];
                                            if (items.length === 0) {
                                                resolve();
                                                return;
                                            }
                                            items.forEach(item => {
                                                // Ensure we don't re-insert keys for auto-incrementing stores
                                                const itemToAdd = { ...item };
                                                delete itemToAdd.id;
                                                const addRequest = store.add(itemToAdd);
                                                addRequest.onsuccess = () => {
                                                    count++;
                                                    if (count === items.length) {
                                                        resolve();
                                                    }
                                                };
                                                addRequest.onerror = reject;
                                            });
                                        };
                                        clearRequest.onerror = reject;
                                    });
                                });

                                await Promise.all(promises);

                                transaction.oncomplete = () => {
                                    App.UI.showMessage('اطلاعات با موفقیت بازیابی شد. برنامه دوباره بارگیری می‌شود.', 'success');
                                    setTimeout(() => window.location.reload(), 2000);
                                };
                                transaction.onerror = (event) => {
                                    console.error("Restore transaction failed:", event.target.error);
                                    throw new Error('Transaction failed during restore.');
                                };
                                
                            } catch (error) {
                                console.error('Restore failed:', error);
                                App.UI.showMessage('خطا در بازیابی اطلاعات. ممکن است فایل پشتیبان معتبر نباشد.');
                            }
                        };
                        reader.readAsText(file);
                    }
                );
                // Clear the input value so the same file can be selected again
                event.target.value = null;
            }
        },

        DB: { // Manages the offline database (IndexedDB) for storing products
            db: null,
            currentPage: 1,
            itemsPerPage: 10,
            initDB: function() {
                if (!window.indexedDB) { 
                    const errorMsg = "مرورگر شما از حافظه آفلاین (IndexedDB) پشتیبانی نمی‌کند. امکان ذخیره اجناس و فاکتورها وجود ندارد.";
                    console.error(errorMsg);
                    App.UI.showMessage(errorMsg);
                    return;
                }
                // افزایش شماره نسخه برای حل خطای VersionError
                const request = window.indexedDB.open('SiminGoldDB', 6);

                request.onerror = (event) => {
                    const error = event.target.error;
                    console.error("خطا در باز کردن IndexedDB:", error);
                    let userMessage = `خطا در دسترسی به حافظه آفلاین (${error.name}). امکان ذخیره اجناس وجود ندارد.`;
                    userMessage += " لطفا از حالت ناشناس (Private) مرورگر خارج شده و دسترسی‌های لازم را به سایت بدهید.";
                    App.UI.showMessage(userMessage);
                };

                request.onblocked = (event) => {
                    // This event fires when the database is open in another tab.
                    console.warn("تلاش برای باز کردن IndexedDB مسدود شده است:", event);
                    App.UI.showMessage("لطفاً تمام تب‌های دیگر این برنامه را ببندید و صفحه را دوباره بارگیری کنید. پایگاه داده در حال استفاده است و امکان دسترسی وجود ندارد.");
                };

                request.onupgradeneeded = (event) => {
                    this.db = event.target.result;
                    console.log("در حال ساخت یا بروزرسانی آبجکت استور...");

                    let productStore;
                    if (!this.db.objectStoreNames.contains('products')) {
                        productStore = this.db.createObjectStore("products", { keyPath: "id", autoIncrement: true });
                        console.log("آبجکت استور 'products' با موفقیت ساخته شد.");
                    } else {
                        productStore = event.target.transaction.objectStore('products');
                    }

                    if (!productStore.indexNames.contains('name')) {
                        productStore.createIndex("name", "name", { unique: false });
                    }
                    if (!productStore.indexNames.contains('barcode')) {
                        productStore.createIndex("barcode", "barcode", { unique: true });
                    }

                    if (!this.db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = this.db.createObjectStore("invoices", { keyPath: "id", autoIncrement: true });
                        invoiceStore.createIndex("customerName", "customerName", { unique: false });
                        invoiceStore.createIndex("date", "date", { unique: false });
                        console.log("آبجکت استور 'invoices' با موفقیت ساخته شد.");
                    }

                    if (!this.db.objectStoreNames.contains('customers')) {
                        const customerStore = this.db.createObjectStore("customers", { keyPath: "id", autoIncrement: true });
                        customerStore.createIndex("name", "name", { unique: false });
                        customerStore.createIndex("phone", "phone", { unique: false });
                        console.log("آبجکت استور 'customers' با موفقیت ساخته شد.");
                    }
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;

                    // This event fires when the database in another tab needs to be updated
                    this.db.onversionchange = () => {
                        console.log("نسخه جدیدی از پایگاه داده در دسترس است. این اتصال بسته می‌شود.");
                        this.db.close();
                        App.UI.showMessage("یک نسخه جدید از برنامه در تب دیگری باز شده است. لطفاً این تب را ببندید.", "info");
                    };
                    
                    const savedItemsPerPage = localStorage.getItem('itemsPerPage');
                    if (savedItemsPerPage) {
                        this.itemsPerPage = parseInt(savedItemsPerPage, 10);
                        document.getElementById('itemsPerPage').value = this.itemsPerPage;
                    } else {
                        document.getElementById('itemsPerPage').value = this.itemsPerPage;
                    }

                    console.log("اتصال به IndexedDB با موفقیت برقرار شد.");
                    this.renderProducts();
                    // When the archive tab is active, render invoices
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === 'tab-column-archive') {
                        this.renderInvoices();
                    }
                };
            },

            saveProduct: function(product) {
                if (!this.db) {
                    App.UI.showMessage("اتصال به پایگاه داده برقرار نیست.");
                    return;
                }
                const transaction = this.db.transaction(["products"], "readwrite");
                const objectStore = transaction.objectStore("products");

                if (product.id) { // Update existing product
                    const request = objectStore.put(product);
                    request.onsuccess = () => this.renderProducts();
                    request.onerror = (event) => {
                        console.error("خطا در بروزرسانی جنس:", event.target.error);
                        App.UI.showMessage("خطا در بروزرسانی جنس.");
                    };
                } else { // Add new product
                    const addRequest = objectStore.add(product);
                    addRequest.onsuccess = (event) => {
                        const newId = event.target.result;
                        // Now get the new product, add barcode, and update it
                        const getRequest = objectStore.get(newId);
                        getRequest.onsuccess = (event) => {
                            const newProduct = event.target.result;
                            newProduct.barcode = String(newId).padStart(6, '0');
                            const updateRequest = objectStore.put(newProduct);
                            updateRequest.onsuccess = () => this.renderProducts();
                            updateRequest.onerror = (e) => console.error("خطا در بروزرسانی جنس با بارکد:", e.target.error);
                        };
                    };
                    addRequest.onerror = (event) => {
                        console.error("خطا در ذخیره جنس:", event.target.error);
                        App.UI.showMessage("خطا در ذخیره جنس.");
                    };
                }
            },
            
            getProduct: function(id, callback) {
                if (!this.db) return;
                const transaction = this.db.transaction(["products"], "readonly");
                const objectStore = transaction.objectStore("products");
                const request = objectStore.get(id);

                request.onsuccess = (event) => {
                    if(callback) callback(event.target.result);
                };
                 request.onerror = (event) => {
                    console.error(`خطا در گرفتن جنس با ID ${id}:`, event.target.error);
                };
            },
            
            deleteProduct: function(id) {
                if (!this.db) return;
                const transaction = this.db.transaction(["products"], "readwrite");
                const objectStore = transaction.objectStore("products");
                const request = objectStore.delete(id);

                request.onsuccess = () => {
                    App.UI.showMessage("جنس با موفقیت حذف شد.", 'success');
                    this.renderProducts();
                };
                
                request.onerror = (event) => {
                    console.error(`خطا در حذف جنس با ID ${id}:`, event.target.error);
                    App.UI.showMessage("خطا در حذف جنس.");
                };
            },

            renderProducts: function(filterQuery = null) {
                const productListDiv = document.getElementById('productList');
                if (!this.db) return;

                const transaction = this.db.transaction(["products"], "readonly");
                const objectStore = transaction.objectStore("products");
                const request = objectStore.getAll();

                request.onerror = (event) => {
                    console.error("خطا در خواندن اجناس:", event.target.error);
                    productListDiv.innerHTML = '<p class="col-span-full text-center text-red-500">خطا در بارگذاری اجناس.</p>';
                };

                request.onsuccess = (event) => {
                    let products = event.target.result;
                    if (filterQuery) {
                        products = products.filter(p => 
                            p.name.includes(filterQuery) || 
                            (p.barcode && p.barcode.includes(filterQuery))
                        );
                    }

                    if (products.length === 0) {
                        const message = filterQuery ? 'هیچ جنسی با این مشخصات یافت نشد.' : 'هیچ جنسی ذخیره نشده است.';
                        productListDiv.innerHTML = `<p class="text-center text-gray-500 py-8">${message}</p>`;
                        return;
                    }

                    const tableHeader = `
                        <thead class="bg-gray-100">
                            <tr class="border-b-2 border-gray-200 text-xs text-gray-600 uppercase tracking-wider">
                                <th class="px-4 py-3 text-right">بارکد</th>
                                <th class="px-4 py-3 text-right">نام کالا</th>
                                <th class="px-4 py-3 text-center">وزن</th>
                                <th class="px-4 py-3 text-center">عیار</th>
                                <th class="px-4 py-3 text-center">اجرت (%)</th>
                                <th class="px-4 py-3 text-center">عملیات</th>
                            </tr>
                        </thead>`;

                    const tableRows = products.map(product => `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-700 font-mono">${product.barcode || '---'}</td>
                            <td class="px-4 py-3 text-sm text-gray-700 font-semibold">${product.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-700 text-center">${product.weight}</td>
                            <td class="px-4 py-3 text-sm text-gray-700 text-center">${product.purity}</td>
                            <td class="px-4 py-3 text-sm text-gray-700 text-center">${product.wage}</td>
                            <td class="px-4 py-3 text-sm text-center whitespace-nowrap">
                                <div class="flex justify-center gap-2">
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors bg-blue-500 hover:bg-blue-600" data-id="${product.id}" data-action="edit">ویرایش</button>
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors bg-red-500 hover:bg-red-600" data-id="${product.id}" data-action="delete">حذف</button>
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors bg-green-500 hover:bg-green-600" data-id="${product.id}" data-action="use">استفاده</button>
                                </div>
                            </td>
                        </tr>
                    `).join('');

                    const tableHtml = `
                        <table class="min-w-full bg-white rounded-lg shadow-md border border-gray-200 text-sm">
                            ${tableHeader}
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    `;
                    productListDiv.innerHTML = tableHtml;
                };
            },
            
            searchProducts: function(query) {
                this.renderProducts(query.trim() || null);
            },
            exportToExcel: function() {
                if (!this.db) {
                    App.UI.showMessage("اتصال به پایگاه داده برقرار نیست.");
                    return;
                }
                const transaction = this.db.transaction(["products"], "readonly");
                const objectStore = transaction.objectStore("products");
                const request = objectStore.getAll();

                request.onsuccess = (event) => {
                    const products = event.target.result;
                    if (products.length === 0) {
                        App.UI.showMessage("هیچ جنسی برای خروجی گرفتن وجود ندارد.");
                        return;
                    }

                    const headers = ["ID", "نام کالا", "وزن", "عیار", "اجرت (%)"];
                    let csvContent = headers.join(",") + "\n"; 

                    products.forEach(product => {
                        // برای جلوگیری از خطا، نام محصولی که کاما دارد داخل کوتیشن قرار می‌گیرد
                        const productName = `"${product.name.replace(/"/g, '""')}"`;
                        const row = [product.id, productName, product.weight, product.purity, product.wage];
                        csvContent += row.join(",") + "\n";
                    });

                    // Create a Blob with UTF-8 BOM for Excel compatibility with Persian characters
                    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", "products-backup.csv");
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                };

                request.onerror = (event) => {
                    console.error("خطا در خواندن اطلاعات برای خروجی:", event.target.error);
                    App.UI.showMessage("خطا در تهیه خروجی اکسل.");
                };
            },
            importFromCSV: function(file) {
                if (!file) {
                    App.UI.showMessage("فایلی انتخاب نشده است.");
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    const csv = event.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    if (lines.length <= 1) {
                        App.UI.showMessage("فایل خالی است یا فرمت صحیحی ندارد.");
                        return;
                    }
                    
                    // Skip header, process rows
                    const productsToImport = lines.slice(1).map(line => {
                        // Simple CSV parsing; might not handle special cases like commas within quotes correctly
                        const values = line.split(',');
                        // ستون‌های مورد انتظار: شناسه، نام، وزن، عیار، اجرت
                        if (values.length < 5) return null;
                        
                        const product = {
                            name: values[1].replace(/"/g, ''), // Remove quotes
                            weight: parseFloat(values[2]),
                            purity: parseInt(values[3], 10),
                            wage: parseFloat(values[4])
                        };
                        
                        // Basic validation
                        if (isNaN(product.weight) || isNaN(product.purity) || isNaN(product.wage)) {
                            console.warn("Skipping invalid row:", line);
                            return null;
                        }
                        return product;
                    }).filter(p => p !== null);

                    if(productsToImport.length > 0) {
                        productsToImport.forEach(p => this.saveProduct(p));
                        App.UI.showMessage(`${productsToImport.length} جنس با موفقیت وارد شد.`, 'success');
                    } else {
                        App.UI.showMessage("هیچ جنس معتبری در فایل یافت نشد.");
                    }
                };
                reader.readAsText(file);
            },

            saveInvoice: function(invoiceData) {
                if (!this.db) {
                    App.UI.showMessage("اتصال به پایگاه داده برقرار نیست.");
                    return;
                }
                const transaction = this.db.transaction(["invoices"], "readwrite");
                const objectStore = transaction.objectStore("invoices");
                const request = objectStore.add(invoiceData);
                
                request.onsuccess = () => {
                    App.UI.showMessage("فاکتور با موفقیت در آرشیو ذخیره شد.", 'success');
                };
                
                request.onerror = (event) => {
                    console.error("خطا در ذخیره فاکتور:", event.target.error);
                    App.UI.showMessage("خطا در ذخیره فاکتور.");
                };

                transaction.oncomplete = () => {
                    // After successfully saving the invoice, update the customer's balance
                    if (invoiceData.customerId) this.updateCustomerBalance(invoiceData.customerId, invoiceData.payment.remaining);
                }
            },

            deleteInvoice: function(id) {
                if (!this.db) return;
                const transaction = this.db.transaction(["invoices"], "readwrite");
                const objectStore = transaction.objectStore("invoices");
                const request = objectStore.delete(id);

                request.onsuccess = () => {
                    App.UI.showMessage("فاکتور با موفقیت حذف شد.", 'success');
                    this.renderInvoices(); // Re-render the list
                };
                
                request.onerror = (event) => {
                    console.error(`خطا در حذف فاکتور با ID ${id}:`, event.target.error);
                    App.UI.showMessage("خطا در حذف فاکتور.");
                };
            },

            updateCustomerBalance: function(customerId, amount) {
                if (!this.db || !customerId) return;

                const transaction = this.db.transaction(["customers"], "readwrite");
                const store = transaction.objectStore("customers");
                const request = store.get(customerId);

                request.onsuccess = (event) => {
                    const customer = event.target.result;
                    if (customer) {
                        customer.balance = (customer.balance || 0) + amount;
                        const updateRequest = store.put(customer);
                        updateRequest.onerror = (e) => {
                            console.error("Error putting customer update:", e.target.error);
                        };
                    }
                };
                request.onerror = (event) => {
                    console.error("Error updating customer balance:", event.target.error);
                };
            },

            getNextCustomerCode: function() {
                let lastCode = parseInt(localStorage.getItem('lastCustomerCode') || '0', 10);
                lastCode++;
                localStorage.setItem('lastCustomerCode', lastCode);
                return String(lastCode).padStart(6, '0');
            },
            saveOrUpdateCustomer: function(customerData) {
                if (!this.db || !customerData.name.trim()) {
                    return; // Do not save if DB is not available or name is empty
                }
                const transaction = this.db.transaction(["customers"], "readwrite");
                const store = transaction.objectStore("customers");
                const phone = customerData.phone.trim();
                const name = customerData.name.trim();

                if (!name) return; // Do not save if name is empty

                // If phone is empty, search by name to avoid duplicates for customers with no phone
                if (phone === '') {
                    const nameIndex = store.index("name");
                    const nameRequest = nameIndex.getAll(name);
                    nameRequest.onsuccess = (event) => {
                        const customers = event.target.result;
                        const customerWithoutPhoneExists = customers.some(c => c.name === name && c.phone === '');
                        if (!customerWithoutPhoneExists) {
                            const newCustomer = { name: name, phone: '', customerCode: this.getNextCustomerCode() };
                            store.add(newCustomer);
                        } else {
                            // Customer without phone already exists, do nothing.
                        }
                    };
                    return;
                }

                // If phone exists, search by phone
                const phoneIndex = store.index("phone");
                const request = phoneIndex.get(phone);

                request.onsuccess = (event) => {
                    const existingCustomer = event.target.result;
                    if (existingCustomer) {
                        // Customer exists, update name if different
                        if (existingCustomer.name !== name) {
                            existingCustomer.name = name;
                            store.put(existingCustomer);
                        } else {
                            // If a customer with the same name and phone exists, we don't add a new one.
                            // This can happen if the user tries to add an existing customer.
                            // We can show a message or just silently ignore it. For now, we'll ignore.
                            console.log("Customer with this phone number already exists.");
                        }
                    } else {
                        // Customer does not exist, add new one
                        const newCustomer = { ...customerData, customerCode: this.getNextCustomerCode() };
                        store.add(newCustomer);
                    }
                };


                request.onerror = (event) => {
                    console.error("Error finding customer by phone:", event.target.error);
                };
            },

            deleteCustomer: function(customerId) {
                if (!this.db) return;
                const transaction = this.db.transaction(["customers"], "readwrite");
                const store = transaction.objectStore("customers");
                const request = store.delete(customerId);

                request.onsuccess = () => {
                    App.UI.showMessage('مشتری با موفقیت حذف شد.', 'success');
                    this.renderCustomers(); // Refresh the list
                };
                request.onerror = (event) => {
                    App.UI.showMessage('خطا در حذف مشتری.');
                    console.error("Delete customer error:", event.target.error);
                };
            },

            updateCustomer: function(customerId, newName, newPhone) {
                if (!this.db) return;
                const transaction = this.db.transaction(["customers"], "readwrite");
                const store = transaction.objectStore("customers");
                const request = store.get(customerId);

                request.onsuccess = (event) => {
                    const customer = event.target.result;
                    if (customer) {
                        customer.name = newName;
                        customer.phone = newPhone;
                        const updateRequest = store.put(customer);
                        updateRequest.onsuccess = () => {
                            App.UI.showMessage('اطلاعات مشتری با موفقیت بروزرسانی شد.', 'success');
                            this.renderCustomers(); // Refresh the list
                        };
                        updateRequest.onerror = (e) => {
                            App.UI.showMessage('خطا در بروزرسانی اطلاعات مشتری.');
                            console.error("Update customer error:", e.target.error);
                        };
                    }
                };
                request.onerror = (event) => {
                    console.error("Get customer for update error:", event.target.error);
                };
            },

            searchCustomersByName: function(query, callback) {
                if (!this.db || query.length < 2) {
                    callback([]);
                    return;
                }
                const transaction = this.db.transaction(["customers"], "readonly");
                const store = transaction.objectStore("customers");
                const request = store.getAll();

                request.onsuccess = (event) => {
                    const customers = event.target.result;
                    const filtered = customers.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));
                    callback(filtered);
                };
            },
            addCustomer: function(name, phone) {
                if (!this.db) return;
                if (!name.trim()) {
                    App.UI.showMessage('نام مشتری نمی‌تواند خالی باشد.');
                    return;
                }

                const transaction = this.db.transaction(["customers"], "readwrite");
                const store = transaction.objectStore("customers");
                const newCustomer = { 
                    name: name.trim(), 
                    phone: phone.trim(), 
                    customerCode: this.getNextCustomerCode(),
                    balance: 0
                };
                const request = store.add(newCustomer);

                request.onsuccess = () => {
                    this.renderCustomers(); // Refresh the list
                };
                request.onerror = (event) => {
                    console.error("Error searching customers:", event.target.error);
                    callback([]);
                };
            },
            renderCustomers: function(filterQuery = '', balanceFilter = 'all') {
                if (!this.db) return;
                const customerListDiv = document.getElementById('customer-list');
                const transaction = this.db.transaction(["customers", "invoices"], "readonly");
                const customerStore = transaction.objectStore("customers");
                const invoiceStore = transaction.objectStore("invoices");

                const customerRequest = customerStore.getAll();
                const invoiceRequest = invoiceStore.getAll();

                customerRequest.onerror = invoiceRequest.onerror = (event) => {
                    console.error("Error fetching customers:", event.target.error);
                    customerListDiv.innerHTML = '<p class="text-red-500 text-center">خطا در بارگذاری لیست مشتریان.</p>';
                };

                let allCustomers = [];
                let allInvoices = [];

                const render = () => {
                    // Wait for both fetches to complete
                    if (!allCustomers || !allInvoices) return; 
                    
                    let customersWithBalance = allCustomers.map(customer => {
                        // Find all invoices for the current customer
                        const customerInvoices = allInvoices.filter(inv => {
                            // Match by ID if available, otherwise by name and phone for older invoices
                            return inv.customerId === customer.id || (inv.customerName === customer.name && inv.customerPhone === customer.phone);
                        });
                        // Calculate the balance by summing up the remaining amounts from their invoices
                        const balance = customerInvoices.reduce((acc, inv) => acc + (inv.payment?.remaining || 0), 0);
                        return { ...customer, balance };
                    }).reverse();

                    if (filterQuery) {
                        const query = filterQuery.toLowerCase().trim();
                        customersWithBalance = customersWithBalance.filter(c => 
                            c.name.toLowerCase().includes(query) || (c.phone && c.phone.includes(query))
                        );
                    }

                    if (balanceFilter !== 'all') {
                        customersWithBalance = customersWithBalance.filter(c => {
                            const balance = c.balance || 0;
                            if (balanceFilter === 'debtor') return balance > 0;
                            if (balanceFilter === 'creditor') return balance < 0;
                            if (balanceFilter === 'zero') return balance === 0;
                        });
                    }
                    if (customersWithBalance.length === 0) {
                        customerListDiv.innerHTML = `<p class="text-center text-gray-500 py-8">هیچ مشتری یافت نشد.</p>`;
                        return;
                    }

                    const tableHeader = `
                        <thead class="bg-gray-100">
                            <tr class="border-b-2 border-gray-200 text-xs text-gray-600 uppercase tracking-wider">
                                <th class="px-4 py-3 text-right">کد مشتری</th>
                                <th class="px-4 py-3 text-right">نام مشتری</th>
                                <th class="px-4 py-3 text-right">شماره تماس</th>
                                <th class="px-4 py-3 text-right">مانده حساب (تومان)</th>
                                <th class="px-4 py-3 text-center">عملیات</th>
                            </tr>
                        </thead>`;

                    const tableRows = customersWithBalance.map(customer => `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-700 font-mono">${customer.customerCode || '---'}</td>
                            <td class="px-4 py-3 text-sm text-gray-700 font-semibold">${customer.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">${customer.phone || '---'}</td>
                            <td class="px-4 py-3 text-sm font-mono ${ (customer.balance || 0) > 0 ? 'text-red-600' : (customer.balance || 0) < 0 ? 'text-green-600' : 'text-gray-700'}">
                                ${App.Utils.formatNumber(Math.abs(customer.balance || 0))}
                                <span class="text-xs">${(customer.balance || 0) > 0 ? 'بدهکار' : (customer.balance || 0) < 0 ? 'بستانکار' : 'بی حساب'}</span>
                            </td>
                            <td class="px-4 py-3 text-sm text-center">
                                <div class="flex justify-center gap-2">
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors bg-blue-500 hover:bg-blue-600" data-id="${customer.id}" data-action="view-details">سوابق</button>
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors bg-yellow-500 hover:bg-yellow-600" data-id="${customer.id}" data-name="${customer.name}" data-phone="${customer.phone || ''}" data-action="edit-customer">ویرایش</button>
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors bg-red-500 hover:bg-red-600" data-id="${customer.id}" data-action="delete-customer">حذف</button>
                                </div>
                            </td>
                        </tr>
                    `).join('');

                    customerListDiv.innerHTML = `
                        <table class="min-w-full bg-white rounded-lg shadow-md border border-gray-200 text-sm">
                            ${tableHeader}
                            <tbody>${tableRows}</tbody>
                        </table>`;
                };

                customerRequest.onsuccess = (event) => {
                    allCustomers = event.target.result || [];
                    if (allInvoices !== null) render();
                };

                invoiceRequest.onsuccess = (event) => {
                    allInvoices = event.target.result || [];
                    if (allCustomers !== null) render();
                };
            },

            showCustomerDetails: function(customerId) {
                if (!this.db) return;
                const transaction = this.db.transaction(["customers", "invoices"], "readonly");
                const customerStore = transaction.objectStore("customers");
                const customerRequest = customerStore.get(customerId);

                customerRequest.onsuccess = (event) => {
                    const customer = event.target.result;
                    if (!customer) return;

                    document.getElementById('details-customer-name').textContent = customer.name;
                    document.getElementById('customer-details-view').classList.remove('hidden');

                    const invoiceStore = transaction.objectStore("invoices");
                    const invoiceRequest = invoiceStore.getAll();
                    
                    invoiceRequest.onsuccess = (event) => {
                        const allInvoices = event.target.result;
                        // Filter invoices for this customer by ID, or by name/phone for older invoices
                        const customerInvoices = allInvoices.filter(inv => 
                            inv.customerId === customerId || 
                            (inv.customerName === customer.name && inv.customerPhone === customer.phone)
                        ).reverse();

                        // Recalculate total balance from all invoices
                        const totalBalance = customerInvoices.reduce((acc, inv) => acc + (inv.payment.remaining || 0), 0);

                        document.getElementById('customer-list-view').classList.add('hidden');
                        const balanceEl = document.getElementById('details-customer-balance');
                        
                        balanceEl.textContent = `${App.Utils.formatNumber(Math.round(Math.abs(totalBalance)))} تومان (${totalBalance > 0 ? 'بدهکار' : totalBalance < 0 ? 'بستانکار' : 'بی حساب'})`;
                        balanceEl.className = 'font-bold ';
                        if (totalBalance > 0) balanceEl.classList.add('text-red-600');
                        else if (totalBalance < 0) balanceEl.classList.add('text-green-600');
                        else balanceEl.classList.add('text-gray-800');



                        const invoiceListDiv = document.getElementById('customer-invoice-list');
                        if (customerInvoices.length === 0) {
                            invoiceListDiv.innerHTML = '<p class="text-center text-gray-500 py-8">هیچ فاکتوری برای این مشتری ثبت نشده است.</p>';
                            return;
                        }

                        const tableHeader = `
                            <thead class="bg-gray-100">
                                <tr class="border-b-2 border-gray-200 text-xs text-gray-600 uppercase tracking-wider">
                                    <th class="px-4 py-3 text-right">شماره فاکتور</th>
                                    <th class="px-4 py-3 text-right">تاریخ</th>
                                    <th class="px-4 py-3 text-right">مبلغ نهایی</th>
                                    <th class="px-4 py-3 text-right">وضعیت حساب</th>
                                    <th class="px-4 py-3 text-center">عملیات</th>
                                </tr>
                            </thead>`;

                        const tableRows = customerInvoices.map(invoice => `
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-700">${invoice.invoiceNumber}</td>
                                <td class="px-4 py-3 text-sm text-gray-700 ltr">${invoice.date}</td>
                                <td class="px-4 py-3 text-sm text-gray-700 font-semibold">${App.Utils.formatNumber(Math.round(invoice.totals.finalAmount))} تومان</td>
                                <td class="px-4 py-3 text-sm font-semibold ${
                                    invoice.payment.remaining > 0 ? 'text-red-600' :
                                    invoice.payment.remaining < 0 ? 'text-green-600' :
                                    'text-gray-500'
                                }">
                                    ${App.Utils.formatNumber(Math.round(Math.abs(invoice.payment.remaining)))} تومان ${ invoice.payment.remaining > 0 ? 'بدهکار' : invoice.payment.remaining < 0 ? 'بستانکار' : 'تسویه'}
                                </td>
                                <td class="px-4 py-3 text-sm text-center">
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors bg-blue-500 hover:bg-blue-600" data-id="${invoice.id}" data-action="reprint-from-customer">چاپ مجدد</button>
                                </td>
                            </tr>
                        `).join('');

                        invoiceListDiv.innerHTML = `
                            <table class="min-w-full bg-white rounded-lg shadow-md border border-gray-200 text-sm">
                                ${tableHeader}
                                <tbody>${tableRows}</tbody>
                            </table>`;
                    };
                };
            },

            renderInvoices: function(filters = {}, page = 1) {
                if (!this.db) return;
                this.currentPage = page;
                const invoiceListDiv = document.getElementById('invoice-archive-list');

                const transaction = this.db.transaction(["invoices"], "readonly");
                const objectStore = transaction.objectStore("invoices");
                const request = objectStore.getAll();

                request.onerror = (event) => {
                    console.error("خطا در خواندن فاکتورها:", event.target.error);
                    invoiceListDiv.innerHTML = '<p class="text-red-500 text-center">خطا در بارگذاری فاکتورها.</p>';
                };

                request.onsuccess = (event) => {
                    let allInvoices = event.target.result.reverse(); // Show newest first
                    
                    let filteredInvoices = allInvoices;
                    let isFiltered = false;
                    if (filters.invoiceNumber && filters.invoiceNumber.trim() !== '') {
                        filteredInvoices = filteredInvoices.filter(inv => String(inv.invoiceNumber || '').includes(filters.invoiceNumber));
                        isFiltered = true;
                    }
                    if (filters.customerName && filters.customerName.trim() !== '') {
                        filteredInvoices = filteredInvoices.filter(inv => (inv.customerName || '').includes(filters.customerName));
                        isFiltered = true;
                    }
                    if (filters.date && filters.date.trim() !== '') {
                        filteredInvoices = filteredInvoices.filter(inv => inv.date.includes(filters.date));
                        isFiltered = true;
                    }
                    // Note: Customer balance filter is handled in renderCustomers, not here.
                    // This is just to ensure the function call is correct.
                    if (filters.balanceStatus && filters.balanceStatus !== 'all') {
                        // This logic is now in renderCustomers
                    }

                    const totalItems = filteredInvoices.length;
                    const totalPages = Math.ceil(totalItems / this.itemsPerPage);
                    
                    if (this.currentPage > totalPages && totalPages > 0) {
                        this.currentPage = totalPages;
                    }
                    if (this.currentPage < 1) {
                        this.currentPage = 1;
                    }

                    const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                    const endIndex = startIndex + this.itemsPerPage;
                    const paginatedInvoices = filteredInvoices.slice(startIndex, endIndex);

                    if (paginatedInvoices.length === 0) {
                        const message = isFiltered 
                            ? 'هیچ فاکتوری با این مشخصات یافت نشد.' 
                            : 'هیچ فاکتوری ذخیره نشده است.';
                        invoiceListDiv.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">${message}</p>`;
                        this.renderPaginationControls(0, 0);
                        return;
                    }

                    const tableHeader = `
                        <thead class="bg-gray-100">
                            <tr class="border-b-2 border-gray-200 text-xs text-gray-600 uppercase tracking-wider">
                                <th class="px-4 py-3 text-right">شماره</th>
                                <th class="px-4 py-3 text-right">نام مشتری</th>
                                <th class="px-4 py-3 text-right">تاریخ</th>
                                <th class="px-4 py-3 text-right">مبلغ نهایی</th>
                                    <th class="px-4 py-3 text-right">مبلغ بدهکاری/بستانکاری</th>
                                <th class="px-4 py-3 text-center">عملیات</th>
                            </tr>
                        </thead>
                    `;

                    const tableRows = paginatedInvoices.map(invoice => {
                        return `
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${invoice.invoiceNumber || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm text-gray-700 font-semibold text-gold-dark whitespace-nowrap">${invoice.customerName || 'بدون نام'}</td>
                                <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${invoice.date}</td>
                                <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${App.Utils.formatNumber(Math.round(invoice.totals.finalAmount))} تومان</td>
                                <td class="px-4 py-3 text-sm font-semibold ${
                                    invoice.payment.remaining > 0 ? 'text-red-600' :
                                    invoice.payment.remaining < 0 ? 'text-green-600' :
                                    'text-gray-500'
                                }">
                                    ${App.Utils.formatNumber(Math.round(Math.abs(invoice.payment.remaining)))} تومان ${ invoice.payment.remaining > 0 ? 'بدهکار' : invoice.payment.remaining < 0 ? 'بستانکار' : 'تسویه'}
                                </td>
                                <td class="px-4 py-3 text-sm text-center whitespace-nowrap">
                                    <div class="flex justify-center gap-2">
                                        <button class="px-3 py-1 text-xs rounded-md text-white transition-colors bg-blue-500 hover:bg-blue-600" data-id="${invoice.id}" data-action="reprint">چاپ</button>
                                        <button class="px-3 py-1 text-xs rounded-md text-white transition-colors bg-red-500 hover:bg-red-600" data-id="${invoice.id}" data-action="delete-invoice">حذف</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    const tableHtml = `
                        <table class="min-w-full bg-white rounded-lg shadow-md border border-gray-200 text-sm">
                            ${tableHeader}
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    `;
                    
                    invoiceListDiv.innerHTML = tableHtml;
                    this.renderPaginationControls(totalPages, this.currentPage);
                };
            },

            renderPaginationControls: function(totalPages, currentPage) {
                const paginationControlsDiv = document.getElementById('pagination-controls');
                if (totalPages <= 1) {
                    paginationControlsDiv.innerHTML = '';
                    return;
                }

                const prevDisabled = currentPage === 1 ? 'disabled' : '';
                const nextDisabled = currentPage === totalPages ? 'disabled' : '';

                paginationControlsDiv.innerHTML = `
                    <button data-page="${currentPage - 1}" ${prevDisabled} class="px-4 py-2 text-sm rounded-md text-white transition-colors bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed">قبلی</button>
                    <span class="text-sm font-semibold text-gray-700">صفحه ${currentPage} از ${totalPages}</span>
                    <button data-page="${currentPage + 1}" ${nextDisabled} class="px-4 py-2 text-sm rounded-md text-white transition-colors bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed">بعدی</button>
                `;
            },
        },

        Utils: { // A collection of general-purpose utility functions
            formatNumber: (number) => new Intl.NumberFormat('en-US').format(number),
            unformatNumber: (string) => parseFloat(String(string).replace(/,/g, '')) || 0,
            formatNumberInput: function(input) {
                let value = input.value.replace(/,/g, '');
                if (!isNaN(value) && value.trim() !== '') {
                    input.value = this.formatNumber(value);
                }
            },
            getInputValue: function(id, defaultValue = 0) {
                const element = document.getElementById(id);
                if (!element) return defaultValue;
                if (element.tagName === 'SELECT') return element.value || defaultValue;
                const value = element.type.startsWith('text') ? this.unformatNumber(element.value) : parseFloat(element.value);
                return isNaN(value) ? defaultValue : value;
            },
            setInputValueAndLocalStorage: function(id, value) {
                const element = document.getElementById(id);
                if (!element) return;
                if (element.type.startsWith('text') && (id.includes('price_gram') || id.includes('price_whole') || id.includes('price_mesghal') || id.includes('buy_deduction') || id.includes('coin_price'))) {
                    element.value = this.formatNumber(value);
                } else {
                    element.value = value;
                }
                localStorage.setItem(id, value);
            },
            loadValuesFromLocalStorage: function() {
                const inputs = [
                    'price_whole1', 'wage1', 'profit1', 'VAT1', 'price_gram1', 'goldPurity1',
                    'weight2', 'wage2', 'profit2', 'VAT2', 'price_gram2', 'goldPurity2',
                    'weight_input3', 'price_gram3', 'goldPurity3',
                    'price_gram6', 'weight_gram6', 'goldPurity6', 'profit_melted', 'buy_deduction6', 'VAT6',
                    'customerName', 'customerPhone', 'invoiceProfit', 'invoiceVAT'
                ];
                inputs.forEach(id => {
                    const savedValue = localStorage.getItem(id);
                    if (savedValue !== null) {
                        const element = document.getElementById(id);
                        if (element) {
                            if (element.type.startsWith('text') && (id.includes('price_gram') || id.includes('price_whole') || id.includes('price_mesghal') || id.includes('buy_deduction'))) {
                                element.value = this.formatNumber(parseFloat(savedValue));
                            } else {
                                element.value = savedValue;
                            }
                        }
                    }
                });
                // Restore radio button state for melted gold calculator
                const savedTransactionType = localStorage.getItem('transaction_type6');
                if (savedTransactionType) {
                    const radioBtn = document.querySelector(`input[name="transaction_type6"][value="${savedTransactionType}"]`);
                    if (radioBtn) radioBtn.checked = true;
                }
            },
            generateUniqueId: () => 'item_' + Date.now() + Math.floor(Math.random() * 1000)
        },

        UI: { // Manages the user interface, including tabs, price fetching, and messages
            showMessage: function(message, type = 'error') {
                const msgBox = document.getElementById('messageBox');
                let bgColor = type === 'success' ? '#2f855a' : (type === 'info' ? '#2b6cb0' : '#c53030'); // green, blue, or red
                msgBox.style.backgroundColor = bgColor;
                msgBox.innerHTML = `<p>${message}</p><button class="mt-4 px-4 py-2 bg-black bg-opacity-20 rounded hover:bg-opacity-30 transition-colors">بستن</button>`;
                msgBox.classList.remove('hidden');
                msgBox.querySelector('button').onclick = () => msgBox.classList.add('hidden');
                
                // Auto-hide after 5 seconds for success/info messages
                if(type !== 'error') {
                    setTimeout(() => {
                        if (!msgBox.classList.contains('hidden')) {
                            msgBox.classList.add('hidden');
                        }
                    }, 5000);
                }
            },
            
            showConfirmation: function(message, onConfirm) {
                const msgBox = document.getElementById('messageBox');
                msgBox.style.backgroundColor = '#4a5568'; // gray-700
                msgBox.innerHTML = `
                    <p>${message}</p>
                    <div class="flex justify-center gap-4 mt-4">
                        <button id="confirmBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors">بله، تایید می‌کنم</button>
                        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors">لغو</button>
                    </div>
                `;
                msgBox.classList.remove('hidden');
                document.getElementById('confirmBtn').onclick = () => {
                    onConfirm();
                    msgBox.classList.add('hidden');
                };
                document.getElementById('cancelBtn').onclick = () => {
                    msgBox.classList.add('hidden');
                };
            },

            showTab: function(tabId) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                const content = document.getElementById(tabId);
                const buttonId = tabId.replace('tab-column-', 'btn-tab-').replace('tab-column', 'btn-tab');
                const button = document.getElementById(buttonId);
                
                if (content) content.classList.add('active');
                if (button) button.classList.add('active');

                if (tabId === 'tab-column4') {
                    App.Invoice.setCurrentInvoiceDate();
                    App.Invoice.updateAllItemPrices();
                }
            },

            fetchLivePrices: async function() {
                const CF_WORKER_URL = 'https://gold.sprome.workers.dev/latest';
                let data = null;
                let fetchedFrom = "";

                try {
                    const response = await fetch(CF_WORKER_URL, { signal: AbortSignal.timeout(10000) });
                    if (!response.ok) throw new Error('Network response was not ok.');
                    data = await response.json();
                    fetchedFrom = "";
                } catch (error) {
                    console.error("Could not fetch prices from primary source:", error);
                    App.UI.showMessage("خطا در دریافت قیمت‌های لحظه‌ای.");
                    return;
                }

                if (!data) return;
                
                App.liveGoldPrice18k = data.gold_18k_toman > 0 ? data.gold_18k_toman : 0;
                App.liveMesghalPrice = data.gold_mesghal_toman > 0 ? data.gold_mesghal_toman : 0;
                App.livePrices = {
                    sekke_jadid: data.sekke_jadid_toman,
                    sekke_nim: data.sekke_nim_toman,
                    sekke_rob: data.sekke_rob_toman
                };
                
                this.updateNavbarPrices(data, fetchedFrom);
                this.updateCalculatorPrices();
                
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id.startsWith('tab-column')) {
                    const calcId = activeTab.id.replace('tab-column', 'column');
                     if(App.Calculators[`calculate${calcId}`]) {
                         App.Calculators[`calculate${calcId}`]();
                     }
                }
            },
            
            updateNavbarPrices: function(data, source) {
                const U = App.Utils;
                const updateDisplay = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value !== undefined && !isNaN(value) ? U.formatNumber(Math.round(value)) : '--';
                };
                
                updateDisplay('display-dollar-price', data.dollar_toman/10);
                updateDisplay('display-gold18k-price', data.gold_18k_toman);
                updateDisplay('display-ounce-price', data.gold_ounce_dollar);
                updateDisplay('display-mesghal-price', data.gold_mesghal_toman);
                updateDisplay('display-gold18k-ounce-price', data.gold_ounce_dollar*0.75*(data.dollar_toman/10)/31.1035);
                updateDisplay('display-sekke-jadid-price', data.sekke_jadid_toman);
                updateDisplay('display-sekke-nim-price', data.sekke_nim_toman);
                updateDisplay('display-sekke-rob-price', data.sekke_rob_toman);

                const updatedEl = document.getElementById('display-last-updated');
                if (updatedEl && data.timestamp) {
                    const date = new Date(data.timestamp);
                    const formattedTime = new Intl.DateTimeFormat('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Tehran', numberingSystem: 'arab' }).format(date);
                    updatedEl.textContent = ` ${formattedTime} ${source}`;
                }
            },

            updateCalculatorPrices: function() {
                if (App.liveGoldPrice18k > 0) {
                    ['1', '2', '3', '6'].forEach(i => {
                        const priceInputId = `price_gram${i}`;
                        if (!App.userModifiedPrices[priceInputId]) {
                            const element = document.getElementById(priceInputId);
                            if (element) {
                                element.value = App.Utils.formatNumber(App.liveGoldPrice18k);
                            }
                        }
                    });
                }
                App.Calculators.updateCoinPrice(); // به‌روزرسانی قیمت در ماشین‌حساب سکه
                App.Invoice.updateAllItemPrices(); 
            }
        },

        Calculators: { // Contains the logic for all calculators
             recalculate: function(id) {
                 const calcId = id || document.querySelector('.tab-content.active').id.replace('tab-column', 'column');
                 if(this[`calculate${calcId}`]) this[`calculate${calcId}`]();
              },
             calculatecolumn1: function() {
                const U = App.Utils;
                const profit = U.getInputValue('profit1');
                const wage = U.getInputValue('wage1');
                const VAT_rate = U.getInputValue('VAT1');
                const price_gram_18k_input = U.getInputValue('price_gram1');
                const price_whole = U.getInputValue('price_whole1');
                const purity = U.getInputValue('goldPurity1');

                const adjusted_price_gram = price_gram_18k_input * (purity / 750);

                const labor_cost_factor = wage / 100;
                const profit_markup_factor = profit / 100;
                const tax_factor = VAT_rate / 100;
                
                const total_factor = (1 + labor_cost_factor) * (1 + profit_markup_factor);
                const tax_base = (labor_cost_factor + (1 + labor_cost_factor) * profit_markup_factor);
                const final_factor = total_factor + (tax_base * tax_factor);
                
                const calculated_weight = price_whole / (adjusted_price_gram * final_factor);
                const rounded_weight = parseFloat(calculated_weight.toFixed(2));
                
                const price_before_tax = rounded_weight * adjusted_price_gram * total_factor;
                const tax_amount = (rounded_weight * adjusted_price_gram * tax_base) * tax_factor;

                document.getElementById('display-weight1').textContent = U.formatNumber(rounded_weight);
                document.getElementById('display-tax1').textContent = U.formatNumber(Math.round(tax_amount));
                document.getElementById('display-price-before-tax1').textContent = U.formatNumber(Math.round(price_before_tax));
                
                if (rounded_weight > 0) {
                    document.getElementById('invoiceFromCalc1').classList.remove('hidden');
                }
             },
             calculatecolumn2: function() {
                const U = App.Utils;
                const weight = U.getInputValue('weight2');
                const price_gram_18k = U.getInputValue('price_gram2');
                const wage = U.getInputValue('wage2');
                const profit = U.getInputValue('profit2');
                const VAT_rate = U.getInputValue('VAT2');
                const purity = U.getInputValue('goldPurity2');
                const adjusted_weight_to_750 = weight * (purity / 750);
                const adjusted_price_gram = price_gram_18k * (purity / 750);
                
                const price_of_gold = weight * adjusted_price_gram;
                const labor_cost = price_of_gold * (wage / 100);
                const profit_amount = (price_of_gold + labor_cost) * (profit / 100);
                const tax_base = labor_cost + profit_amount;
                const tax_amount = tax_base * (VAT_rate / 100);
                
                const price_before_tax = price_of_gold + tax_base;
                const final_price = price_before_tax + tax_amount;
                const final_price_per_gram = final_price / weight;
                
                document.getElementById('display-price-after-tax2').textContent = U.formatNumber(Math.round(final_price));
                document.getElementById('display-adjusted_wheight_to_750').textContent = U.formatNumber((adjusted_weight_to_750));
                document.getElementById('display-tax2').textContent = U.formatNumber(Math.round(tax_amount));
                document.getElementById('display-weight2').textContent = U.formatNumber(Math.round(price_before_tax));
                document.getElementById('display-gram-price-after-tax2').textContent = isFinite(final_price_per_gram) ? U.formatNumber(Math.round(final_price_per_gram)) : '0';

                if (weight > 0) {
                    document.getElementById('invoiceFromCalc2').classList.remove('hidden');
                }
             },
             calculatecolumn3: function() {
                const U = App.Utils;
                const weight = U.getInputValue('weight_input3');
                const price_gram_18k = U.getInputValue('price_gram3');
                const purity = U.getInputValue('goldPurity3');

                const oldGoldDeduction = U.getInputValue('settingOldGoldDeduction', 15);
                const adjusted_price_gram = price_gram_18k * (purity / 750) * ((750 - oldGoldDeduction) / 750);
                
                const final_price = weight * adjusted_price_gram;
                document.getElementById('display-total-price3').textContent = U.formatNumber(Math.round(final_price));
                
                if (weight > 0) {
                    document.getElementById('invoiceFromCalc3').classList.remove('hidden');
                }
             },
            calculatecolumn6: function() {
                const U = App.Utils;
                const weight_in_grams = U.getInputValue('weight_gram6');
                const price_input = U.getInputValue('price_gram6'); 
                const actual_purity = U.getInputValue('goldPurity6', 750);
                const transactionType = document.querySelector('input[name="transaction_type6"]:checked').value;

                const resultDisplay = document.getElementById('display-total-price6');
                const adjustedWeightDisplay = document.getElementById('display-adjusted-weight-750-6');
                const taxDisplay = document.getElementById('display-tax-6');
                const invoiceBtn = document.getElementById('invoiceFromCalc6');

                if (price_input <= 0 || weight_in_grams <= 0 || actual_purity <= 0) {
                    resultDisplay.textContent = '0';
                    adjustedWeightDisplay.textContent = '0';
                    taxDisplay.textContent = '0';
                    invoiceBtn.classList.add('hidden');
                    return;
                }

                const adjusted_weight_to_750 = weight_in_grams * (actual_purity / 750);
                adjustedWeightDisplay.textContent = U.formatNumber(adjusted_weight_to_750.toFixed(3));

                let final_price = 0;
                let tax_amount = 0;

                if (transactionType === 'sell') {
                    const profit_for_melted = U.getInputValue('profit_melted');
                    const VAT_rate = U.getInputValue('VAT6');
                    const price_of_gold = weight_in_grams * (price_input * (actual_purity / 750));
                    const profit_amount = price_of_gold * (profit_for_melted / 100);
                    tax_amount = profit_amount * (VAT_rate / 100);
                    final_price = price_of_gold + profit_amount + tax_amount;
                } else { // 'buy'
                    const buy_deduction_toman = U.getInputValue('buy_deduction6');
                    const effective_price_per_gram_18k = price_input - (buy_deduction_toman / 4.3318);
                    const final_adjusted_price_per_gram = effective_price_per_gram_18k * (actual_purity / 750);
                    final_price = weight_in_grams * final_adjusted_price_per_gram;
                    tax_amount = 0;
                }
                
                resultDisplay.textContent = U.formatNumber(Math.round(final_price));
                taxDisplay.textContent = U.formatNumber(Math.round(tax_amount));
                
                if (final_price > 0) {
                    invoiceBtn.classList.remove('hidden');
                } else {
                    invoiceBtn.classList.add('hidden');
                }
            },
            updateCoinPrice: function() {
                const U = App.Utils;
                const coinType = U.getInputValue('coin_type7');
                const coinPriceInput = document.getElementById('coin_price7');
                const parsianWeightContainer = document.getElementById('parsian_weight_container7');

                parsianWeightContainer.classList.toggle('hidden', coinType !== 'parsian');

                if (coinType === 'parsian') {
                    // For Parsian, price is based on 18k gold rate, so we clear the manual price input
                    coinPriceInput.value = U.formatNumber(App.liveGoldPrice18k);
                    coinPriceInput.previousElementSibling.textContent = 'نرخ گرم طلا (تومان):';
                } else {
                    coinPriceInput.previousElementSibling.textContent = 'قیمت واحد (تومان):';
                    if (App.livePrices[coinType]) {
                        coinPriceInput.value = U.formatNumber(App.livePrices[coinType]);
                    } else {
                        coinPriceInput.value = '0'; // For types not in live data like gerami/ghadim
                    }
                }
                this.calculatecolumn7();
            },
            calculatecolumn7: function() {
                const U = App.Utils;
                const coinType = U.getInputValue('coin_type7');
                const quantity = U.getInputValue('coin_quantity7');
                const price = U.getInputValue('coin_price7');

                let total_price = 0;

                if (coinType === 'parsian') {
                    const weight = U.getInputValue('parsian_weight7');
                    const goldRate = price; // For parsian, the price input holds the gold rate
                    total_price = weight * goldRate * quantity;
                } else {
                    total_price = quantity * price;
                }

                document.getElementById('display-total-price7').textContent = U.formatNumber(Math.round(total_price));
                
                const invoiceBtn = document.getElementById('invoiceFromCalc7');
                if (total_price > 0) {
                    invoiceBtn.classList.remove('hidden');
                } else {
                    invoiceBtn.classList.add('hidden');
                }
            }
        },

        Invoice: { // Manages the entire invoice creation process
            currentInvoiceData: null,
            recalculate: function() { this.updateTotal(); },
            getNextInvoiceNumber: function() {
                return (parseInt(localStorage.getItem('lastInvoiceNumber') || '0', 10) + 1);
            },
            setLastInvoiceNumber: function(number) {
                localStorage.setItem('lastInvoiceNumber', number);
            },
            setCurrentInvoiceDate: function() {
                const el = document.getElementById('invoiceDate');
                if (el && !el.value) {
                    const now = new Date();
                    const persianDate = new Intl.DateTimeFormat('fa-IR-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit', calendar: 'persian' }).format(now);
                    el.value = persianDate;
                }
            },
            updateAllItemPrices: function() {
                document.querySelectorAll('.gold-item-row').forEach(row => {
                    const itemId = row.dataset.itemId;
                    const priceInputId = `itemGramPrice_${itemId}`;
                    if (!App.userModifiedPrices[priceInputId] && App.liveGoldPrice18k > 0) {
                        document.getElementById(priceInputId).value = App.Utils.formatNumber(App.liveGoldPrice18k);
                    }
                });
                this.updateTotal();
            },
            
            addGoldItemRow: function(itemData = {}) {
                const container = document.getElementById('goldItemsContainer');
                const newId = App.Utils.generateUniqueId();
                const newItem = document.createElement('div'); 
                newItem.className = 'gold-item-row border-b pb-4 mb-4 pt-4'; // Add a class for easy selection
                newItem.dataset.itemId = newId;
                newItem.dataset.itemType = itemData.itemType || 'manual'; 

                newItem.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
                        <div class="responsive-input-group flex flex-col col-span-2">
                            <label for="itemDescription_${newId}" class="text-xs font-semibold text-dark-text mb-1">توضیحات:</label>
                            <input type="text" id="itemDescription_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-right text-sm">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemWeight_${newId}" class="text-xs font-semibold text-dark-text mb-1">وزن:</label>
                            <input type="number" id="itemWeight_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" value="1" min="0" step="0.01">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemPurity_${newId}" class="text-xs font-semibold text-dark-text mb-1">عیار:</label>
                            <input type="number" list="purity-list" id="itemPurity_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" value="750" step="any">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemGramPrice_${newId}" class="text-xs font-semibold text-dark-text mb-1">فی گرم (۱۸):</label>
                            <input type="text" id="itemGramPrice_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" oninput="App.Utils.formatNumberInput(this)">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemWage_${newId}" class="text-xs font-semibold text-dark-text mb-1">اجرت (%):</label>
                            <input type="number" id="itemWage_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" min="0" step="1">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemProfit_${newId}" class="text-xs font-semibold text-dark-text mb-1">سود (%):</label>
                            <input type="number" id="itemProfit_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" min="0" step="1">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemVAT_${newId}" class="text-xs font-semibold text-dark-text mb-1">مالیات (%):</label>
                            <input type="number" id="itemVAT_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" min="0" step="1">
                        </div>
                         <div class="responsive-input-group flex flex-col hidden" id="itemDeductionContainer_${newId}">
                            <label for="itemBuyDeduction_${newId}" class="text-xs font-semibold text-dark-text mb-1">کسری خرید:</label>
                            <input type="text" id="itemBuyDeduction_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" oninput="App.Utils.formatNumberInput(this)">
                        </div>
                    </div>
                    <button class="remove-item-btn mt-3 px-3 py-1 bg-red-500 text-white rounded-md text-xs hover:bg-red-600 transition-colors" data-item-id="${newId}"><i class="fas fa-trash-alt mr-1"></i>حذف آیتم</button>
                `;
                container.appendChild(newItem);

                const defaultProfit = App.Utils.getInputValue('invoiceProfit', 7);
                const defaultVAT = App.Utils.getInputValue('invoiceVAT', 10);

                document.getElementById(`itemDescription_${newId}`).value = itemData.description || itemData.name || '';
                document.getElementById(`itemWeight_${newId}`).value = itemData.weight || 1;
                document.getElementById(`itemPurity_${newId}`).value = itemData.purity || 750;

                const wageInput = document.getElementById(`itemWage_${newId}`);
                const profitInput = document.getElementById(`itemProfit_${newId}`);
                const vatInput = document.getElementById(`itemVAT_${newId}`);
                const deductionContainer = document.getElementById(`itemDeductionContainer_${newId}`);
                const deductionInput = document.getElementById(`itemBuyDeduction_${newId}`);

                const allInputs = [wageInput, profitInput, vatInput, deductionInput];
                allInputs.forEach(input => {
                    input.disabled = false;
                    input.style.backgroundColor = '';
                    input.parentElement.classList.add('hidden');
                });
                
                if (itemData.itemType === 'old-gold' || itemData.itemType === 'melted-buy' || (itemData.itemType && itemData.itemType.startsWith('coin'))) {
                    wageInput.value = 0;
                    profitInput.value = 0;
                    vatInput.value = 0;
                    [wageInput, profitInput, vatInput].forEach(input => {
                        input.disabled = true;
                        input.style.backgroundColor = '#e9ecef';
                    });
                     if(itemData.itemType === 'melted-buy') {
                        deductionContainer.classList.remove('hidden');
                        deductionInput.value = App.Utils.formatNumber(itemData.buyDeduction || 100000);
                     }
                } else {
                    wageInput.parentElement.classList.remove('hidden');
                    profitInput.parentElement.classList.remove('hidden');
                    vatInput.parentElement.classList.remove('hidden');
                    wageInput.value = itemData.wage !== undefined ? itemData.wage : 20;
                    profitInput.value = itemData.profit !== undefined ? itemData.profit : defaultProfit;
                    vatInput.value = itemData.vat !== undefined ? itemData.vat : defaultVAT;
                }
                
                const priceInput = document.getElementById(`itemGramPrice_${newId}`);
                let gramPriceToSet = itemData.gramPrice;

                if (gramPriceToSet) {
                    App.userModifiedPrices[priceInput.id] = true;
                    priceInput.value = App.Utils.formatNumber(gramPriceToSet);
                } else if (App.liveGoldPrice18k > 0) {
                    priceInput.value = App.Utils.formatNumber(App.liveGoldPrice18k);
                }

                this.updateTotal();
            },
            removeGoldItemRow: function(button) {
                const itemRow = button.closest('.gold-item-row');
                if (itemRow) {
                    const itemId = itemRow.dataset.itemId;
                    delete App.userModifiedPrices[`itemGramPrice_${itemId}`];
                    itemRow.remove();
                    if (document.getElementById('goldItemsContainer').children.length === 0) {
                        this.addGoldItemRow();
                    }
                    this.updateTotal();
                }
            },
            
            calculateItemFinalPrice: function(row) {
                const U = App.Utils;
                const itemId = row.dataset.itemId;
                const itemType = row.dataset.itemType || 'manual';

                const description = document.getElementById(`itemDescription_${itemId}`).value.toLowerCase();
                // Determine transaction type based on itemType, not description
                const transactionType = (itemType === 'old-gold' || itemType === 'melted-buy' || itemType.startsWith('coin-buy')) ? 'buy' : 'sell';

                const purity = U.getInputValue(`itemPurity_${itemId}`); // Corrected from itemPurity_
                const weight = U.getInputValue(`itemWeight_${itemId}`);
                const gramPrice = U.getInputValue(`itemGramPrice_${itemId}`);

                if (weight <= 0 && !itemType.startsWith('coin')) return { finalPrice: 0, profitAmount: 0, taxAmount: 0 };

                let finalPrice = 0;
                let profitAmount = 0;
                let taxAmount = 0; 

                if (itemType.startsWith('coin')) return { finalPrice: weight, profitAmount: 0, taxAmount: 0, transactionType: transactionType }; // برای سکه، قیمت کل در فیلد وزن ذخیره می‌شود تا محاسبات فاکتور ساده‌تر شود
                
                if (itemType === 'old-gold') {
                    const adjustedGramPrice = gramPrice * (purity / 750) * (735 / 750);
                    finalPrice = weight * adjustedGramPrice;
                } else if (itemType === 'melted-buy') {
                    const buyDeduction = U.getInputValue(`itemBuyDeduction_${itemId}`);
                    const effectiveGramPrice18k = gramPrice - (buyDeduction / 4.3318);
                    const adjustedPrice = effectiveGramPrice18k * (purity / 750);
                    finalPrice = weight * adjustedPrice;
                } else { 
                    const wage = U.getInputValue(`itemWage_${itemId}`);
                    const profit = U.getInputValue(`itemProfit_${itemId}`);
                    const vat = U.getInputValue(`itemVAT_${itemId}`);

                    const adjustedGramPrice = gramPrice * (purity / 750);
                    const priceOfGold = weight * adjustedGramPrice;
                    const laborCost = priceOfGold * (wage / 100);
                    profitAmount = (priceOfGold + laborCost) * (profit / 100);
                    const taxBase = laborCost + profitAmount;
                    taxAmount = taxBase * (vat / 100);
                    
                    finalPrice = priceOfGold + laborCost + profitAmount + taxAmount;
                }
                return { finalPrice, profitAmount, taxAmount, transactionType };
            },

            calculateInvoiceTotals: function() {
                let totalSales = 0;
                let totalPurchases = 0;
                let totalProfit = 0;
                let totalVAT = 0;
                let totalConvertedWeight750 = 0;
                let onlyMeltedItems = true; // Assume true, invalidate if other types are found
                let hasItems = false;

                document.querySelectorAll('.gold-item-row').forEach(row => {
                    hasItems = true;
                    const U = App.Utils;
                    const itemId = row.dataset.itemId;                    
                    const itemType = row.dataset.itemType || 'manual';           
                    const { finalPrice, profitAmount, taxAmount, transactionType } = this.calculateItemFinalPrice(row);
                    // Any item that is not a melted-gold type should invalidate the flag.
                    if (itemType !== 'melted-sell' && itemType !== 'melted-buy') { // Corrected logic
                        onlyMeltedItems = false;
                    }   

                    if (transactionType === 'buy') {
                        totalPurchases += finalPrice;
                    } else { // 'sell'
                        totalSales += finalPrice;
                        totalProfit += profitAmount;
                        totalVAT += taxAmount;
                    }

                    if (!itemType.startsWith('coin')) {
                        const weight = U.getInputValue(`itemWeight_${itemId}`);
                        const purity = U.getInputValue(`itemPurity_${itemId}`);
                        totalConvertedWeight750 += weight * (purity / 750);
                    }
                });

                // If there are no items, it's not "only melted items" 
                if (!hasItems) {
                    onlyMeltedItems = false;
                }           

                const finalAmount = totalSales - totalPurchases;
                return { totalSales, totalPurchases, finalAmount, totalProfit, totalVAT, totalConvertedWeight750, onlyMeltedItems };
            },
            clearInvoiceForm: function() {
                document.getElementById('goldItemsContainer').innerHTML = '';
                this.addGoldItemRow(); // Add one empty row back
                document.getElementById('cashPayment').value = '';
            },

            updateTotal: function() {
                const items = [];
                document.querySelectorAll('.gold-item-row').forEach(row => {
                    const itemId = row.dataset.itemId;
                    const item = {
                        description: document.getElementById(`itemDescription_${itemId}`).value,
                        weight: App.Utils.getInputValue(`itemWeight_${itemId}`),
                        purity: App.Utils.getInputValue(`itemPurity_${itemId}`),
                        wage: App.Utils.getInputValue(`itemWage_${itemId}`),
                        profit: App.Utils.getInputValue(`itemProfit_${itemId}`),
                        vat: App.Utils.getInputValue(`itemVAT_${itemId}`),
                        gramPrice: App.Utils.getInputValue(`itemGramPrice_${itemId}`),
                        itemType: row.dataset.itemType,
                        buyDeduction: row.dataset.itemType === 'melted-buy' ? App.Utils.getInputValue(`itemBuyDeduction_${itemId}`) : 0
                    };
                    items.push(item);
                });
                localStorage.setItem('goldInvoiceItems', JSON.stringify(items));

                const totals = this.calculateInvoiceTotals();
                const U = App.Utils;

                document.getElementById('summaryTotalSales').textContent = `${U.formatNumber(Math.round(totals.totalSales))} تومان`;
                document.getElementById('summaryTotalPurchases').textContent = `${U.formatNumber(Math.round(totals.totalPurchases))} تومان`;
                
                const cashPayment = U.getInputValue('cashPayment', 0);
                const oldGoldWeight = U.getInputValue('oldGoldPaymentWeight', 0);
                const oldGoldPurity = U.getInputValue('oldGoldPaymentPurity', 750);
                const oldGoldDeduction = U.getInputValue('settingOldGoldDeduction', 15);
                const gramPrice = App.liveGoldPrice18k;
                const oldGoldValue = oldGoldWeight * (gramPrice * (oldGoldPurity / 750) * ((750 - oldGoldDeduction) / 750));

                const totalPayment = cashPayment + oldGoldValue;
                const remainingAmount = totals.finalAmount - totalPayment;

                document.getElementById('summaryFinalAmount').textContent = `${U.formatNumber(Math.round(Math.abs(totals.finalAmount)))} تومان`;
                document.getElementById('summaryFinalAmountLabel').textContent = `مبلغ نهایی ${totals.finalAmount >= 0 ? 'پرداختی' : 'دریافتی'}:`;
                
                const remainingEl = document.getElementById('summaryRemainingAmount');
                remainingEl.textContent = `${U.formatNumber(Math.round(remainingAmount))} تومان`;
                remainingEl.className = `font-bold ${remainingAmount > 0 ? 'text-red-600' : remainingAmount < 0 ? 'text-green-600' : 'text-gray-700'}`;
            },
            
            generateInvoice: function() {
                const U = App.Utils;
                const customerName = document.getElementById('customerName').value;
                const customerPhone = document.getElementById('customerPhone').value;
                const customerId = document.getElementById('customerName').dataset.customerId ? parseInt(document.getElementById('customerName').dataset.customerId, 10) : null;
                const invoiceDate = document.getElementById('invoiceDate').value;
                const invoiceNumber = this.getNextInvoiceNumber();

                // Payment details
                const cashPayment = U.getInputValue('cashPayment', 0);
                const oldGoldPayment = {
                    weight: U.getInputValue('oldGoldPaymentWeight', 0),
                    purity: U.getInputValue('oldGoldPaymentPurity', 750),
                    value: 0 // Will be calculated
                };

                U.setInputValueAndLocalStorage('customerName', customerName);
                U.setInputValueAndLocalStorage('customerPhone', customerPhone);

                const invoiceItemsData = [];
                const totals = this.calculateInvoiceTotals();
                let showWage = false;

                document.querySelectorAll('.gold-item-row').forEach(row => {
                    const itemId = row.dataset.itemId;
                    const description = document.getElementById(`itemDescription_${itemId}`).value;

                    if (U.getInputValue(`itemWeight_${itemId}`) <= 0 && !row.dataset.itemType.startsWith('coin')) return;

                    const { finalPrice, transactionType } = this.calculateItemFinalPrice(row);

                    const item = {
                        description: description,
                        weight: U.getInputValue(`itemWeight_${itemId}`),
                        purity: U.getInputValue(`itemPurity_${itemId}`),
                        transactionType: description.toLowerCase().includes('خرید') ? 'buy' : 'sell',
                        finalPrice: finalPrice,
                        wage: U.getInputValue(`itemWage_${itemId}`), // Corrected from itemWage_
                        gramPrice: U.getInputValue(`itemGramPrice_${itemId}`), 
                        itemType: row.dataset.itemType
                    };

                    if(item.wage > 0) showWage = true;
                    
                    invoiceItemsData.push(item);
                });

                if (invoiceItemsData.length === 0) {
                    App.UI.showMessage('لطفا حداقل یک آیتم معتبر برای صدور فاکتور وارد کنید.');
                    return;
                }

                let baseGramPriceForDisplay = App.liveGoldPrice18k; 
                const firstRelevantItem = invoiceItemsData.find(item => item.itemType !== 'melted-buy' && item.gramPrice > 0);
                if (firstRelevantItem) {
                    baseGramPriceForDisplay = firstRelevantItem.gramPrice;
                }

                let tableHeaders = `
                    <th style="padding: 4px; border: 1px solid #ccc;">ردیف</th>
                    <th style="padding: 4px; border: 1px solid #ccc; text-align: right; width: 40%;">شرح کالا</th>
                    <th style="padding: 4px; border: 1px solid #ccc;">وزن (گرم)</th>
                    <th style="padding: 4px; border: 1px solid #ccc;">عیار</th>
                    <th style="padding: 4px; border: 1px solid #ccc;">وزن (750)</th>
                `;
                if(showWage) tableHeaders += `<th style="padding: 4px; border: 1px solid #ccc;">اجرت (%)</th>`;
                tableHeaders += `<th style="padding: 4px; border: 1px solid #ccc;">مبلغ نهایی (تومان)</th>`;


                let itemsHtml = '';
                invoiceItemsData.forEach((item, i) => {
                    const isCoin = item.itemType.startsWith('coin');
                    const convertedWeight = item.weight * (item.purity / 750);
                    const convertedWeight750Cell = isCoin ? `<td style="padding: 4px; text-align: center;">---</td>` : `<td style="padding: 4px; text-align: center; background-color: #fefce8;">${U.formatNumber(convertedWeight.toFixed(3))}</td>`;
                    
                    let rowHtml = `
                        <tr style="border-bottom: 1px solid #ccc; ${item.transactionType === 'buy' ? 'background-color: #fff5f5;' : ''}">
                            <td style="padding: 4px; text-align: center;">${i + 1}</td>
                            <td style="padding: 4px;">${item.description}</td>
                            <td style="padding: 4px; text-align: center;">${isCoin ? '---' : U.formatNumber(item.weight.toFixed(3))}</td>
                            <td style="padding: 4px; text-align: center;">${isCoin ? '---' : item.purity}</td>
                            ${convertedWeight750Cell}
                    `;
                    if(showWage) rowHtml += `<td style="padding: 4px; text-align: center;">${item.wage > 0 ? item.wage + '%' : '---'}</td>`;
                    rowHtml += `<td style="padding: 4px; text-align: center;">${U.formatNumber(Math.round(item.finalPrice))}</td></tr>`;
                    itemsHtml += rowHtml;
                });
                
                const oldGoldDeduction = U.getInputValue('settingOldGoldDeduction', 15);
                const oldGoldValue = oldGoldPayment.weight * (baseGramPriceForDisplay * (oldGoldPayment.purity / 750) * ((750 - oldGoldDeduction) / 750));
                oldGoldPayment.value = oldGoldValue;

                const totalPayment = cashPayment + oldGoldValue;
                const remainingAmount = totals.finalAmount - totalPayment;

                const hasBuyAndSell = totals.totalSales > 0 && totals.totalPurchases > 0;

                let footerHtml;
                if (hasBuyAndSell || totalPayment > 0) {
                    footerHtml = `
                        <div style="font-size: 10pt; line-height: 1.6;">
                            ${hasBuyAndSell ? `<div>جمع کل فروش: <span style="font-weight: bold;">${U.formatNumber(Math.round(totals.totalSales))}</span> تومان</div>` : ''}
                            ${hasBuyAndSell ? `<div>جمع کل خرید: <span style="font-weight: bold;">${U.formatNumber(Math.round(totals.totalPurchases))}</span> تومان</div>` : ''}
                            ${hasBuyAndSell ? `<hr style="border: 0; border-top: 1px solid #ccc; margin: 4px 0;" />` : ''}
                            <div><strong>مبلغ کل فاکتور: </strong><span style="font-weight: bold;">${U.formatNumber(Math.round(totals.finalAmount))}</span> تومان</div>
                            ${cashPayment > 0 ? `<div>پرداخت نقدی: <span style="font-weight: bold;">${U.formatNumber(Math.round(cashPayment))}</span> تومان</div>` : ''}
                            ${oldGoldPayment.weight > 0 ? `<div>پرداخت با طلای کهنه (${oldGoldPayment.weight} گرم): <span style="font-weight: bold;">${U.formatNumber(Math.round(oldGoldValue))}</span> تومان</div>` : ''}
                            <hr style="border: 0; border-top: 1px solid #ccc; margin: 4px 0;" />
                            <div style="font-size: 11pt;"><strong>مبلغ باقیمانده: </strong>
                                <span style="font-size: 1.4rem; font-weight: bold;">${U.formatNumber(Math.round(Math.abs(remainingAmount)))}</span> تومان
                                <span style="font-size: 1rem;">(${remainingAmount > 0 ? 'بدهکار' : remainingAmount < 0 ? 'بستانکار' : 'تسویه شد'})</span>
                            </div>
                        </div>
                    `;
                } else {
                     footerHtml = `
                        <div style="font-size: 11pt;"><strong>مبلغ قابل پرداخت: </strong><span style="font-size: 1.4rem; font-weight: bold;">${U.formatNumber(Math.round(totals.finalAmount))}</span> تومان</div>
                    `;
                }

                let tableFooterHtml = '';
                if (totals.totalSales > 0 || totals.totalPurchases > 0) {
                    const colspan = 4;
                    const totalWeightCell = totals.onlyMeltedItems
                        ? `<td style="padding: 8px; text-align: center; border: 1px solid #ccc;">${U.formatNumber(totals.totalConvertedWeight750.toFixed(3))}</td>`
                        : `<td style="padding: 8px; border: 1px solid #ccc;"></td>`;

                    tableFooterHtml = `
                        <tfoot style="font-weight: bold; background-color: #f0f0f0;">
                            <tr>
                                <td colspan="${colspan}" style="padding: 8px; text-align: right; border: 1px solid #ccc;">جمع کل</td>
                                ${totalWeightCell}
                                ${showWage ? '<td style="padding: 8px; border: 1px solid #ccc;"></td>' : ''}
                                <td style="padding: 8px; text-align: center; border: 1px solid #ccc;">${U.formatNumber(Math.round(totals.finalAmount))}</td>
                            </tr>
                        </tfoot>
                    `;
                }

                let footnoteHtml = '';
                if (totals.totalSales > 0) {
                    const defaultProfit = U.getInputValue('invoiceProfit');
                    const defaultVAT = U.getInputValue('invoiceVAT');
                    footnoteHtml = `<div style="font-size: 8pt; color: #555; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 5px;">`;
                    footnoteHtml += `<span>جنس فوق با اجرت مشخص و سود ${defaultProfit}% و مالیات ارزش افزوده ${defaultVAT}% از اجرت و سود عرضه شده و در موقع فروش با فاکتور و به نرخ روز خریداری خواهد شد.</span>`;
                    footnoteHtml += `</div>`;
                }
                
                // Get settings from localStorage with fallbacks
                const storeName = localStorage.getItem('settingStoreName') || 'جواهری فانی';
                const storeAddress = localStorage.getItem('settingStoreAddress') || 'آدرس شما';
                const storePhone = localStorage.getItem('settingStorePhone') || 'شماره تماس شما';
                const storeLogoUrl = localStorage.getItem('settingStoreLogo') || 'logo.png'; // Fallback to logo.png

                const invoiceContent = `
<div style="font-family: sans-serif; direction: rtl; width: 190mm; margin: auto; font-size: 10pt; color: #333;">
    <header style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #DAA520; padding-bottom: 10px; margin-bottom: 15px;">
        <p style="margin: 4px 0;"><i class="fas fa-map-marker-alt" style="margin-left: 5px; color: #DAA520;"></i>${storeAddress}</p>
        <div style="display: flex; flex-direction: column; align-items: center;">
            <img src="${storeLogoUrl}" alt="لوگو" style="height: 50px; width: auto; max-width: 100px; object-fit: contain;" onerror="this.style.display='none'">
            <h1 style="margin: 5px 0 0; color: #DAA520; font-size: 1.2rem; text-align: center;">${storeName}</h1>
        </div>
        <p style="margin: 4px 0;"><i class="fas fa-phone-alt" style="margin-left: 5px; color: #DAA520;"></i>${storePhone}</p>
    </header>
    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 9pt;">
        <div><strong>شماره فاکتور:</strong> ${invoiceNumber}</div>
        <div><strong>نام مشتری:</strong> ${customerName || 'نامشخص'}</div>
        <div><strong>شماره تماس:</strong> ${customerPhone || 'نامشخص'}</div>
        <div><strong>تاریخ:</strong> ${invoiceDate}</div>
    </div>
    <div style="text-align: center; margin-bottom: 10px; font-size: 10pt; background-color: #fefae0; padding: 5px; border-radius: 5px;">
        <strong>نرخ هر گرم طلای ۱۸ عیار (۷۵۰) در این فاکتور:</strong> ${U.formatNumber(Math.round(baseGramPriceForDisplay))} تومان
    </div>
    <table style="width: 100%; border-collapse: collapse; font-size: 8.5pt;">
        <thead>
            <tr style="background-color: #f0f0f0;">${tableHeaders}</tr>
        </thead>
        <tbody>${itemsHtml}</tbody>
        ${tableFooterHtml}
    </table>
    <footer style="margin-top: 20px; display: flex; justify-content: space-between; align-items: flex-end;">
        ${footerHtml}
        <div style="text-align: center;">
            <p style="margin-bottom: 25px;">امضای فروشنده</p>
            <div style="border-top: 1px solid #333; width: 150px;"></div>
        </div>
    </footer>
    ${footnoteHtml}
</div>`;

                // Create a savable object
                const invoiceDataToSave = {
                    invoiceNumber: invoiceNumber,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    customerId: customerId ? parseInt(customerId, 10) : null,
                    date: invoiceDate,
                    items: invoiceItemsData,
                    totals: totals,
                    baseGramPrice: baseGramPriceForDisplay,
                    payment: {
                        cash: cashPayment,
                        oldGold: oldGoldPayment,
                        remaining: remainingAmount
                    },
                    invoiceHtml: invoiceContent // Save the generated HTML for re-printing
                };

                // Store data to be saved on print 
                this.currentInvoiceData = invoiceDataToSave;

                document.getElementById('invoicePreviewContainerWrapper').classList.remove('hidden');
                document.getElementById('invoicePreviewContainer').innerHTML = invoiceContent;
                document.getElementById('print-area').innerHTML = invoiceContent;
                document.getElementById('printInvoiceBtn').classList.remove('hidden');
            },
            reprintInvoice: function(invoiceId) {
                if (!App.DB.db) return;
                const transaction = App.DB.db.transaction(['invoices'], 'readonly');
                const store = transaction.objectStore('invoices');
                const request = store.get(invoiceId);

                request.onsuccess = (event) => {
                    const invoiceData = event.target.result;
                    if (invoiceData && invoiceData.invoiceHtml) {
                        document.getElementById('print-area').innerHTML = invoiceData.invoiceHtml;
                        window.print();
                    } else {
                        App.UI.showMessage('خطا: اطلاعات این فاکتور برای چاپ مجدد یافت نشد.');
                    }
                };
                request.onerror = () => {
                     App.UI.showMessage('خطا در بازیابی اطلاعات فاکتور.');
                }
            }
        },

        Tools: {
            init: function() {
                const toggleBtn = document.getElementById('tools-toggle-btn');
                const sidebar = document.querySelector('.tools-sidebar');
                const icon = toggleBtn ? toggleBtn.querySelector('i') : null;

                if (!toggleBtn || !sidebar || !icon) return;

                const toggleMenu = (forceClose = false) => {
                    const isCurrentlyOpen = sidebar.classList.contains('is-expanded');
                    const shouldOpen = forceClose ? false : !isCurrentlyOpen;

                    sidebar.classList.toggle('is-expanded', shouldOpen);
                    
                    icon.classList.toggle('fa-bars', !shouldOpen);
                    icon.classList.toggle('fa-times', shouldOpen);
                };

                toggleBtn.addEventListener('click', (e) => {
                    toggleMenu();
                });
            }
        },

        Navbar: {
            init: function() {
                this.navbar = document.querySelector('.navbar-top');
                this.container = document.querySelector('.navbar-content-wrapper');
                this.toggleBtn = document.getElementById('navbar-toggle-btn');
                this.items = Array.from(this.container.children);

                this.toggleBtn.addEventListener('click', () => {
                    this.navbar.classList.toggle('expanded');
                    this.setBodyPadding();
                });

                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => this.adjustItems(), 100);
                });
                
                this.adjustItems();
            },

            setBodyPadding: function() {
                const navbarHeight = this.navbar.offsetHeight;
                document.body.style.paddingTop = `${navbarHeight + 10}px`;
            },

            adjustItems: function() {
                // 1. Reset state for measurement
                this.items.forEach(item => item.classList.remove('nav-item-hidden'));
                this.toggleBtn.classList.remove('hidden');
                
                const availableWidth = this.container.offsetWidth;
                const gap = parseInt(getComputedStyle(this.container).gap) || 15;

                let currentWidth = 0;
                let visibleItemsCount = 0;

                // 2. Find how many items fit
                for (const item of this.items) {
                    const itemWidth = item.offsetWidth;
                    const widthWithGap = visibleItemsCount > 0 ? itemWidth + gap : itemWidth;

                    if ((currentWidth + widthWithGap) > availableWidth) {
                        break; // Stop when we overflow
                    }
                    currentWidth += widthWithGap;
                    visibleItemsCount++;
                }

                // 3. If not all items are visible, hide the rest and show the button
                if (visibleItemsCount < this.items.length) {
                    this.items.forEach((item, index) => item.classList.toggle('nav-item-hidden', index >= visibleItemsCount));
                    this.toggleBtn.classList.remove('hidden');
                } else {
                    this.toggleBtn.classList.add('hidden');
                    this.navbar.classList.remove('expanded');
                    this.items.forEach(item => item.classList.remove('nav-item-hidden'));
                }
                
                this.setBodyPadding();
            }
        },

        // This function is called only once after a successful login
        initAppLogic: function() {
            this.DB.initDB();
            this.Utils.loadValuesFromLocalStorage();
            this.Settings.init(); 
            
            const savedItems = JSON.parse(localStorage.getItem('goldInvoiceItems') || '[]');
            if (savedItems.length > 0) {
                document.getElementById('goldItemsContainer').innerHTML = ''; // Clear default
                savedItems.forEach(itemData => this.Invoice.addGoldItemRow(itemData));
            } else {
                 this.Invoice.addGoldItemRow();
            }

            this.UI.fetchLivePrices();
            setInterval(() => this.UI.fetchLivePrices(), 60000); 
            
            this.Tools.init();
            this.Navbar.init();
            this.UI.showTab('tab-column1');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.id.replace('btn-tab-', 'tab-column-').replace('btn-tab', 'tab-column');
                    this.UI.showTab(tabId);
                    if (tabId === 'tab-column-archive') {
                        this.DB.renderInvoices();
                    }
                    if (tabId === 'tab-column-customers') {
                        this.DB.renderCustomers();
                    }
                });
            });

            document.querySelectorAll('[id^="calculateBtn"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const calcId = btn.id.replace('calculateBtn', 'column');
                    this.Calculators.recalculate(calcId);
                });
            });
            
            document.getElementById('generateInvoiceBtn').addEventListener('click', () => this.Invoice.generateInvoice());        
            document.getElementById('printInvoiceBtn').addEventListener('click', () => {
                const customerData = {
                    name: this.Invoice.currentInvoiceData.customerName,
                    phone: this.Invoice.currentInvoiceData.customerPhone
                };
                this.DB.saveOrUpdateCustomer(customerData);

                if (this.Invoice.currentInvoiceData) {
                    this.Invoice.setLastInvoiceNumber(this.Invoice.currentInvoiceData.invoiceNumber);
                    this.DB.saveInvoice(this.Invoice.currentInvoiceData);
                    this.Invoice.currentInvoiceData = null; // Clear after saving to prevent re-saving
                }
                window.print();
            });
            document.getElementById('addGoldItemBtn').addEventListener('click', () => this.Invoice.addGoldItemRow());

            document.getElementById('goldItemsContainer').addEventListener('click', (e) => {
                const button = e.target.closest('.remove-item-btn');
                if (button) this.Invoice.removeGoldItemRow(button);
            });

            ['1', '2', '3', '6'].forEach(i => {
                const priceGramInput = document.getElementById(`price_gram${i}`);
                if (priceGramInput) {
                    priceGramInput.addEventListener('input', (e) => {
                        this.Utils.formatNumberInput(e.target);
                        this.userModifiedPrices[e.target.id] = true;
                        this.Calculators.recalculate(`column${i}`);
                    });
                }
                if(i !== '6') { // Column 6 purity is handled differently
                    const purityInput = document.getElementById(`goldPurity${i}`);
                    if (purityInput) {
                        purityInput.addEventListener('change', () => {
                            this.Calculators.recalculate(`column${i}`);
                        });
                    }
                }
            });

            document.getElementById('goldItemsContainer').addEventListener('input', (e) => {
                const targetId = e.target.id;
                if (targetId.startsWith('itemGramPrice_')) {
                    App.userModifiedPrices[targetId] = true;
                }
                App.Invoice.updateTotal(); 
            });

            ['invoiceProfit', 'invoiceVAT'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    App.Utils.setInputValueAndLocalStorage(id, e.target.value);
                });
            });
            
            // In UI.updateNavbarPrices, we should trigger an adjustment 
            const originalUpdateNavbarPrices = this.UI.updateNavbarPrices.bind(this.UI);
            this.UI.updateNavbarPrices = (data, source) => {
                originalUpdateNavbarPrices(data, source);
                setTimeout(() => this.Navbar.adjustItems(), 50);
            };

            document.getElementById('price_gram6').addEventListener('input', (e) => {
                this.Utils.formatNumberInput(e.target);
                this.userModifiedPrices[e.target.id] = true;
            });

            ['price_gram6', 'weight_gram6', 'goldPurity6', 'profit_melted', 'buy_deduction6', 'VAT6'].forEach(id => {
                 document.getElementById(id).addEventListener('input', () => this.Calculators.recalculate('column6'));
            });

            const meltedProfitContainer = document.getElementById('profit_melted').parentElement.parentElement;
            const meltedDeductionContainer = document.getElementById('buyDeductionContainer6');
            const meltedVatContainer = document.getElementById('VAT6').parentElement.parentElement;
            
            const handleTransactionTypeChange = () => {
                const type = document.querySelector('input[name="transaction_type6"]:checked').value;
                if (type === 'buy') {
                    meltedProfitContainer.classList.add('hidden');
                    meltedDeductionContainer.classList.remove('hidden');
                    meltedVatContainer.classList.add('hidden');
                } else { // 'sell'
                    meltedProfitContainer.classList.remove('hidden');
                    meltedDeductionContainer.classList.add('hidden');
                    meltedVatContainer.classList.remove('hidden');
                }
                this.Calculators.recalculate('column6');
            };

            document.querySelectorAll('input[name="transaction_type6"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    handleTransactionTypeChange();
                    localStorage.setItem(e.target.name, e.target.value);
                });
            });

            handleTransactionTypeChange(); // Set initial state on load

            // --- Coin Calculator Event Listeners ---
            document.getElementById('coin_type7').addEventListener('change', () => this.Calculators.updateCoinPrice());
            ['coin_quantity7', 'coin_price7', 'parsian_weight7'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => this.Calculators.calculatecolumn7());
            });
            document.querySelectorAll('input[name="transaction_type7"]').forEach(radio => {
                radio.addEventListener('change', () => this.Calculators.calculatecolumn7());
            });

            document.getElementById('invoiceFromCalc1').addEventListener('click', () => {
                const U = App.Utils;
                const weight = U.unformatNumber(document.getElementById('display-weight1').textContent);
                if (weight > 0) {
                    const itemData = {
                        description: `محصول محاسبه‌شده (قیمت هدف)`,
                        weight: weight,
                        purity: U.getInputValue('goldPurity1'),
                        wage: U.getInputValue('wage1'),
                        profit: U.getInputValue('profit1'),
                        vat: U.getInputValue('VAT1'),
                        gramPrice: U.getInputValue('price_gram1'),
                        itemType: 'manual'
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم با موفقیت به فاکتور اضافه شد.', 'success');
                }
            });

            document.getElementById('invoiceFromCalc2').addEventListener('click', () => {
                const U = App.Utils;
                const weight = U.getInputValue('weight2');
                if (weight > 0) {
                    const itemData = {
                        description: `محصول محاسبه‌شده`,
                        weight: weight,
                        purity: U.getInputValue('goldPurity2'),
                        wage: U.getInputValue('wage2'),
                        profit: U.getInputValue('profit2'),
                        vat: U.getInputValue('VAT2'),
                        gramPrice: U.getInputValue('price_gram2'),
                        itemType: 'manual'
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم با موفقیت به فاکتور اضافه شد.', 'success');
                }
            });

            document.getElementById('invoiceFromCalc3').addEventListener('click', () => {
                const U = App.Utils;
                const weight = U.getInputValue('weight_input3');
                if (weight > 0) {
                    const itemData = {
                        description: `خرید طلای کهنه`,
                        weight: weight,
                        purity: U.getInputValue('goldPurity3'),
                        gramPrice: U.getInputValue('price_gram3'), // Corrected from price_gram_3
                        itemType: 'old-gold'
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم طلای کهنه با موفقیت به فاکتور اضافه شد.', 'success');
                }
            });
            
            document.getElementById('invoiceFromCalc6').addEventListener('click', () => {
                const U = App.Utils;
                const type = document.querySelector('input[name="transaction_type6"]:checked').value;
                const weight = U.getInputValue('weight_gram6');

                if (weight > 0) {
                    const itemData = {
                        description: (type === 'buy' ? 'خرید' : 'فروش') + ' آبشده',
                        weight: weight,
                        purity: U.getInputValue('goldPurity6'),
                        gramPrice: U.getInputValue('price_gram6'),
                        itemType: type === 'buy' ? 'melted-buy' : 'melted-sell',
                        profit: type === 'sell' ? U.getInputValue('profit_melted') : 0,
                        vat: type === 'sell' ? U.getInputValue('VAT6') : 0,
                        wage: 0,
                        buyDeduction: type === 'buy' ? U.getInputValue('buy_deduction6') : 0
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم آبشده با موفقیت به فاکتور اضافه شد.', 'success');
                } else {
                    App.UI.showMessage('ابتدا یک محاسبه معتبر انجام دهید.');
                }
            });
            
            document.getElementById('invoiceFromCalc7').addEventListener('click', () => {
                const U = App.Utils;
                const quantity = U.getInputValue('coin_quantity7');
                const totalPrice = U.unformatNumber(document.getElementById('display-total-price7').textContent);
                const transactionType = document.querySelector('input[name="transaction_type7"]:checked').value;
                const coinSelect = document.getElementById('coin_type7');
                const coinName = coinSelect.options[coinSelect.selectedIndex].text;
                
                if (totalPrice > 0) {
                    let description = `${transactionType === 'buy' ? 'خرید' : 'فروش'} ${U.formatNumber(quantity)} عدد ${coinName}`;
                    if (coinSelect.value === 'parsian') {
                        description += ` به وزن ${U.getInputValue('parsian_weight7')} گرم`;
                    }

                    const itemData = {
                        description: description,
                        weight: totalPrice, // Store total price in weight field for simplicity in invoice calculation
                        purity: 0,
                        gramPrice: 0, // Corrected from gram_price
                        itemType: 'coin'
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم سکه با موفقیت به فاکتور اضافه شد.', 'success');
                }
            });

            const productForm = document.getElementById('product-form');
            productForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const product = {
                    name: document.getElementById('productName').value,
                    weight: this.Utils.getInputValue('productWeight'),
                    purity: this.Utils.getInputValue('productPurity'),
                    wage: this.Utils.getInputValue('productWage')
                };
                
                const productId = parseInt(document.getElementById('productId').value, 10);
                if (productId) {
                    product.id = productId;
                    product.barcode = document.getElementById('productBarcode').value;
                }
                
                this.DB.saveProduct(product);
                productForm.reset();
                document.getElementById('productId').value = '';
                document.getElementById('productBarcode').value = '';
                document.getElementById('product-form-title').textContent = 'افزودن جنس جدید';
                document.getElementById('product-form-submit-btn-text').textContent = 'ذخیره جنس';
                document.getElementById('cancelEditBtn').classList.add('hidden');
            });

            document.getElementById('printInvoiceBtn').addEventListener('click', () => {
                const { customerName, customerPhone, payment, invoiceNumber } = this.Invoice.currentInvoiceData;
                
                // This logic is flawed if customer name is edited. It should be based on ID.
                // Save/Update customer and then update their balance
                const transaction = this.DB.db.transaction(["customers"], "readwrite");
                const store = transaction.objectStore("customers");
                const phoneIndex = store.index("phone");
                const request = phoneIndex.get(customerPhone.trim());
                
                request.onsuccess = (event) => {
                    let customer = event.target.result;
                    if (customer) {
                        // The remaining amount is what the customer owes (positive) or is credited (negative)
                        customer.balance = (customer.balance || 0) + payment.remaining;
                        store.put(customer);
                    } else if (customerName.trim()) {
                        // If customer doesn't exist, create them
                        const newCustomer = { 
                            name: customerName, phone: customerPhone, 
                            balance: payment.remaining, customerCode: this.DB.getNextCustomerCode() 
                        };
                        store.add(newCustomer);
                    }
                };

                this.DB.saveInvoice(this.Invoice.currentInvoiceData);
                this.Invoice.setLastInvoiceNumber(invoiceNumber);
                window.print();
            });
            
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                 productForm.reset();
                 document.getElementById('productId').value = '';
                 document.getElementById('productBarcode').value = '';
                 document.getElementById('product-form-title').textContent = 'افزودن جنس جدید';
                 document.getElementById('product-form-submit-btn-text').textContent = 'ذخیره جنس';
                 document.getElementById('cancelEditBtn').classList.add('hidden');
            });

            document.getElementById('productSearch').addEventListener('input', (e) => {
                this.DB.searchProducts(e.target.value);
            });
            
            document.getElementById('productList').addEventListener('click', (e) => {
                const target = e.target;
                const action = target.dataset.action;
                const productId = parseInt(target.dataset.id, 10);
                if (!action || !productId) return;

                if (action === 'delete') {
                    this.UI.showConfirmation('آیا از حذف این جنس اطمینان دارید؟', () => {
                        this.DB.deleteProduct(productId);
                    });
                } else if (action === 'edit') {
                    this.DB.getProduct(productId, (product) => {
                        if (product) {
                            document.getElementById('productId').value = product.id;
                            document.getElementById('productName').value = product.name;
                            document.getElementById('productBarcode').value = product.barcode || '';
                            document.getElementById('productWeight').value = product.weight;
                            document.getElementById('productPurity').value = product.purity;
                            document.getElementById('productWage').value = product.wage;
                            document.getElementById('product-form-title').textContent = 'ویرایش جنس';
                            document.getElementById('product-form-submit-btn-text').textContent = 'بروزرسانی جنس';
                            document.getElementById('cancelEditBtn').classList.remove('hidden');
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                } else if (action === 'use') {
                    this.DB.getProduct(productId, (product) => {
                        if (product) {
                            this.UI.showTab('tab-column4');
                            this.Invoice.addGoldItemRow(product);
                            this.UI.showMessage(`جنس "${product.name}" به فاکتور اضافه شد.`, 'success');
                        }
                    });
                }
            });
            
            document.getElementById('logout-btn').addEventListener('click', () => {
                this.Auth.handleLogout();
            });
            
            document.getElementById('export-btn').addEventListener('click', () => {
                this.DB.exportToExcel();
            });

            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });

            document.getElementById('import-file-input').addEventListener('change', (event) => {
                this.DB.importFromCSV(event.target.files[0]); 
                event.target.value = ''; // ریست کردن اینپوت تا بتوان دوباره همان فایل را انتخاب کرد
            });

            // Event listeners for invoice archive
            const getArchiveFilters = () => {
                const filters = {
                    customerName: document.getElementById('invoiceSearchCustomer').value,
                    date: document.getElementById('invoiceSearchDate').value,
                    invoiceNumber: document.getElementById('invoiceSearchNumber').value
                };
                // Customer balance filter is handled in renderCustomers, not here.
                // This is just to ensure the function call is correct.
                const balanceFilterEl = document.getElementById('customerBalanceFilter');
                if (balanceFilterEl) filters.balanceStatus = balanceFilterEl.value;
                return filters;
            };

            ['invoiceSearchCustomer', 'invoiceSearchDate', 'invoiceSearchNumber', 'customerBalanceFilter'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    this.DB.renderInvoices(getArchiveFilters(), 1);
                });
            });

            document.getElementById('itemsPerPage').addEventListener('change', (e) => {
                this.DB.itemsPerPage = parseInt(e.target.value, 10);
                localStorage.setItem('itemsPerPage', this.DB.itemsPerPage);
                this.DB.renderInvoices(getArchiveFilters(), 1);
            });

            document.getElementById('pagination-controls').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.page) {
                    this.DB.renderInvoices(getArchiveFilters(), parseInt(e.target.dataset.page, 10));
                }
            });

            document.getElementById('invoice-archive-list').addEventListener('click', (e) => {
                const target = e.target;
                const action = target.dataset.action;
                const invoiceId = parseInt(target.dataset.id, 10);
                if (!action || !invoiceId) return;

                if (action === 'delete-invoice') { 
                    this.UI.showConfirmation('آیا از حذف این فاکتور اطمینان دارید؟ این عمل غیرقابل بازگشت است.', () => {
                        this.DB.deleteInvoice(invoiceId);
                    });
                } else if (action === 'reprint') {
                    this.Invoice.reprintInvoice(invoiceId);
                }
            });

            // --- Customer Management Event Listeners ---
            document.getElementById('customerSearch').addEventListener('input', (e) => {
                this.DB.renderCustomers(e.target.value, document.getElementById('customerBalanceFilter').value);
            });

            document.getElementById('customerBalanceFilter').addEventListener('change', (e) => {
                this.DB.renderCustomers(document.getElementById('customerSearch').value, e.target.value);
            });

            document.getElementById('back-to-customer-list').addEventListener('click', () => {
                document.getElementById('customer-details-view').classList.add('hidden');
                document.getElementById('customer-list-view').classList.remove('hidden');
            });

            document.getElementById('customer-list').addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action]');
                if (!button) return;

                const action = button.dataset.action;
                const customerId = parseInt(button.dataset.id, 10);

                if (action === 'view-details') {
                    this.DB.showCustomerDetails(customerId);
                } else if (action === 'edit-customer') {
                    const currentName = button.dataset.name;
                    const currentPhone = button.dataset.phone;
                    const newName = prompt('نام جدید مشتری را وارد کنید:', currentName);
                    const newPhone = prompt('شماره تلفن جدید مشتری را وارد کنید:', currentPhone);
                    if (newName !== null && newPhone !== null) this.DB.updateCustomer(customerId, newName.trim(), newPhone.trim());
                }
                else if (action === 'delete-customer') {
                    this.UI.showConfirmation('آیا از حذف این مشتری و تمام سوابق فاکتورهای او اطمینان دارید؟ این عمل غیرقابل بازگشت است.', 
                        () => this.DB.deleteCustomer(customerId));
                }
            });

            document.getElementById('add-customer-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('newCustomerName');
                const phoneInput = document.getElementById('newCustomerPhone');
                this.DB.addCustomer(nameInput.value, phoneInput.value);
                nameInput.value = '';
                phoneInput.value = '';
            });
            // --- Autocomplete for Customer Name in Invoice ---
            const customerNameInput = document.getElementById('customerName');
            const suggestionsDiv = document.getElementById('customer-suggestions');

            customerNameInput.addEventListener('input', () => {
                const query = customerNameInput.value;
                if (query.length < 2) {
                    suggestionsDiv.innerHTML = '';
                    suggestionsDiv.classList.add('hidden');
                    return;
                }
                this.DB.searchCustomersByName(query, (customers) => {
                    if (customers.length > 0) {
                        suggestionsDiv.innerHTML = customers.map(c => 
                            `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-id="${c.id}" data-name="${c.name}" data-phone="${c.phone || ''}">${c.name} (${c.phone || 'بدون شماره'})</div>`
                        ).join('');
                        suggestionsDiv.classList.remove('hidden');
                    } else {
                        suggestionsDiv.classList.add('hidden');
                    }
                });
            });

            suggestionsDiv.addEventListener('click', (e) => {
                if (e.target.dataset.name) {
                    customerNameInput.value = e.target.dataset.name;
                    document.getElementById('customerPhone').value = e.target.dataset.phone;
                    customerNameInput.dataset.customerId = e.target.dataset.id;
                    suggestionsDiv.classList.add('hidden');
                }
            });
            document.getElementById('customer-invoice-list').addEventListener('click', (e) => {
                const target = e.target.closest('button[data-action="reprint-from-customer"]');
                if (target) {
                    this.Invoice.reprintInvoice(parseInt(target.dataset.id, 10));
                }
            });
        },
        
        // Main entry point of the application
        init: function() {
            // Initially, only the authentication module is activated. The rest of the app runs after a successful login.
            this.Auth.init();
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        App.init();
    });
</script>
</body>
</html>
