<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simin.Gold</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* متغیرهای اصلی CSS برای تم برنامه */
        :root {
            --color-gold-light: #FFD700; /* طلایی روشن */
            --color-gold-dark: #DAA520; /* طلایی تیره */
            --color-light-bg: #F8F8F8; /* پس‌زمینه خاکستری روشن */
            --color-card-light-bg: #FFFFFF; /* پس‌زمینه سفید کارت‌ها */
            --color-dark-text: #333333; /* متن خاکستری تیره */
            --color-gold-accent: #FFC107; /* طلایی کهربایی برای تاکید */
            --color-input-bg-light: #F0F0F0; /* پس‌زمینه روشن ورودی */
            --color-input-border-light: #E0E0E0; /* حاشیه روشن ورودی */
            --color-results-bg: #FFFBF0; /* پس‌زمینه بسیار روشن طلایی برای نتایج */
            --color-results-border: #FFD700; /* حاشیه طلایی برای نتایج */
        }

        /* استایل‌های پایه و فونت اصلی */
        body {
            font-family: "IranSans", sans-serif;
            direction: rtl;
            text-align: right;
            background-color: var(--color-light-bg);
            color: var(--color-dark-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        
        /* ایجاد فاصله در بالای صفحه برای نوار ثابت */
        body.app-view {
             padding-top: 60px; /* مقدار پیش‌فرض؛ توسط جاوااسکریپت تنظیم می‌شود */
        }

        /* استایل متن نتایج محاسبات */
        .highlighted-result {
            font-size: 1.125rem; /* اندازه فونت برای موبایل */
            color: var(--color-gold-dark);
            font-weight: bold;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--color-gold-light);
            padding-bottom: 0.5rem;
        }
        @media (min-width: 768px) {
             .highlighted-result {
                 font-size: 1.25rem; /* اندازه فونت برای دسکتاپ */
            }
        }

        /* استایل دکمه‌های طلایی با گرادینت */
        .btn-gold-gradient {
            background: linear-gradient(145deg, var(--color-gold-light), var(--color-gold-dark));
            color: var(--color-dark-text);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-gold-gradient:hover {
            background: linear-gradient(145deg, var(--color-gold-dark), var(--color-gold-light));
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }

        /* استایل اینپوت‌ها در حالت فوکوس */
        input:focus, select:focus {
            outline: none;
            border-color: var(--color-gold-accent);
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.5);
        }

        /* استایل دکمه‌های تب (ابزارها) */
        .tab-button {
            font-weight: 600;
            background-color: var(--color-card-light-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            font-size: 0.8rem;
        }
        @media (min-width: 640px) {
            .tab-button {
                font-size: 0.9rem;
            }
        }
        
        .tab-button:hover {
            background-color: #fcfcfc;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .tab-button.active {
            background-color: var(--color-results-bg);
            border-color: var(--color-gold-dark) !important;
        }
        
        @media (min-width: 768px) {
            .tab-button.active {
                box-shadow: 4px 0 20px rgba(255, 193, 7, 0.4);
            }
        }
         @media (max-width: 767px) {
            .tab-button.active {
                box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4);
            }
        }

        /* رنگ متن و آیکون دکمه‌های تب */
        .tab-button .tab-button-content,
        .tab-button .icon-placeholder {
            color: var(--color-dark-text);
            transition: color 0.3s ease;
        }
        
        .tab-button:hover .tab-button-content,
        .tab-button:hover .icon-placeholder {
            color: var(--color-gold-light);
        }

        /* رنگ طلایی ثابت برای تب فعال */
        .tab-button.active .tab-button-content,
        .tab-button.active .icon-placeholder,
        .tab-button.active:hover .tab-button-content,
        .tab-button.active:hover .icon-placeholder {
            color: var(--color-gold-dark);
        }
        
        /* اندازه و چینش آیکون در دکمه تب */
        .tab-button .icon-placeholder {
            width: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .tab-button-content {
            flex-grow: 1;
            text-align: right;
            padding-right: 1rem; /* space between icon and text */
            font-size: 0.9rem;
        }
        @media (max-width: 767px) {
            .tab-button-content {
                /* padding-right: 0.5rem; */
                padding-left: 0;
            }
        }

        /* انیمیشن نمایش محتوای تب‌ها */
        .tab-content {
            display: none;
            animation: fadeInSlideUp 0.5s ease-in-out forwards;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- استایل‌های نوار اطلاعات بالای صفحه --- */
        .navbar-top {
            background-color: var(--color-gold-dark);
            color: #333;
            padding: 10px 20px;
            font-size: 0.9rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: padding 0.3s ease;
        }

        .navbar-content-wrapper {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            align-items: center;
            overflow: hidden; /* مخفی کردن آیتم‌های اضافی که در یک خط جا نمی‌شوند */
            flex-grow: 1;
            min-width: 0; /* جلوگیری از سرریز شدن آیتم‌های فلکس از کانتینر */
        }

        .navbar-top.expanded .navbar-content-wrapper {
            flex-wrap: wrap;
            justify-content: flex-start; /* چینش از راست در حالت باز شده */
            padding-bottom: 10px;
        }

        .navbar-content-wrapper > * {
            white-space: nowrap;
            font-weight: 500;
            flex-shrink: 0;
            display: block; /* Default display */
        }

        /* این کلاس توسط جاوااسکریپت برای مخفی کردن آیتم‌ها اضافه می‌شود */
        .navbar-content-wrapper > .nav-item-hidden {
            display: none;
        }

        /* در حالت باز شده، آیتم‌های مخفی نمایش داده می‌شوند */
        .navbar-top.expanded .navbar-content-wrapper > .nav-item-hidden {
            display: block;
        }
        
        .navbar-top span strong {
            font-weight: 700;
            color: rgb(98, 37, 37);
        }

        #navbar-toggle-btn {
            /* نمایش این دکمه توسط جاوااسکریپت کنترل می‌شود */
            background: transparent;
            border: none;
            color: #333;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px;
            margin-right: 10px; /* فاصله در حالت راست‌چین */
            flex-shrink: 0;
        }

        #navbar-toggle-btn.hidden {
            display: none;
        }

        #navbar-toggle-btn i {
            transition: transform 0.3s ease;
        }

        .navbar-top.expanded #navbar-toggle-btn i {
            transform: rotate(180deg);
        }
       
        /* --- استایل‌های منوی ابزار کناری --- */
        .tools-sidebar {
            transition: width 0.3s ease-in-out;
        }

        .tools-sidebar .tab-button-content {
            transition: width 0.2s 0.1s ease-in-out, opacity 0.2s 0.1s ease-in-out, padding 0.2s 0.1s ease-in-out;
        }

        /* استایل موبایل: منو به صورت پیش‌فرض بسته است */
        @media (max-width: 767px) {
            .main-app-container {
                flex-direction: row;
                gap: 0; /* حذف فاصله برای چسبیدن منو به لبه */
            }

            .tools-sidebar {
                width: 60px; /* عرض کمتر برای ظاهر فشرده‌تر */
                flex-shrink: 0;
                overflow: hidden;
                border-left: 1px solid var(--color-input-border-light);
            }

            .tools-sidebar.is-expanded {
                width: 250px;
            }

            .tools-sidebar .tab-button {
                justify-content: center; /* وسط‌چین کردن آیکون */
                padding: 0.75rem 0; /* معادل p-3 عمودی و p-0 افقی */
            }

            .tools-sidebar.is-expanded .tab-button {
                justify-content: flex-start;
                padding: 1rem; /* بازگرداندن p-4 در حالت باز شده */
            }

            .tools-sidebar .tab-button-content {
                width: 0;
                padding-right: 0;
                opacity: 0;
                white-space: nowrap;
            }
            
            .tools-sidebar.is-expanded .tab-button-content {
                width: auto;
                flex-grow: 1;
                padding-right: 1rem;
                opacity: 1;
            }
        }

        #logout-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .navbar-top.expanded #logout-btn {
            padding: 5px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 5px;
        }

        /* استایل جعبه پیام (برای خطا و موفقیت) */
        #messageBox {
            background-color: #4a5568; /* Gray-700 */
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            min-width: 300px;
        }

        /* استایل صفحه ورود */
        #login-page {
            /* نمایش این بخش توسط جاوااسکریپت کنترل می‌شود */
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            width: 100%;
            min-height: 100vh;
        }

        /* استایل‌های مربوط به چاپ */
        @media print {
            body { display: none; } /* مخفی کردن بدنه اصلی برنامه هنگام چاپ */
        }
        .print-only {
            display: none;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block; }
            body { display: block !important; } /* نمایش مجدد بدنه برای چاپ */

            @page {
                size: A5 landscape;
                margin: 5mm;
            }

            #invoicePreviewContainer {
                display: block !important;
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: 100% !important;
            }
        }
    </style>
</head>
<body>

    <!-- Login Page Container -->
    <div id="login-page" class="w-full p-4">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-2xl shadow-lg border border-gold-dark/20">
            <div class="text-center">
                <img src="logo.png" alt="لوگو" class="w-20 h-20 mx-auto mb-4" onerror="this.style.display='none'">
                <h2 class="text-2xl font-bold text-gold-dark">ورود به حساب کاربری</h2>
                <p class="mt-2 text-sm text-gray-600">لطفا اطلاعات خود را وارد کنید</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="text-sm font-bold text-gray-700 tracking-wide">نام کاربری</label>
                    <input id="username" type="text" class="w-full p-3 mt-2 text-gray-700 bg-input-bg-light rounded-md border border-input-border-light focus:border-gold-accent focus:bg-white focus:outline-none" required>
                </div>
                <div>
                    <label for="password" class="text-sm font-bold text-gray-700 tracking-wide">رمز عبور</label>
                    <input id="password" type="password" class="w-full p-3 mt-2 text-gray-700 bg-input-bg-light rounded-md border border-input-border-light focus:border-gold-accent focus:bg-white focus:outline-none" required>
                </div>
                <div>
                    <button type="submit" class="btn-gold-gradient w-full py-3 rounded-lg font-bold text-lg">
                        ورود
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="navbar-top no-print">
        <div class="navbar-content-wrapper">
            <span>دلار: <strong id="display-dollar-price">--</strong> تومان</span>
            <span>گرم: <strong id="display-gold18k-price">--</strong> تومان</span>
            <span>اونس: <strong id="display-ounce-price">--</strong> دلار</span>
            <span>مثقال: <strong id="display-mesghal-price">--</strong> تومان</span>
            <span>سکه: <strong id="display-sekke-jadid-price">--</strong> تومان</span>
            <span>نیم سکه: <strong id="display-sekke-nim-price">--</strong> تومان</span>
            <span>ربع سکه: <strong id="display-sekke-rob-price">--</strong> تومان</span>
            <span class="last-updated-span">
                <strong id="display-last-updated">--</strong>
            </span>
            <button id="logout-btn" class="text-red-800 font-bold hover:text-red-600 transition-colors">
                <i class="fas fa-sign-out-alt ml-1"></i>خروج
            </button>
        </div>
        <!-- Toggle button for mobile -->
        <button id="navbar-toggle-btn">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>

    <!-- Main Application Container -->
    <div class="main-app-container flex flex-row md:justify-center gap-4 md:gap-10 max-w-7xl mx-auto w-full p-4 md:p-8 rounded-3xl shadow-[0_15px_60px_rgba(0,0,0,0.1)] bg-card-light-bg border border-gold-dark/20 transition-all duration-500 no-print">

        <div class="md:w-1/5 flex flex-col justify-start items-stretch min-w-[unset] md:min-w-[200px] tools-sidebar">
            <div class="flex items-center border-b-2 border-gold-dark pb-2 md:pb-3 mb-4 md:mb-8 flex-shrink-0">
                <button id="tools-toggle-btn" class="md:hidden p-2 text-gold-dark text-xl">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="text-xl md:text-2xl font-bold text-gold-dark tab-button-content flex-grow text-right pr-2">
                    ابزارها
                </h2>
            </div>
            <div id="tools-menu" class="flex flex-col">
                <button id="btn-tab1" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-balance-scale-left text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه وزن طلا</div>
                </button>
                <button id="btn-tab2" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-calculator text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه‌گر جامع</div>
                </button>
                <button id="btn-tab3" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-ring text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه طلای کهنه</div>
                </button>
                <button id="btn-tab6" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-fire text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه آبشده</div>
                </button>
                <button id="btn-tab7" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-coins text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">محاسبه‌گر سکه</div>
                </button>
                <button id="btn-tab4" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-file-invoice-dollar text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">صدور فاکتور</div>
                </button>
                <button id="btn-tab5" class="tab-button group flex items-center p-4 my-1 md:my-2 rounded-xl md:rounded-l-xl md:rounded-r-none border-t-4 md:border-t-0 md:border-r-4 border-transparent transition-all duration-300">
                    <span class="icon-placeholder"><i class="fas fa-gem text-xl md:text-2xl"></i></span>
                    <div class="tab-button-content">مدیریت اجناس</div>
                </button>
            </div>
        </div>

        <div class="w-full md:w-4/5 relative mt-4 md:mt-0 flex-grow min-w-0"> 
            <div id="tab-column1" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه وزن طلا (بر اساس قیمت هدف)
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="price_gram1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نرخ گرم (18):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_gram1" value="" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="goldPurity1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="goldPurity1" list="purity-list" value="750" step="any" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="wage1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">اجرت (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="wage1" value="5" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="profit1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">سود (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="profit1" value="5" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="VAT1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">مالیات (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="VAT1" value="10" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="price_whole1" class="text-sm sm:text-base font-semibold text-dark-text mb-2">قیمت هدف :</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_whole1" value="68,000,000" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                </div>
                <button id="calculateBtn1" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه و ذخیره
                </button>

                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">وزن محاسبه شده: <span id="display-weight1" class="font-bold text-gold-dark">0</span> گرم</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">مالیات بر ارزش افزوده : <span id="display-tax1" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">قیمت قبل از محاسبه مالیات : <span id="display-price-before-tax1" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <button id="invoiceFromCalc1" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>صدور فاکتور برای این محاسبه
                    </button>
                </div>
            </div>

            <div id="tab-column2" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه‌گر جامع
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="price_gram2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نرخ گرم (18):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_gram2" value="" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="goldPurity2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                             <input type="number" id="goldPurity2" list="purity-list" value="750" step="any" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="weight2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="weight2" value="0" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                            <span class="text-gold-dark mr-2 text-sm"></span>
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="wage2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">اجرت (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="wage2" value="20" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="profit2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">سود (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="profit2" value="7" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="VAT2" class="text-sm sm:text-base font-semibold text-dark-text mb-2">مالیات (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="VAT2" value="10" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                </div>
                <button id="calculateBtn2" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه و ذخیره
                </button>

                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">قیمت نهایی: <span id="display-price-after-tax2" class="font-bold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">وزن در عیار 750: <span id="display-adjusted_wheight_to_750" class="font-bold text-gold-dark">0</span> گرم</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">مالیات بر ارزش افزوده: <span id="display-tax2" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">قیمت قبل از محاسبه مالیات: <span id="display-weight2" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">قیمت هر گرم با احتساب اجرت و سود: <span id="display-gram-price-after-tax2" class="font-extrabold text-gold-dark">0</span> تومان</p>
                    <button id="invoiceFromCalc2" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>صدور فاکتور برای این محاسبه
                    </button>
                </div>
            </div>

            <div id="tab-column3" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه طلای کهنه
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="price_gram3" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نرخ گرم (18):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_gram3" value="" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="goldPurity3" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                             <input type="number" id="goldPurity3" list="purity-list" value="750" step="any" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>

                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="weight_input3" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="weight_input3" value="1" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                            <span class="text-gold-dark mr-2 text-sm"></span>
                        </div>
                    </div>
                </div>
                <button id="calculateBtn3" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه و ذخیره
                </button>

                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">قیمت نهایی: <span id="display-total-price3" class="font-bold text-gold-dark">0</span> تومان</p>
                    <button id="invoiceFromCalc3" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>صدور فاکتور برای این محاسبه
                    </button>
                </div>
            </div>
            
            <div id="tab-column6" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه خرید و فروش آبشده
                </h2>
        
                <div class="flex items-center justify-center gap-6 mb-6">
                    <label class="flex items-center gap-2 cursor-pointer text-lg font-semibold">
                        <input type="radio" name="transaction_type6" value="sell" class="form-radio h-5 w-5 text-gold-dark focus:ring-gold-accent" checked>
                        <span>فروش</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-lg font-semibold">
                        <input type="radio" name="transaction_type6" value="buy" class="form-radio h-5 w-5 text-gold-dark focus:ring-gold-accent">
                        <span>خرید</span>
                    </label>
                </div>
        
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label id="price_gram6_label" for="price_gram6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نرخ گرم (۱۸):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="price_gram6" value="" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="goldPurity6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                             <input type="number" id="goldPurity6" list="purity-list" value="750" step="any" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="weight_gram6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن (گرم):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="weight_gram6" value="1" step="0.01" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="profit_melted" class="text-sm sm:text-base font-semibold text-dark-text mb-2">سود (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="profit_melted" value="2" step="0.5" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="VAT6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">مالیات (%):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="number" id="VAT6" value="10" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                    <div id="buyDeductionContainer6" class="responsive-input-group flex-col mb-4 hidden">
                        <label for="buy_deduction6" class="text-sm sm:text-base font-semibold text-dark-text mb-2">کسری خرید (تومان):</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="buy_deduction6" value="100,000" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                        </div>
                    </div>
                </div>
                <button id="calculateBtn6" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه
                </button>
        
                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">قیمت نهایی: <span id="display-total-price6" class="font-bold text-gold-dark">0</span> تومان</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">وزن در عیار 750: <span id="display-adjusted-weight-750-6" class="font-bold text-gold-dark">0</span> گرم</p>
                    <p class="text-sm sm:text-base mb-1 sm:mb-2 text-dark-text">مالیات بر ارزش افزوده: <span id="display-tax-6" class="font-extrabold text-gold-dark">0</span> تومان</p>
                </div>

                <button id="invoiceFromCalc6" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>صدور فاکتور برای این محاسبه
                </button>
            </div>

            <div id="tab-column7" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    محاسبه‌گر خرید و فروش سکه
                </h2>
        
                <div class="flex items-center justify-center gap-6 mb-6">
                    <label class="flex items-center gap-2 cursor-pointer text-lg font-semibold">
                        <input type="radio" name="transaction_type7" value="sell" class="form-radio h-5 w-5 text-gold-dark focus:ring-gold-accent" checked>
                        <span>فروش</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-lg font-semibold">
                        <input type="radio" name="transaction_type7" value="buy" class="form-radio h-5 w-5 text-gold-dark focus:ring-gold-accent">
                        <span>خرید</span>
                    </label>
                </div>
        
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="coin_type7" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نوع سکه:</label>
                        <select id="coin_type7" class="w-full p-2 sm:p-3 rounded-md border bg-input-bg-light text-dark-text border-input-border-light">
                            <option value="sekke_jadid">سکه تمام (جدید)</option>
                            <option value="sekke_ghadim">سکه تمام (قدیم)</option>
                            <option value="sekke_nim">نیم سکه</option>
                            <option value="sekke_rob">ربع سکه</option>
                            <option value="sekke_gerami">سکه گرمی</option>
                            <option value="parsian">پارسیان</option>
                        </select>
                    </div>
                    <div id="parsian_weight_container7" class="responsive-input-group flex flex-col mb-4 hidden">
                        <label for="parsian_weight7" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن پارسیان (گرم):</label>
                        <input type="number" id="parsian_weight7" value="1" step="0.01" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="coin_quantity7" class="text-sm sm:text-base font-semibold text-dark-text mb-2">تعداد:</label>
                        <input type="number" id="coin_quantity7" value="1" min="1" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="coin_price7" class="text-sm sm:text-base font-semibold text-dark-text mb-2">قیمت واحد (تومان):</label>
                        <input type="text" id="coin_price7" oninput="App.Utils.formatNumberInput(this)" class="w-full p-2 sm:p-3 rounded-md border text-left text-sm bg-input-bg-light text-dark-text border-input-border-light">
                    </div>
                </div>
                <button id="calculateBtn7" class="btn-gold-gradient w-full py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold mt-4 sm:mt-6">
                    محاسبه
                </button>
        
                <div class="results mt-4 sm:mt-6 p-3 sm:p-5 bg-results-bg rounded-lg border border-results-border">
                    <p class="highlighted-result">مبلغ کل: <span id="display-total-price7" class="font-bold text-gold-dark">0</span> تومان</p>
                </div>

                <button id="invoiceFromCalc7" class="btn-gold-gradient w-full py-2 rounded-lg text-sm font-bold mt-4 hidden">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>افزودن به فاکتور
                </button>
            </div>
            
            <div id="tab-column4" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    صدور فاکتور طلا
                </h2>

                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">مشخصات مشتری</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="responsive-input-group flex flex-col mb-4">
                            <label for="customerName" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نام و نام خانوادگی:</label>
                            <div class="input-wrapper flex-1 flex items-center w-full">
                                <input type="text" id="customerName" class="w-full p-2 rounded-md border text-right bg-input-bg-light border-input-border-light text-sm">
                            </div>
                        </div>
                        <div class="responsive-input-group flex flex-col mb-4">
                            <label for="customerPhone" class="text-sm sm:text-base font-semibold text-dark-text mb-2">شماره تماس:</label>
                            <div class="input-wrapper flex-1 flex items-center w-full">
                                <input type="text" id="customerPhone" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm" placeholder="مثال: 09121234567">
                            </div>
                        </div>
                        <div class="responsive-input-group flex flex-col mb-4">
                            <label for="invoiceDate" class="text-sm sm:text-base font-semibold text-dark-text mb-2">تاریخ فاکتور:</label>
                            <div class="input-wrapper flex-1 flex items-center w-full">
                                <input type="text" id="invoiceDate" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm" placeholder="به صورت خودکار تکمیل می شود" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">تنظیمات پیش‌فرض فاکتور</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="responsive-input-group flex flex-col">
                            <label for="invoiceProfit" class="text-sm sm:text-base font-semibold text-dark-text mb-2">سود پیش‌فرض (%):</label>
                            <input type="number" id="invoiceProfit" value="7" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="invoiceVAT" class="text-sm sm:text-base font-semibold text-dark-text mb-2">مالیات پیش‌فرض (%):</label>
                            <input type="number" id="invoiceVAT" value="10" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark flex justify-between items-center">
                        جزئیات اقلام طلا
                        <button id="addGoldItemBtn" class="px-4 py-2 text-white rounded-md text-sm hover:bg-gold-dark transition-colors inline-flex items-center justify-center" style="background-color: var(--color-gold-accent);">
                            <i class="fas fa-plus ml-1"></i>افزودن آیتم
                        </button>
                    </h3>
                    <div id="goldItemsContainer" class="p-2">
                    </div>
                </div>

                <div id="invoiceSummary" class="mt-6 p-4 border rounded-lg bg-results-bg border-results-border">
                    <h3 class="text-lg font-semibold mb-3 text-gold-dark">خلاصه فاکتور</h3>
                    <div class="space-y-2">
                        <p class="text-dark-text flex justify-between"><span>جمع کل فروش:</span> <strong id="summaryTotalSales" class="text-gold-dark">0 تومان</strong></p>
                        <p class="text-dark-text flex justify-between"><span>جمع کل خرید:</span> <strong id="summaryTotalPurchases" class="text-gold-dark">0 تومان</strong></p>
                        <hr class="my-2">
                        <p class="text-dark-text flex justify-between text-xl">
                            <span id="summaryFinalAmountLabel">مبلغ نهایی پرداختی:</span>
                            <strong id="summaryFinalAmount" class="text-gold-dark">0 تومان</strong>
                        </p>
                    </div>
                </div>

                <div class="flex gap-4 mt-4 sm:mt-6 no-print">
                    <button id="generateInvoiceBtn" class="btn-gold-gradient flex-1 py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold">
                        صدور و پیش‌نمایش فاکتور
                    </button>
                    <button id="printInvoiceBtn" class="hidden flex-1 py-2 sm:py-3 rounded-lg text-sm sm:text-base font-bold text-white bg-green-600 hover:bg-green-700 transition-colors">
                        <i class="fas fa-print mr-2"></i>چاپ
                    </button>
                </div>
                <div id="invoicePreviewContainerWrapper" class="hidden mt-6">
                         <h3 class="text-lg font-semibold mb-3 text-gold-dark">پیش‌نمایش فاکتور (سایز A5 Landscape)</h3>
                         <div id="invoicePreviewContainer" class="p-4 bg-white border border-gray-300 rounded-lg shadow-lg mx-auto" style="width: 210mm; min-height: 148mm; box-sizing: border-box;">
                                 </div>
                </div>
            </div>

            <div id="tab-column5" class="tab-content p-2 sm:p-4">
                <h2 class="text-lg sm:text-xl font-bold mb-4 sm:mb-6 text-gold-dark border-b border-gold-dark pb-2 sm:pb-3">
                    مدیریت اجناس (آفلاین)
                </h2>

                <div id="product-form-container" class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 id="product-form-title" class="text-lg font-semibold mb-3 text-gold-dark">افزودن جنس جدید</h3>
                    <form id="product-form">
                        <input type="hidden" id="productId">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="responsive-input-group flex flex-col mb-4">
                                <label for="productName" class="text-sm sm:text-base font-semibold text-dark-text mb-2">نام/شرح کالا:</label>
                                <div class="input-wrapper flex-1 flex items-center w-full">
                                    <input type="text" id="productName" required class="w-full p-2 rounded-md border text-right bg-input-bg-light border-input-border-light text-sm">
                                </div>
                            </div>
                            <div class="responsive-input-group flex flex-col mb-4">
                                <label for="productWeight" class="text-sm sm:text-base font-semibold text-dark-text mb-2">وزن:</label>
                                <div class="input-wrapper flex-1 flex items-center w-full">
                                    <input type="number" id="productWeight" step="0.01" required class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                                </div>
                            </div>
                            <div class="responsive-input-group flex flex-col mb-4">
                                <label for="productPurity" class="text-sm sm:text-base font-semibold text-dark-text mb-2">عیار:</label>
                                <div class="input-wrapper flex-1 flex items-center w-full">
                                    <input type="number" id="productPurity" list="purity-list" value="750" step="any" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                                </div>
                            </div>
                            <div class="responsive-input-group flex flex-col mb-4">
                                <label for="productWage" class="text-sm sm:text-base font-semibold text-dark-text mb-2">اجرت (%):</label>
                                <div class="input-wrapper flex-1 flex items-center w-full">
                                    <input type="number" id="productWage" value="20" class="w-full p-2 rounded-md border text-left bg-input-bg-light border-input-border-light text-sm">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-4">
                            <button type="submit" class="btn-gold-gradient py-2 rounded-lg text-sm font-bold flex-1">
                                <i class="fas fa-save mr-2"></i><span id="product-form-submit-btn-text">ذخیره جنس</span>
                            </button>
                            <button type="button" id="cancelEditBtn" class="hidden py-2 px-4 rounded-lg text-sm font-bold bg-gray-400 text-white hover:bg-gray-500 transition-colors">
                                <i class="fas fa-times mr-2"></i>لغو ویرایش
                            </button>
                        </div>
                    </form>
                </div>

                <div class="p-4 border rounded-lg bg-gray-50">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-gold-dark">لیست اجناس ذخیره شده</h3>
                        <div class="flex gap-2">
                            <button id="import-btn" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors inline-flex items-center justify-center">
                                <i class="fas fa-file-import ml-2"></i>وارد کردن
                            </button>
                            <button id="export-btn" class="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors inline-flex items-center justify-center">
                                <i class="fas fa-file-excel ml-2"></i>خروجی اکسل
                            </button>
                        </div>
                    </div>
                    <div class="responsive-input-group flex flex-col mb-4">
                        <label for="productSearch" class="text-sm sm:text-base font-semibold text-dark-text mb-2">جستجو بر اساس نام:</label>
                        <div class="input-wrapper flex-1 flex items-center w-full">
                            <input type="text" id="productSearch" class="w-full p-2 rounded-md border text-right bg-input-bg-light border-input-border-light text-sm" placeholder="نام کالا را وارد کنید...">
                        </div>
                    </div>
                    <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <p id="no-products-message" class="col-span-full text-center text-gray-500">هیچ جنسی ذخیره نشده است.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="messageBox" class="hidden">
    </div>
    
    <div id="print-area" class="print-only"></div>
    <input type="file" id="import-file-input" class="hidden" accept=".csv">


    <datalist id="purity-list">
        <option value="750">18 عیار</option>
        <option value="583.3">14 عیار</option>
        <option value="708.3">17 عیار</option>
        <option value="791.6">19 عیار</option>
        <option value="875">21 عیار</option>
        <option value="916">22 عیار</option>
        <option value="999.9">24 عیار</option>
    </datalist>

<script>
    // آبجکت اصلی برنامه برای سازماندهی کد
    const App = {
        appLogicInitialized: false, // فلگ برای جلوگیری از اجرای چندباره‌ی منطق برنامه
        liveGoldPrice18k: 0,
        liveMesghalPrice: 0,
        livePrices: {}, // Store all live prices
        userModifiedPrices: {},

        Auth: { // مدیریت احراز هویت، ورود و خروج کاربر

            SECRET_SALT: 'fghfgjkfggirokdldd545gregd546fg4rgfg45sg5g4rs6f5dsrg46sd45h5j4ukiu5!@#',                         
            CORRECT_USERNAME_HASH: '905c26e1ffc9dfd6f34d48c9534033db3b914204bd7af7d3f50c8f1856aa5fe5',
            CORRECT_PASSWORD_HASH: 'ded0a1a73e6dbceb9db5c9e62ef553c30ab3f94c857c4a582d3af80e5b4572d8',

            async hashString(str) {
                const textAsBuffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', textAsBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },

            init: function() {
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                this.checkSession();
            },

            handleLogin: async function() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                const usernameHash = await this.hashString(username + this.SECRET_SALT);
                const passwordHash = await this.hashString(password + this.SECRET_SALT);

                if (usernameHash === this.CORRECT_USERNAME_HASH && passwordHash === this.CORRECT_PASSWORD_HASH) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    this.showApp();
                } else {
                    App.UI.showMessage('نام کاربری یا رمز عبور اشتباه است.');
                }
            },
            
            handleLogout: function() {
                sessionStorage.removeItem('isLoggedIn');
                location.reload(); // ساده‌ترین راه برای ریست کردن برنامه و نمایش صفحه ورود
            },

            checkSession: function() {
                if (sessionStorage.getItem('isLoggedIn') === 'true') {
                    this.showApp();
                } else {
                    this.showLogin();
                }
            },

            showLogin: function() {
                document.body.classList.remove('app-view');
                document.getElementById('login-page').style.display = 'flex';
                document.querySelector('.main-app-container').style.display = 'none';
                document.querySelector('.navbar-top').style.display = 'none';
            },

            showApp: function() {
                document.body.classList.add('app-view');
                document.getElementById('login-page').style.display = 'none';
                document.querySelector('.main-app-container').style.display = 'flex';
                document.querySelector('.navbar-top').style.display = 'flex';
                
                // منطق اصلی برنامه فقط یک بار پس از ورود موفق اجرا می‌شود
                if (!App.appLogicInitialized) {
                    App.initAppLogic();
                    App.appLogicInitialized = true;
                }
            }
        },

        DB: { // مدیریت پایگاه داده آفلاین (IndexedDB) برای ذخیره اجناس
            db: null,
            initDB: function() {
                const request = window.indexedDB.open('SiminGoldDB', 2);

                request.onerror = (event) => {
                    console.error("خطا در باز کردن IndexedDB:", event.target.error);
                    App.UI.showMessage("خطا در دسترسی به حافظه آفلاین. امکان ذخیره اجناس وجود ندارد.");
                };

                request.onupgradeneeded = (event) => {
                    this.db = event.target.result;
                    console.log("در حال ساخت یا بروزرسانی آبجکت استور...");
                    if (!this.db.objectStoreNames.contains('products')) {
                        const objectStore = this.db.createObjectStore("products", { keyPath: "id", autoIncrement: true });
                        objectStore.createIndex("name", "name", { unique: false });
                        console.log("آبجکت استور 'products' با موفقیت ساخته شد.");
                    }
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    console.log("اتصال به IndexedDB با موفقیت برقرار شد.");
                    this.renderProducts();
                };
            },

            saveProduct: function(product) {
                if (!this.db) {
                    App.UI.showMessage("اتصال به پایگاه داده برقرار نیست.");
                    return;
                }
                const transaction = this.db.transaction(["products"], "readwrite");
                const objectStore = transaction.objectStore("products");
                const request = product.id ? objectStore.put(product) : objectStore.add(product);
                
                request.onsuccess = () => {
                    this.renderProducts();
                };
                
                request.onerror = (event) => {
                    console.error("خطا در ذخیره جنس:", event.target.error);
                    App.UI.showMessage("خطا در ذخیره جنس.");
                };
            },
            
            getProduct: function(id, callback) {
                if (!this.db) return;
                const transaction = this.db.transaction(["products"], "readonly");
                const objectStore = transaction.objectStore("products");
                const request = objectStore.get(id);

                request.onsuccess = (event) => {
                    if(callback) callback(event.target.result);
                };
                 request.onerror = (event) => {
                    console.error(`خطا در گرفتن جنس با ID ${id}:`, event.target.error);
                };
            },
            
            deleteProduct: function(id) {
                if (!this.db) return;
                const transaction = this.db.transaction(["products"], "readwrite");
                const objectStore = transaction.objectStore("products");
                const request = objectStore.delete(id);

                request.onsuccess = () => {
                    App.UI.showMessage("جنس با موفقیت حذف شد.", 'success');
                    this.renderProducts();
                };
                
                request.onerror = (event) => {
                    console.error(`خطا در حذف جنس با ID ${id}:`, event.target.error);
                    App.UI.showMessage("خطا در حذف جنس.");
                };
            },

            renderProducts: function(productsToRender = null) {
                const productListDiv = document.getElementById('productList');
                const noProductsMessage = document.getElementById('no-products-message');
                productListDiv.innerHTML = ''; 

                const display = (products) => {
                    if (products.length === 0) {
                        productListDiv.appendChild(noProductsMessage);
                        noProductsMessage.classList.remove('hidden');
                        return;
                    }
                    noProductsMessage.classList.add('hidden');
                    products.forEach(product => {
                        const card = `
                            <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200 flex flex-col gap-2">
                                <p class="font-bold text-lg">${product.name}</p>
                                <p class="text-sm"><strong>وزن:</strong> ${product.weight}</p>
                                <p class="text-sm"><strong>عیار:</strong> ${product.purity}</p>
                                <p class="text-sm"><strong>اجرت:</strong> ${product.wage}%</p>
                                <div class="flex gap-2 mt-2">
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors flex-1 text-center bg-blue-500 hover:bg-blue-600" data-id="${product.id}" data-action="edit">ویرایش</button>
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors flex-1 text-center bg-red-500 hover:bg-red-600" data-id="${product.id}" data-action="delete">حذف</button>
                                    <button class="px-3 py-1 text-xs rounded-md text-white transition-colors flex-1 text-center bg-green-500 hover:bg-green-600" data-id="${product.id}" data-action="use">استفاده در فاکتور</button>
                                </div>
                            </div>
                        `;
                        productListDiv.insertAdjacentHTML('beforeend', card);
                    });
                };
                
                if (productsToRender) {
                    display(productsToRender);
                } else {
                    if (!this.db) return;
                    const transaction = this.db.transaction(["products"], "readonly");
                    const objectStore = transaction.objectStore("products");
                    const request = objectStore.getAll();
                    
                    request.onsuccess = (event) => {
                        display(event.target.result);
                    };
                    request.onerror = (event) => {
                        console.error("خطا در خواندن اجناس:", event.target.error);
                    };
                }
            },
            
            searchProducts: function(query) {
                if (!this.db) return;
                const transaction = this.db.transaction(["products"], "readonly");
                const objectStore = transaction.objectStore("products");
                
                if (query.trim() === '') {
                    this.renderProducts();
                    return;
                }
                
                const request = objectStore.getAll();
                request.onsuccess = (event) => {
                    const allProducts = event.target.result;
                    const filteredProducts = allProducts.filter(p => p.name.includes(query));
                    this.renderProducts(filteredProducts);
                };

                 request.onerror = (event) => {
                    console.error("خطا در جستجو:", event.target.error);
                };
            },
            exportToExcel: function() {
                if (!this.db) {
                    App.UI.showMessage("اتصال به پایگاه داده برقرار نیست.");
                    return;
                }
                const transaction = this.db.transaction(["products"], "readonly");
                const objectStore = transaction.objectStore("products");
                const request = objectStore.getAll();

                request.onsuccess = (event) => {
                    const products = event.target.result;
                    if (products.length === 0) {
                        App.UI.showMessage("هیچ جنسی برای خروجی گرفتن وجود ندارد.");
                        return;
                    }

                    const headers = ["ID", "نام کالا", "وزن", "عیار", "اجرت (%)"];
                    let csvContent = headers.join(",") + "\n";

                    products.forEach(product => {
                        // برای جلوگیری از خطا، نام محصولی که کاما دارد داخل کوتیشن قرار می‌گیرد
                        const productName = `"${product.name.replace(/"/g, '""')}"`;
                        const row = [product.id, productName, product.weight, product.purity, product.wage];
                        csvContent += row.join(",") + "\n";
                    });

                    // Create a Blob with UTF-8 BOM for Excel compatibility with Persian characters
                    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", "products-backup.csv");
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                };

                request.onerror = (event) => {
                    console.error("خطا در خواندن اطلاعات برای خروجی:", event.target.error);
                    App.UI.showMessage("خطا در تهیه خروجی اکسل.");
                };
            },
            importFromCSV: function(file) {
                if (!file) {
                    App.UI.showMessage("فایلی انتخاب نشده است.");
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    const csv = event.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    if (lines.length <= 1) {
                        App.UI.showMessage("فایل خالی است یا فرمت صحیحی ندارد.");
                        return;
                    }
                    
                    // Skip header, process rows
                    const productsToImport = lines.slice(1).map(line => {
                        // پارس کردن ساده CSV؛ ممکن است موارد خاص مثل کاما داخل کوتیشن را به درستی مدیریت نکند
                        const values = line.split(',');
                        // ستون‌های مورد انتظار: شناسه، نام، وزن، عیار، اجرت
                        if (values.length < 5) return null;
                        
                        const product = {
                            name: values[1].replace(/"/g, ''), // Remove quotes
                            weight: parseFloat(values[2]),
                            purity: parseInt(values[3], 10),
                            wage: parseFloat(values[4])
                        };
                        
                        // Basic validation
                        if (isNaN(product.weight) || isNaN(product.purity) || isNaN(product.wage)) {
                            console.warn("Skipping invalid row:", line);
                            return null;
                        }
                        return product;
                    }).filter(p => p !== null);

                    if(productsToImport.length > 0) {
                        productsToImport.forEach(p => this.saveProduct(p));
                        App.UI.showMessage(`${productsToImport.length} جنس با موفقیت وارد شد.`, 'success');
                    } else {
                        App.UI.showMessage("هیچ جنس معتبری در فایل یافت نشد.");
                    }
                };
                reader.readAsText(file);
            }
        },

        Utils: { // مجموعه توابع کاربردی و عمومی
            formatNumber: (number) => new Intl.NumberFormat('en-US').format(number),
            unformatNumber: (string) => parseFloat(String(string).replace(/,/g, '')) || 0,
            formatNumberInput: function(input) {
                let value = input.value.replace(/,/g, '');
                if (!isNaN(value) && value.trim() !== '') {
                    input.value = this.formatNumber(value);
                }
            },
            getInputValue: function(id, defaultValue = 0) {
                const element = document.getElementById(id);
                if (!element) return defaultValue;
                if (element.tagName === 'SELECT') return element.value || defaultValue;
                const value = element.type.startsWith('text') ? this.unformatNumber(element.value) : parseFloat(element.value);
                return isNaN(value) ? defaultValue : value;
            },
            setInputValueAndLocalStorage: function(id, value) {
                const element = document.getElementById(id);
                if (!element) return;
                if (element.type.startsWith('text') && (id.includes('price_gram') || id.includes('price_whole') || id.includes('price_mesghal') || id.includes('buy_deduction') || id.includes('coin_price'))) {
                    element.value = this.formatNumber(value);
                } else {
                    element.value = value;
                }
                localStorage.setItem(id, value);
            },
            loadValuesFromLocalStorage: function() {
                const inputs = [
                    'price_whole1', 'wage1', 'profit1', 'VAT1', 'price_gram1', 'goldPurity1',
                    'weight2', 'wage2', 'profit2', 'VAT2', 'price_gram2', 'goldPurity2',
                    'weight_input3', 'price_gram3', 'goldPurity3',
                    'price_gram6', 'weight_gram6', 'goldPurity6', 'profit_melted', 'buy_deduction6', 'VAT6',
                    'customerName', 'customerPhone', 'invoiceProfit', 'invoiceVAT'
                ];
                inputs.forEach(id => {
                    const savedValue = localStorage.getItem(id);
                    if (savedValue !== null) {
                        const element = document.getElementById(id);
                        if (element) {
                            if (element.type.startsWith('text') && (id.includes('price_gram') || id.includes('price_whole') || id.includes('price_mesghal') || id.includes('buy_deduction'))) {
                                element.value = this.formatNumber(parseFloat(savedValue));
                            } else {
                                element.value = savedValue;
                            }
                        }
                    }
                });
                // Restore radio button state for melted gold calculator
                const savedTransactionType = localStorage.getItem('transaction_type6');
                if (savedTransactionType) {
                    const radioBtn = document.querySelector(`input[name="transaction_type6"][value="${savedTransactionType}"]`);
                    if (radioBtn) radioBtn.checked = true;
                }
            },
            generateUniqueId: () => 'item_' + Date.now() + Math.floor(Math.random() * 1000)
        },

        UI: { // مدیریت رابط کاربری، نمایش تب‌ها، دریافت قیمت‌ها و پیام‌ها
            showMessage: function(message, type = 'error') {
                const msgBox = document.getElementById('messageBox');
                let bgColor = type === 'success' ? '#2f855a' : '#c53030'; // green-700 or red-700
                msgBox.style.backgroundColor = bgColor;
                msgBox.innerHTML = `<p>${message}</p><button class="mt-4 px-4 py-2 bg-black bg-opacity-20 rounded hover:bg-opacity-30 transition-colors">بستن</button>`;
                msgBox.classList.remove('hidden');
                msgBox.querySelector('button').onclick = () => msgBox.classList.add('hidden');
            },
            
            showConfirmation: function(message, onConfirm) {
                const msgBox = document.getElementById('messageBox');
                msgBox.style.backgroundColor = '#4a5568'; // gray-700
                msgBox.innerHTML = `
                    <p>${message}</p>
                    <div class="flex justify-center gap-4 mt-4">
                        <button id="confirmBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors">بله، حذف کن</button>
                        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors">لغو</button>
                    </div>
                `;
                msgBox.classList.remove('hidden');
                document.getElementById('confirmBtn').onclick = () => {
                    onConfirm();
                    msgBox.classList.add('hidden');
                };
                document.getElementById('cancelBtn').onclick = () => {
                    msgBox.classList.add('hidden');
                };
            },

            showTab: function(tabId) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                
                const content = document.getElementById(tabId);
                const buttonId = tabId.replace('tab-column', 'btn-tab');
                const button = document.getElementById(buttonId);
                
                if (content) content.classList.add('active');
                if (button) button.classList.add('active');

                if (tabId === 'tab-column4') {
                    App.Invoice.setCurrentInvoiceDate();
                    App.Invoice.updateAllItemPrices();
                }
            },

            fetchLivePrices: async function() {
                const CF_WORKER_URL = 'https://gold.sprome.workers.dev/latest';
                let data = null;
                let fetchedFrom = "";

                try {
                    const response = await fetch(CF_WORKER_URL, { signal: AbortSignal.timeout(10000) });
                    if (!response.ok) throw new Error('Network response was not ok.');
                    data = await response.json();
                    fetchedFrom = "";
                } catch (error) {
                    console.error("Could not fetch prices from primary source:", error);
                    App.UI.showMessage("خطا در دریافت قیمت‌های لحظه‌ای.");
                    return;
                }

                if (!data) return;
                
                App.liveGoldPrice18k = data.gold_18k_toman > 0 ? data.gold_18k_toman : 0;
                App.liveMesghalPrice = data.gold_mesghal_toman > 0 ? data.gold_mesghal_toman : 0;
                App.livePrices = {
                    sekke_jadid: data.sekke_jadid_toman,
                    sekke_nim: data.sekke_nim_toman,
                    sekke_rob: data.sekke_rob_toman
                };
                
                this.updateNavbarPrices(data, fetchedFrom);
                this.updateCalculatorPrices();
                
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id.startsWith('tab-column')) {
                    const calcId = activeTab.id.replace('tab-column', 'column');
                     if(App.Calculators[`calculate${calcId}`]) {
                         App.Calculators[`calculate${calcId}`]();
                     }
                }
            },
            
            updateNavbarPrices: function(data, source) {
                const U = App.Utils;
                const updateDisplay = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value !== undefined && !isNaN(value) ? U.formatNumber(Math.round(value)) : '--';
                };
                
                updateDisplay('display-dollar-price', data.dollar_toman/10);
                updateDisplay('display-gold18k-price', data.gold_18k_toman);
                updateDisplay('display-ounce-price', data.gold_ounce_dollar);
                updateDisplay('display-mesghal-price', data.gold_mesghal_toman);
                updateDisplay('display-sekke-jadid-price', data.sekke_jadid_toman);
                updateDisplay('display-sekke-nim-price', data.sekke_nim_toman);
                updateDisplay('display-sekke-rob-price', data.sekke_rob_toman);

                const updatedEl = document.getElementById('display-last-updated');
                if (updatedEl && data.timestamp) {
                    const date = new Date(data.timestamp);
                    const formattedTime = new Intl.DateTimeFormat('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Tehran', numberingSystem: 'arab' }).format(date);
                    updatedEl.textContent = ` ${formattedTime} ${source}`;
                }
            },

            updateCalculatorPrices: function() {
                if (App.liveGoldPrice18k > 0) {
                    ['1', '2', '3', '6'].forEach(i => {
                        const priceInputId = `price_gram${i}`;
                        if (!App.userModifiedPrices[priceInputId]) {
                            const element = document.getElementById(priceInputId);
                            if (element) {
                                element.value = App.Utils.formatNumber(App.liveGoldPrice18k);
                            }
                        }
                    });
                }
                App.Calculators.updateCoinPrice(); // به‌روزرسانی قیمت در ماشین‌حساب سکه
                App.Invoice.updateAllItemPrices();
            }
        },

        Calculators: { // منطق مربوط به تمام ماشین‌حساب‌ها
             recalculate: function(id) {
                const calcId = id || document.querySelector('.tab-content.active').id.replace('tab-column', 'column');
                if(this[`calculate${calcId}`]) this[`calculate${calcId}`]();
             },
             calculatecolumn1: function() {
                const U = App.Utils;
                const profit = U.getInputValue('profit1');
                const wage = U.getInputValue('wage1');
                const VAT_rate = U.getInputValue('VAT1');
                const price_gram_18k_input = U.getInputValue('price_gram1');
                const price_whole = U.getInputValue('price_whole1');
                const purity = U.getInputValue('goldPurity1');

                const adjusted_price_gram = price_gram_18k_input * (purity / 750);

                const labor_cost_factor = wage / 100;
                const profit_markup_factor = profit / 100;
                const tax_factor = VAT_rate / 100;
                
                const total_factor = (1 + labor_cost_factor) * (1 + profit_markup_factor);
                const tax_base = (labor_cost_factor + (1 + labor_cost_factor) * profit_markup_factor);
                const final_factor = total_factor + (tax_base * tax_factor);
                
                const calculated_weight = price_whole / (adjusted_price_gram * final_factor);
                const rounded_weight = parseFloat(calculated_weight.toFixed(2));
                
                const price_before_tax = rounded_weight * adjusted_price_gram * total_factor;
                const tax_amount = (rounded_weight * adjusted_price_gram * tax_base) * tax_factor;

                document.getElementById('display-weight1').textContent = U.formatNumber(rounded_weight);
                document.getElementById('display-tax1').textContent = U.formatNumber(Math.round(tax_amount));
                document.getElementById('display-price-before-tax1').textContent = U.formatNumber(Math.round(price_before_tax));
                
                if (rounded_weight > 0) {
                    document.getElementById('invoiceFromCalc1').classList.remove('hidden');
                }
             },
             calculatecolumn2: function() {
                const U = App.Utils;
                const weight = U.getInputValue('weight2');
                const price_gram_18k = U.getInputValue('price_gram2');
                const wage = U.getInputValue('wage2');
                const profit = U.getInputValue('profit2');
                const VAT_rate = U.getInputValue('VAT2');
                const purity = U.getInputValue('goldPurity2');
                const adjusted_weight_to_750 = weight * (purity / 750);
                const adjusted_price_gram = price_gram_18k * (purity / 750);
                
                const price_of_gold = weight * adjusted_price_gram;
                const labor_cost = price_of_gold * (wage / 100);
                const profit_amount = (price_of_gold + labor_cost) * (profit / 100);
                const tax_base = labor_cost + profit_amount;
                const tax_amount = tax_base * (VAT_rate / 100);
                
                const price_before_tax = price_of_gold + tax_base;
                const final_price = price_before_tax + tax_amount;
                const final_price_per_gram = final_price / weight;
                
                document.getElementById('display-price-after-tax2').textContent = U.formatNumber(Math.round(final_price));
                document.getElementById('display-adjusted_wheight_to_750').textContent = U.formatNumber((adjusted_weight_to_750));
                document.getElementById('display-tax2').textContent = U.formatNumber(Math.round(tax_amount));
                document.getElementById('display-weight2').textContent = U.formatNumber(Math.round(price_before_tax));
                document.getElementById('display-gram-price-after-tax2').textContent = isFinite(final_price_per_gram) ? U.formatNumber(Math.round(final_price_per_gram)) : '0';

                if (weight > 0) {
                    document.getElementById('invoiceFromCalc2').classList.remove('hidden');
                }
             },
             calculatecolumn3: function() {
                const U = App.Utils;
                const weight = U.getInputValue('weight_input3');
                const price_gram_18k = U.getInputValue('price_gram3');
                const purity = U.getInputValue('goldPurity3');

                const adjusted_price_gram = price_gram_18k * (purity / 750) * (735 / 750);
                
                const final_price = weight * adjusted_price_gram;
                document.getElementById('display-total-price3').textContent = U.formatNumber(Math.round(final_price));
                
                if (weight > 0) {
                    document.getElementById('invoiceFromCalc3').classList.remove('hidden');
                }
             },
            calculatecolumn6: function() {
                const U = App.Utils;
                const weight_in_grams = U.getInputValue('weight_gram6');
                const price_input = U.getInputValue('price_gram6'); 
                const actual_purity = U.getInputValue('goldPurity6', 750);
                const transactionType = document.querySelector('input[name="transaction_type6"]:checked').value;

                const resultDisplay = document.getElementById('display-total-price6');
                const adjustedWeightDisplay = document.getElementById('display-adjusted-weight-750-6');
                const taxDisplay = document.getElementById('display-tax-6');
                const invoiceBtn = document.getElementById('invoiceFromCalc6');

                if (price_input <= 0 || weight_in_grams <= 0 || actual_purity <= 0) {
                    resultDisplay.textContent = '0';
                    adjustedWeightDisplay.textContent = '0';
                    taxDisplay.textContent = '0';
                    invoiceBtn.classList.add('hidden');
                    return;
                }

                const adjusted_weight_to_750 = weight_in_grams * (actual_purity / 750);
                adjustedWeightDisplay.textContent = U.formatNumber(adjusted_weight_to_750.toFixed(3));

                let final_price = 0;
                let tax_amount = 0;

                if (transactionType === 'sell') {
                    const profit_for_melted = U.getInputValue('profit_melted');
                    const VAT_rate = U.getInputValue('VAT6');
                    const price_of_gold = weight_in_grams * (price_input * (actual_purity / 750));
                    const profit_amount = price_of_gold * (profit_for_melted / 100);
                    tax_amount = profit_amount * (VAT_rate / 100);
                    final_price = price_of_gold + profit_amount + tax_amount;
                } else { // 'buy'
                    const buy_deduction_toman = U.getInputValue('buy_deduction6');
                    const effective_price_per_gram_18k = price_input - (buy_deduction_toman / 4.3318);
                    const final_adjusted_price_per_gram = effective_price_per_gram_18k * (actual_purity / 750);
                    final_price = weight_in_grams * final_adjusted_price_per_gram;
                    tax_amount = 0;
                }
                
                resultDisplay.textContent = U.formatNumber(Math.round(final_price));
                taxDisplay.textContent = U.formatNumber(Math.round(tax_amount));
                
                if (final_price > 0) {
                    invoiceBtn.classList.remove('hidden');
                } else {
                    invoiceBtn.classList.add('hidden');
                }
            },
            updateCoinPrice: function() {
                const U = App.Utils;
                const coinType = U.getInputValue('coin_type7');
                const coinPriceInput = document.getElementById('coin_price7');
                const parsianWeightContainer = document.getElementById('parsian_weight_container7');

                parsianWeightContainer.classList.toggle('hidden', coinType !== 'parsian');

                if (coinType === 'parsian') {
                    // For Parsian, price is based on 18k gold rate, so we clear the manual price input
                    coinPriceInput.value = U.formatNumber(App.liveGoldPrice18k);
                    coinPriceInput.previousElementSibling.textContent = 'نرخ گرم طلا (تومان):';
                } else {
                    coinPriceInput.previousElementSibling.textContent = 'قیمت واحد (تومان):';
                    if (App.livePrices[coinType]) {
                        coinPriceInput.value = U.formatNumber(App.livePrices[coinType]);
                    } else {
                        coinPriceInput.value = '0'; // For types not in live data like gerami/ghadim
                    }
                }
                this.calculatecolumn7();
            },
            calculatecolumn7: function() {
                const U = App.Utils;
                const coinType = U.getInputValue('coin_type7');
                const quantity = U.getInputValue('coin_quantity7');
                const price = U.getInputValue('coin_price7');

                let total_price = 0;

                if (coinType === 'parsian') {
                    const weight = U.getInputValue('parsian_weight7');
                    const goldRate = price; // For parsian, the price input holds the gold rate
                    total_price = weight * goldRate * quantity;
                } else {
                    total_price = quantity * price;
                }

                document.getElementById('display-total-price7').textContent = U.formatNumber(Math.round(total_price));
                
                const invoiceBtn = document.getElementById('invoiceFromCalc7');
                if (total_price > 0) {
                    invoiceBtn.classList.remove('hidden');
                } else {
                    invoiceBtn.classList.add('hidden');
                }
            }
        },

        Invoice: { // مدیریت کامل فرآیند صدور فاکتور
            recalculate: function() { this.updateTotal(); },
            setCurrentInvoiceDate: function() {
                const el = document.getElementById('invoiceDate');
                if (el && !el.value) {
                    const now = new Date();
                    const persianDate = new Intl.DateTimeFormat('fa-IR-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit', calendar: 'persian' }).format(now);
                    el.value = persianDate;
                }
            },
            updateAllItemPrices: function() {
                document.querySelectorAll('.gold-item-row').forEach(row => {
                    const itemId = row.dataset.itemId;
                    const priceInputId = `itemGramPrice_${itemId}`;
                    if (!App.userModifiedPrices[priceInputId] && App.liveGoldPrice18k > 0) {
                        document.getElementById(priceInputId).value = App.Utils.formatNumber(App.liveGoldPrice18k);
                    }
                });
                this.updateTotal();
            },
            
            addGoldItemRow: function(itemData = {}) {
                const container = document.getElementById('goldItemsContainer');
                const newId = App.Utils.generateUniqueId();
                const newItem = document.createElement('div');
                newItem.className = 'gold-item-row border-b pb-4 mb-4 pt-4';
                newItem.dataset.itemId = newId;
                newItem.dataset.itemType = itemData.itemType || 'manual'; 

                newItem.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
                        <div class="responsive-input-group flex flex-col col-span-2">
                            <label for="itemDescription_${newId}" class="text-xs font-semibold text-dark-text mb-1">توضیحات:</label>
                            <input type="text" id="itemDescription_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-right text-sm">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemWeight_${newId}" class="text-xs font-semibold text-dark-text mb-1">وزن:</label>
                            <input type="number" id="itemWeight_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" value="1" min="0" step="0.01">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemPurity_${newId}" class="text-xs font-semibold text-dark-text mb-1">عیار:</label>
                            <input type="number" list="purity-list" id="itemPurity_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" value="750" step="any">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemGramPrice_${newId}" class="text-xs font-semibold text-dark-text mb-1">فی گرم (۱۸):</label>
                            <input type="text" id="itemGramPrice_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" oninput="App.Utils.formatNumberInput(this)">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemWage_${newId}" class="text-xs font-semibold text-dark-text mb-1">اجرت (%):</label>
                            <input type="number" id="itemWage_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" min="0" step="1">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemProfit_${newId}" class="text-xs font-semibold text-dark-text mb-1">سود (%):</label>
                            <input type="number" id="itemProfit_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" min="0" step="1">
                        </div>
                        <div class="responsive-input-group flex flex-col">
                            <label for="itemVAT_${newId}" class="text-xs font-semibold text-dark-text mb-1">مالیات (%):</label>
                            <input type="number" id="itemVAT_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" min="0" step="1">
                        </div>
                         <div class="responsive-input-group flex flex-col hidden" id="itemDeductionContainer_${newId}">
                            <label for="itemBuyDeduction_${newId}" class="text-xs font-semibold text-dark-text mb-1">کسری خرید:</label>
                            <input type="text" id="itemBuyDeduction_${newId}" class="w-full p-2 rounded-md bg-input-bg-light border border-input-border-light text-left text-sm" oninput="App.Utils.formatNumberInput(this)">
                        </div>
                    </div>
                    <button class="remove-item-btn mt-3 px-3 py-1 bg-red-500 text-white rounded-md text-xs hover:bg-red-600 transition-colors" data-item-id="${newId}"><i class="fas fa-trash-alt mr-1"></i>حذف آیتم</button>
                `;
                container.appendChild(newItem);

                const defaultProfit = App.Utils.getInputValue('invoiceProfit', 7);
                const defaultVAT = App.Utils.getInputValue('invoiceVAT', 10);

                document.getElementById(`itemDescription_${newId}`).value = itemData.description || itemData.name || '';
                document.getElementById(`itemWeight_${newId}`).value = itemData.weight || 1;
                document.getElementById(`itemPurity_${newId}`).value = itemData.purity || 750;

                const wageInput = document.getElementById(`itemWage_${newId}`);
                const profitInput = document.getElementById(`itemProfit_${newId}`);
                const vatInput = document.getElementById(`itemVAT_${newId}`);
                const deductionContainer = document.getElementById(`itemDeductionContainer_${newId}`);
                const deductionInput = document.getElementById(`itemBuyDeduction_${newId}`);

                const allInputs = [wageInput, profitInput, vatInput, deductionInput];
                allInputs.forEach(input => {
                    input.disabled = false;
                    input.style.backgroundColor = '';
                    input.parentElement.classList.add('hidden');
                });
                
                if (itemData.itemType === 'old-gold' || itemData.itemType === 'melted-buy' || (itemData.itemType && itemData.itemType.startsWith('coin'))) {
                    wageInput.value = 0;
                    profitInput.value = 0;
                    vatInput.value = 0;
                    [wageInput, profitInput, vatInput].forEach(input => {
                        input.disabled = true;
                        input.style.backgroundColor = '#e9ecef';
                    });
                     if(itemData.itemType === 'melted-buy') {
                        deductionContainer.classList.remove('hidden');
                        deductionInput.value = App.Utils.formatNumber(itemData.buyDeduction || 100000);
                     }
                } else {
                    wageInput.parentElement.classList.remove('hidden');
                    profitInput.parentElement.classList.remove('hidden');
                    vatInput.parentElement.classList.remove('hidden');
                    wageInput.value = itemData.wage !== undefined ? itemData.wage : 20;
                    profitInput.value = itemData.profit !== undefined ? itemData.profit : defaultProfit;
                    vatInput.value = itemData.vat !== undefined ? itemData.vat : defaultVAT;
                }
                
                const priceInput = document.getElementById(`itemGramPrice_${newId}`);
                let gramPriceToSet = itemData.gramPrice;

                if (gramPriceToSet) {
                    App.userModifiedPrices[priceInput.id] = true;
                    priceInput.value = App.Utils.formatNumber(gramPriceToSet);
                } else if (App.liveGoldPrice18k > 0) {
                    priceInput.value = App.Utils.formatNumber(App.liveGoldPrice18k);
                }

                this.updateTotal();
            },
            removeGoldItemRow: function(button) {
                const itemRow = button.closest('.gold-item-row');
                if (itemRow) {
                    const itemId = itemRow.dataset.itemId;
                    delete App.userModifiedPrices[`itemGramPrice_${itemId}`];
                    itemRow.remove();
                    if (document.getElementById('goldItemsContainer').children.length === 0) {
                        this.addGoldItemRow();
                    }
                    this.updateTotal();
                }
            },
            
            calculateItemFinalPrice: function(row) {
                const U = App.Utils;
                const itemId = row.dataset.itemId;
                const itemType = row.dataset.itemType || 'manual';

                const purity = U.getInputValue(`itemPurity_${itemId}`);
                const weight = U.getInputValue(`itemWeight_${itemId}`);
                const gramPrice = U.getInputValue(`itemGramPrice_${itemId}`);
                
                if (weight <= 0 && !itemType.startsWith('coin')) return { finalPrice: 0, profitAmount: 0, taxAmount: 0 };

                let finalPrice = 0;
                let profitAmount = 0;
                let taxAmount = 0;

                if (itemType.startsWith('coin')) return { finalPrice: weight, profitAmount: 0, taxAmount: 0 }; // برای سکه، قیمت کل در فیلد وزن ذخیره می‌شود تا محاسبات فاکتور ساده‌تر شود
                
                if (itemType === 'old-gold') {
                    const adjustedGramPrice = gramPrice * (purity / 750) * (735 / 750);
                    finalPrice = weight * adjustedGramPrice;
                } else if (itemType === 'melted-buy') {
                    const buyDeduction = U.getInputValue(`itemBuyDeduction_${itemId}`);
                    const effectiveGramPrice18k = gramPrice - (buyDeduction / 4.3318);
                    const adjustedPrice = effectiveGramPrice18k * (purity / 750);
                    finalPrice = weight * adjustedPrice;
                } else { 
                    const wage = U.getInputValue(`itemWage_${itemId}`);
                    const profit = U.getInputValue(`itemProfit_${itemId}`);
                    const vat = U.getInputValue(`itemVAT_${itemId}`);

                    const adjustedGramPrice = gramPrice * (purity / 750);
                    const priceOfGold = weight * adjustedGramPrice;
                    const laborCost = priceOfGold * (wage / 100);
                    profitAmount = (priceOfGold + laborCost) * (profit / 100);
                    const taxBase = laborCost + profitAmount;
                    taxAmount = taxBase * (vat / 100);
                    
                    finalPrice = priceOfGold + laborCost + profitAmount + taxAmount;
                }
                return { finalPrice, profitAmount, taxAmount };
            },

            calculateInvoiceTotals: function() {
                let totalSales = 0;
                let totalPurchases = 0;
                let totalProfit = 0;
                let totalVAT = 0;
                let totalConvertedWeight750 = 0;
                let onlyMeltedItems = true; // Assume true, invalidate if other types are found
                let hasItems = false;

                document.querySelectorAll('.gold-item-row').forEach(row => {
                    hasItems = true;
                    const U = App.Utils;
                    const itemId = row.dataset.itemId;
                    const description = document.getElementById(`itemDescription_${itemId}`).value;
                    const transactionType = description.toLowerCase().includes('خرید') ? 'buy' : 'sell';
                    const itemType = row.dataset.itemType || 'manual';            
                    const { finalPrice, profitAmount, taxAmount } = this.calculateItemFinalPrice(row);
                    // Any item that is not a melted-gold type should invalidate the flag.
                    if (itemType !== 'melted-sell' && itemType !== 'melted-buy') {
                        onlyMeltedItems = false;
                    }   

                    if (transactionType === 'buy') {
                        totalPurchases += finalPrice;
                    } else { // 'sell'
                        totalSales += finalPrice;
                        totalProfit += profitAmount;
                        totalVAT += taxAmount;
                    }

                    if (!itemType.startsWith('coin')) {
                        const weight = U.getInputValue(`itemWeight_${itemId}`);
                        const purity = U.getInputValue(`itemPurity_${itemId}`);
                        totalConvertedWeight750 += weight * (purity / 750);
                    }
                });

                // If there are no items, it's not "only melted items"
                if (!hasItems) {
                    onlyMeltedItems = false;
                }                

                const finalAmount = totalSales - totalPurchases;
                return { totalSales, totalPurchases, finalAmount, totalProfit, totalVAT, totalConvertedWeight750, onlyMeltedItems };
            },

            updateTotal: function() {
                const items = [];
                document.querySelectorAll('.gold-item-row').forEach(row => {
                    const itemId = row.dataset.itemId;
                    const item = {
                        description: document.getElementById(`itemDescription_${itemId}`).value,
                        weight: App.Utils.getInputValue(`itemWeight_${itemId}`),
                        purity: App.Utils.getInputValue(`itemPurity_${itemId}`),
                        wage: App.Utils.getInputValue(`itemWage_${itemId}`),
                        profit: App.Utils.getInputValue(`itemProfit_${itemId}`),
                        vat: App.Utils.getInputValue(`itemVAT_${itemId}`),
                        gramPrice: App.Utils.getInputValue(`itemGramPrice_${itemId}`),
                        itemType: row.dataset.itemType,
                        buyDeduction: row.dataset.itemType === 'melted-buy' ? App.Utils.getInputValue(`itemBuyDeduction_${itemId}`) : 0
                    };
                    items.push(item);
                });
                localStorage.setItem('goldInvoiceItems', JSON.stringify(items));

                const totals = this.calculateInvoiceTotals();
                const U = App.Utils;

                document.getElementById('summaryTotalSales').textContent = `${U.formatNumber(Math.round(totals.totalSales))} تومان`;
                document.getElementById('summaryTotalPurchases').textContent = `${U.formatNumber(Math.round(totals.totalPurchases))} تومان`;
                document.getElementById('summaryFinalAmount').textContent = `${U.formatNumber(Math.round(Math.abs(totals.finalAmount)))} تومان`;
                document.getElementById('summaryFinalAmountLabel').textContent = `مبلغ نهایی ${totals.finalAmount >= 0 ? 'پرداختی' : 'دریافتی'}:`;
            },
            
            generateInvoice: function() {
                const U = App.Utils;
                const customerName = document.getElementById('customerName').value;
                const customerPhone = document.getElementById('customerPhone').value;
                const invoiceDate = document.getElementById('invoiceDate').value;

                U.setInputValueAndLocalStorage('customerName', customerName);
                U.setInputValueAndLocalStorage('customerPhone', customerPhone);

                const invoiceItemsData = [];
                const totals = this.calculateInvoiceTotals();
                let showWage = false;

                document.querySelectorAll('.gold-item-row').forEach(row => {
                    const itemId = row.dataset.itemId;
                    const description = document.getElementById(`itemDescription_${itemId}`).value;
                    
                    if (U.getInputValue(`itemWeight_${itemId}`) <= 0 && !row.dataset.itemType.startsWith('coin')) return;

                    const { finalPrice } = this.calculateItemFinalPrice(row);

                    const item = {
                        description: description,
                        weight: U.getInputValue(`itemWeight_${itemId}`),
                        purity: U.getInputValue(`itemPurity_${itemId}`),
                        transactionType: description.toLowerCase().includes('خرید') ? 'buy' : 'sell',
                        finalPrice: finalPrice,
                        wage: U.getInputValue(`itemWage_${itemId}`),
                        gramPrice: U.getInputValue(`itemGramPrice_${itemId}`),
                        itemType: row.dataset.itemType
                    };

                    if(item.wage > 0) showWage = true;
                    
                    invoiceItemsData.push(item);
                });

                if (invoiceItemsData.length === 0) {
                    App.UI.showMessage('لطفا حداقل یک آیتم معتبر برای صدور فاکتور وارد کنید.');
                    return;
                }

                let baseGramPriceForDisplay = App.liveGoldPrice18k; 
                const firstRelevantItem = invoiceItemsData.find(item => item.itemType !== 'melted-buy' && item.gramPrice > 0);
                if (firstRelevantItem) {
                    baseGramPriceForDisplay = firstRelevantItem.gramPrice;
                }

                let tableHeaders = `
                    <th style="padding: 4px; border: 1px solid #ccc;">ردیف</th>
                    <th style="padding: 4px; border: 1px solid #ccc; text-align: right; width: 40%;">شرح کالا</th>
                    <th style="padding: 4px; border: 1px solid #ccc;">وزن (گرم)</th>
                    <th style="padding: 4px; border: 1px solid #ccc;">عیار</th>
                    <th style="padding: 4px; border: 1px solid #ccc;">وزن (750)</th>
                `;
                if(showWage) tableHeaders += `<th style="padding: 4px; border: 1px solid #ccc;">اجرت (%)</th>`;
                tableHeaders += `<th style="padding: 4px; border: 1px solid #ccc;">مبلغ نهایی (تومان)</th>`;


                let itemsHtml = '';
                invoiceItemsData.forEach((item, i) => {
                    const isCoin = item.itemType.startsWith('coin');
                    const convertedWeight = item.weight * (item.purity / 750);
                    const convertedWeight750Cell = isCoin ? `<td style="padding: 4px; text-align: center;">---</td>` : `<td style="padding: 4px; text-align: center; background-color: #fefce8;">${U.formatNumber(convertedWeight.toFixed(3))}</td>`;
                    
                    let rowHtml = `
                        <tr style="border-bottom: 1px solid #ccc; ${item.transactionType === 'buy' ? 'background-color: #fff5f5;' : ''}">
                            <td style="padding: 4px; text-align: center;">${i + 1}</td>
                            <td style="padding: 4px;">${item.description}</td>
                            <td style="padding: 4px; text-align: center;">${isCoin ? '---' : U.formatNumber(item.weight.toFixed(3))}</td>
                            <td style="padding: 4px; text-align: center;">${isCoin ? '---' : item.purity}</td>
                            ${convertedWeight750Cell}
                    `;
                    if(showWage) rowHtml += `<td style="padding: 4px; text-align: center;">${item.wage > 0 ? item.wage + '%' : '---'}</td>`;
                    rowHtml += `<td style="padding: 4px; text-align: center;">${U.formatNumber(Math.round(item.finalPrice))}</td></tr>`;
                    itemsHtml += rowHtml;
                });
                
                const finalPayableAmount = totals.finalAmount;
                const hasBuyAndSell = totals.totalSales > 0 && totals.totalPurchases > 0;

                let footerHtml;
                if (hasBuyAndSell) {
                    footerHtml = `
                        <div style="font-size: 10pt; line-height: 1.6;">
                            <div>جمع کل فروش: <span style="font-weight: bold;">${U.formatNumber(Math.round(totals.totalSales))}</span> تومان</div>
                            <div>جمع کل خرید: <span style="font-weight: bold;">${U.formatNumber(Math.round(totals.totalPurchases))}</span> تومان</div>
                            <hr style="border: 0; border-top: 1px solid #ccc; margin: 4px 0;" />
                            <div style="font-size: 11pt;"><strong>مبلغ نهایی ${finalPayableAmount >= 0 ? 'پرداختی' : 'دریافتی'}: </strong>
                                <span style="font-size: 1.4rem; font-weight: bold;">${U.formatNumber(Math.round(Math.abs(finalPayableAmount)))}</span> تومان
                            </div>
                        </div>
                    `;
                } else {
                     footerHtml = `
                        <div style="font-size: 11pt;"><strong>مبلغ قابل پرداخت: </strong><span style="font-size: 1.4rem; font-weight: bold;">${U.formatNumber(Math.round(finalPayableAmount))}</span> تومان</div>
                    `;
                }

                let tableFooterHtml = '';
                if (totals.totalSales > 0 || totals.totalPurchases > 0) {
                    const colspan = 4;
                    const totalWeightCell = totals.onlyMeltedItems
                        ? `<td style="padding: 8px; text-align: center; border: 1px solid #ccc;">${U.formatNumber(totals.totalConvertedWeight750.toFixed(3))}</td>`
                        : `<td style="padding: 8px; border: 1px solid #ccc;"></td>`;

                    tableFooterHtml = `
                        <tfoot style="font-weight: bold; background-color: #f0f0f0;">
                            <tr>
                                <td colspan="${colspan}" style="padding: 8px; text-align: right; border: 1px solid #ccc;">جمع کل</td>
                                ${totalWeightCell}
                                ${showWage ? '<td style="padding: 8px; border: 1px solid #ccc;"></td>' : ''}
                                <td style="padding: 8px; text-align: center; border: 1px solid #ccc;">${U.formatNumber(Math.round(totals.finalAmount))}</td>
                            </tr>
                        </tfoot>
                    `;
                }

                let footnoteHtml = '';
                if (totals.totalSales > 0) {
                    const defaultProfit = U.getInputValue('invoiceProfit');
                    const defaultVAT = U.getInputValue('invoiceVAT');
                    footnoteHtml = `<div style="font-size: 8pt; color: #555; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 5px;">`;
                    footnoteHtml += `<span>جنس فوق با اجرت مشخص و سود ${defaultProfit}% و مالیات ارزش افزوده ${defaultVAT}% از اجرت و سود عرضه شده و در موقع فروش با فاکتور و به نرخ روز خریداری خواهد شد.</span>`;
                    footnoteHtml += `</div>`;
                }

                const invoiceContent = `
<div style="font-family: sans-serif; direction: rtl; width: 190mm; margin: auto; font-size: 10pt; color: #333;">
    <header style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #DAA520; padding-bottom: 10px; margin-bottom: 15px;">
        <p style="margin: 4px 0;"><i class="fas fa-map-marker-alt" style="margin-left: 5px; color: #DAA520;"></i>خوی، مجتمع تجاری اداری آنا آتا</p>
        <div style="display: flex; flex-direction: column; align-items: center;">
            <img src="logo.png" alt="لوگو" style="height: 50px; width: auto;" onerror="this.style.display='none'">
            <h1 style="margin: 5px 0 0; color: #DAA520; font-size: 1.2rem; text-align: center;">جواهری فانی</h1>
        </div>
        <p style="margin: 4px 0;"><i class="fas fa-phone-alt" style="margin-left: 5px; color: #DAA520;"></i>09141610649</p>
    </header>
    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 9pt;">
        <div><strong>نام مشتری:</strong> ${customerName || 'نامشخص'}</div>
        <div><strong>شماره تماس:</strong> ${customerPhone || 'نامشخص'}</div>
        <div><strong>تاریخ:</strong> ${invoiceDate}</div>
    </div>
    <div style="text-align: center; margin-bottom: 10px; font-size: 10pt; background-color: #fefae0; padding: 5px; border-radius: 5px;">
        <strong>نرخ هر گرم طلای ۱۸ عیار (۷۵۰) در این فاکتور:</strong> ${U.formatNumber(Math.round(baseGramPriceForDisplay))} تومان
    </div>
    <table style="width: 100%; border-collapse: collapse; font-size: 8.5pt;">
        <thead>
            <tr style="background-color: #f0f0f0;">${tableHeaders}</tr>
        </thead>
        <tbody>${itemsHtml}</tbody>
        ${tableFooterHtml}
    </table>
    <footer style="margin-top: 20px; display: flex; justify-content: space-between; align-items: flex-end;">
        ${footerHtml}
        <div style="text-align: center;">
            <p style="margin-bottom: 25px;">امضای فروشنده</p>
            <div style="border-top: 1px solid #333; width: 150px;"></div>
        </div>
    </footer>
    ${footnoteHtml}
</div>`;
                
                document.getElementById('invoicePreviewContainerWrapper').classList.remove('hidden');
                document.getElementById('invoicePreviewContainer').innerHTML = invoiceContent;
                document.getElementById('print-area').innerHTML = invoiceContent;
                document.getElementById('printInvoiceBtn').classList.remove('hidden');
            },
        },

        Tools: {
            init: function() {
                const toggleBtn = document.getElementById('tools-toggle-btn');
                const sidebar = document.querySelector('.tools-sidebar');
                const icon = toggleBtn ? toggleBtn.querySelector('i') : null;

                if (!toggleBtn || !sidebar || !icon) return;

                const toggleMenu = (forceClose = false) => {
                    const isCurrentlyOpen = sidebar.classList.contains('is-expanded');
                    const shouldOpen = forceClose ? false : !isCurrentlyOpen;

                    sidebar.classList.toggle('is-expanded', shouldOpen);
                    
                    icon.classList.toggle('fa-bars', !shouldOpen);
                    icon.classList.toggle('fa-times', shouldOpen);
                };

                toggleBtn.addEventListener('click', (e) => {
                    toggleMenu();
                });
            }
        },

        Navbar: {
            init: function() {
                this.navbar = document.querySelector('.navbar-top');
                this.container = document.querySelector('.navbar-content-wrapper');
                this.toggleBtn = document.getElementById('navbar-toggle-btn');
                this.items = Array.from(this.container.children);

                this.toggleBtn.addEventListener('click', () => {
                    this.navbar.classList.toggle('expanded');
                    this.setBodyPadding();
                });

                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => this.adjustItems(), 100);
                });
                
                this.adjustItems();
            },

            setBodyPadding: function() {
                const navbarHeight = this.navbar.offsetHeight;
                document.body.style.paddingTop = `${navbarHeight + 10}px`;
            },

            adjustItems: function() {
                // 1. Reset state for measurement
                this.items.forEach(item => item.classList.remove('nav-item-hidden'));
                this.toggleBtn.classList.remove('hidden');
                
                const availableWidth = this.container.offsetWidth;
                const gap = parseInt(getComputedStyle(this.container).gap) || 15;

                let currentWidth = 0;
                let visibleItemsCount = 0;

                // 2. Find how many items fit
                for (const item of this.items) {
                    const itemWidth = item.offsetWidth;
                    const widthWithGap = visibleItemsCount > 0 ? itemWidth + gap : itemWidth;

                    if ((currentWidth + widthWithGap) > availableWidth) {
                        break; // Stop when we overflow
                    }
                    currentWidth += widthWithGap;
                    visibleItemsCount++;
                }

                // 3. If not all items are visible, hide the rest and show the button
                if (visibleItemsCount < this.items.length) {
                    this.items.forEach((item, index) => item.classList.toggle('nav-item-hidden', index >= visibleItemsCount));
                    this.toggleBtn.classList.remove('hidden');
                } else {
                    this.toggleBtn.classList.add('hidden');
                    this.navbar.classList.remove('expanded');
                    this.items.forEach(item => item.classList.remove('nav-item-hidden'));
                }
                
                this.setBodyPadding();
            }
        },

        Tools: {
            init: function() {
                const toggleBtn = document.getElementById('tools-toggle-btn');
                const sidebar = document.querySelector('.tools-sidebar');
                const icon = toggleBtn ? toggleBtn.querySelector('i') : null;

                if (!toggleBtn || !sidebar || !icon) return;

                const toggleMenu = (forceClose = false) => {
                    const isCurrentlyOpen = sidebar.classList.contains('is-expanded');
                    const shouldOpen = forceClose ? false : !isCurrentlyOpen;

                    sidebar.classList.toggle('is-expanded', shouldOpen);
                    
                    icon.classList.toggle('fa-bars', !shouldOpen);
                    icon.classList.toggle('fa-times', shouldOpen);
                };

                toggleBtn.addEventListener('click', (e) => {
                    toggleMenu();
                });
            }
        },

        Navbar: {
            init: function() {
                this.navbar = document.querySelector('.navbar-top');
                this.container = document.querySelector('.navbar-content-wrapper');
                this.toggleBtn = document.getElementById('navbar-toggle-btn');
                this.items = Array.from(this.container.children);

                this.toggleBtn.addEventListener('click', () => {
                    this.navbar.classList.toggle('expanded');
                    this.setBodyPadding();
                });

                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => this.adjustItems(), 100);
                });
                
                this.adjustItems();
            },

            setBodyPadding: function() {
                const navbarHeight = this.navbar.offsetHeight;
                document.body.style.paddingTop = `${navbarHeight + 10}px`;
            },

            adjustItems: function() {
                // 1. Reset state for measurement
                this.items.forEach(item => item.classList.remove('nav-item-hidden'));
                this.toggleBtn.classList.remove('hidden');
                
                const availableWidth = this.container.offsetWidth;
                const gap = parseInt(getComputedStyle(this.container).gap) || 15;

                let currentWidth = 0;
                let visibleItemsCount = 0;

                // 2. Find how many items fit
                for (const item of this.items) {
                    const itemWidth = item.offsetWidth;
                    const widthWithGap = visibleItemsCount > 0 ? itemWidth + gap : itemWidth;

                    if ((currentWidth + widthWithGap) > availableWidth) {
                        break; // Stop when we overflow
                    }
                    currentWidth += widthWithGap;
                    visibleItemsCount++;
                }

                // 3. If not all items are visible, hide the rest and show the button
                if (visibleItemsCount < this.items.length) {
                    this.items.forEach((item, index) => item.classList.toggle('nav-item-hidden', index >= visibleItemsCount));
                    this.toggleBtn.classList.remove('hidden');
                } else {
                    this.toggleBtn.classList.add('hidden');
                    this.navbar.classList.remove('expanded');
                    this.items.forEach(item => item.classList.remove('nav-item-hidden'));
                }
                
                this.setBodyPadding();
            }
        },

        // این تابع فقط یک بار پس از ورود موفق فراخوانی می‌شود
        initAppLogic: function() {
            this.DB.initDB();
            this.Utils.loadValuesFromLocalStorage();
            
            const savedItems = JSON.parse(localStorage.getItem('goldInvoiceItems') || '[]');
            if (savedItems.length > 0) {
                document.getElementById('goldItemsContainer').innerHTML = ''; // Clear default
                savedItems.forEach(itemData => this.Invoice.addGoldItemRow(itemData));
            } else {
                 this.Invoice.addGoldItemRow();
            }

            this.UI.fetchLivePrices();
            setInterval(() => this.UI.fetchLivePrices(), 60000); 
            
            this.Tools.init();
            this.Navbar.init();
            this.UI.showTab('tab-column1');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => this.UI.showTab(btn.id.replace('btn-tab', 'tab-column')));
            });

            document.querySelectorAll('[id^="calculateBtn"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const calcId = btn.id.replace('calculateBtn', 'column');
                    this.Calculators.recalculate(calcId);
                });
            });
            
            document.getElementById('generateInvoiceBtn').addEventListener('click', () => this.Invoice.generateInvoice());
            document.getElementById('printInvoiceBtn').addEventListener('click', () => window.print());
            document.getElementById('addGoldItemBtn').addEventListener('click', () => this.Invoice.addGoldItemRow());

            document.getElementById('goldItemsContainer').addEventListener('click', (e) => {
                const button = e.target.closest('.remove-item-btn');
                if (button) this.Invoice.removeGoldItemRow(button);
            });
            
            document.getElementById('goldItemsContainer').addEventListener('input', (e) => {
                const targetId = e.target.id;
                if (targetId.startsWith('itemGramPrice_')) {
                    App.userModifiedPrices[targetId] = true;
                }
                App.Invoice.updateTotal(); 
            });

            ['invoiceProfit', 'invoiceVAT'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    App.Utils.setInputValueAndLocalStorage(id, e.target.value);
                });
            });

            ['1', '2', '3', '6'].forEach(i => {
                const priceGramInput = document.getElementById(`price_gram${i}`);
                if (priceGramInput) {
                    priceGramInput.addEventListener('input', (e) => {
                        this.Utils.formatNumberInput(e.target);
                        this.userModifiedPrices[e.target.id] = true;
                        this.Calculators.recalculate(`column${i}`);
                    });
                }
                if(i !== '6') { // Column 6 purity is handled differently
                    const purityInput = document.getElementById(`goldPurity${i}`);
                    if (purityInput) {
                        purityInput.addEventListener('change', () => {
                            this.Calculators.recalculate(`column${i}`);
                        });
                    }
                }
            });
            
            // In UI.updateNavbarPrices, we should trigger an adjustment
            const originalUpdateNavbarPrices = this.UI.updateNavbarPrices.bind(this.UI);
            this.UI.updateNavbarPrices = (data, source) => {
                originalUpdateNavbarPrices(data, source);
                setTimeout(() => this.Navbar.adjustItems(), 50);
            };

            document.getElementById('price_gram6').addEventListener('input', (e) => {
                this.Utils.formatNumberInput(e.target);
                this.userModifiedPrices[e.target.id] = true;
            });

            ['price_gram6', 'weight_gram6', 'goldPurity6', 'profit_melted', 'buy_deduction6', 'VAT6'].forEach(id => {
                 document.getElementById(id).addEventListener('input', () => this.Calculators.recalculate('column6'));
            });

            const meltedProfitContainer = document.getElementById('profit_melted').parentElement.parentElement;
            const meltedDeductionContainer = document.getElementById('buyDeductionContainer6');
            const meltedVatContainer = document.getElementById('VAT6').parentElement.parentElement;
            
            const handleTransactionTypeChange = () => {
                const type = document.querySelector('input[name="transaction_type6"]:checked').value;
                if (type === 'buy') {
                    meltedProfitContainer.classList.add('hidden');
                    meltedDeductionContainer.classList.remove('hidden');
                    meltedVatContainer.classList.add('hidden');
                } else { // 'sell'
                    meltedProfitContainer.classList.remove('hidden');
                    meltedDeductionContainer.classList.add('hidden');
                    meltedVatContainer.classList.remove('hidden');
                }
                this.Calculators.recalculate('column6');
            };

            document.querySelectorAll('input[name="transaction_type6"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    handleTransactionTypeChange();
                    localStorage.setItem(e.target.name, e.target.value);
                });
            });

            handleTransactionTypeChange(); // Set initial state on load

            // --- Coin Calculator Event Listeners ---
            document.getElementById('coin_type7').addEventListener('change', () => this.Calculators.updateCoinPrice());
            ['coin_quantity7', 'coin_price7', 'parsian_weight7'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => this.Calculators.calculatecolumn7());
            });
            document.querySelectorAll('input[name="transaction_type7"]').forEach(radio => {
                radio.addEventListener('change', () => this.Calculators.calculatecolumn7());
            });

            document.getElementById('invoiceFromCalc1').addEventListener('click', () => {
                const U = App.Utils;
                const weight = U.unformatNumber(document.getElementById('display-weight1').textContent);
                if (weight > 0) {
                    const itemData = {
                        description: `محصول محاسبه‌شده (قیمت هدف)`,
                        weight: weight,
                        purity: U.getInputValue('goldPurity1'),
                        wage: U.getInputValue('wage1'),
                        profit: U.getInputValue('profit1'),
                        vat: U.getInputValue('VAT1'),
                        gramPrice: U.getInputValue('price_gram1'),
                        itemType: 'manual'
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم با موفقیت به فاکتور اضافه شد.', 'success');
                }
            });

            document.getElementById('invoiceFromCalc2').addEventListener('click', () => {
                const U = App.Utils;
                const weight = U.getInputValue('weight2');
                if (weight > 0) {
                    const itemData = {
                        description: `محصول محاسبه‌شده`,
                        weight: weight,
                        purity: U.getInputValue('goldPurity2'),
                        wage: U.getInputValue('wage2'),
                        profit: U.getInputValue('profit2'),
                        vat: U.getInputValue('VAT2'),
                        gramPrice: U.getInputValue('price_gram2'),
                        itemType: 'manual'
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم با موفقیت به فاکتور اضافه شد.', 'success');
                }
            });

            document.getElementById('invoiceFromCalc3').addEventListener('click', () => {
                const U = App.Utils;
                const weight = U.getInputValue('weight_input3');
                if (weight > 0) {
                    const itemData = {
                        description: `خرید طلای کهنه`,
                        weight: weight,
                        purity: U.getInputValue('goldPurity3'),
                        gramPrice: U.getInputValue('price_gram3'),
                        itemType: 'old-gold'
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم طلای کهنه با موفقیت به فاکتور اضافه شد.', 'success');
                }
            });
            
            document.getElementById('invoiceFromCalc6').addEventListener('click', () => {
                const U = App.Utils;
                const type = document.querySelector('input[name="transaction_type6"]:checked').value;
                const weight = U.getInputValue('weight_gram6');

                if (weight > 0) {
                    const itemData = {
                        description: (type === 'buy' ? 'خرید' : 'فروش') + ' آبشده',
                        weight: weight,
                        purity: U.getInputValue('goldPurity6'),
                        gramPrice: U.getInputValue('price_gram6'),
                        itemType: type === 'buy' ? 'melted-buy' : 'melted-sell',
                        profit: type === 'sell' ? U.getInputValue('profit_melted') : 0,
                        vat: type === 'sell' ? U.getInputValue('VAT6') : 0,
                        wage: 0,
                        buyDeduction: type === 'buy' ? U.getInputValue('buy_deduction6') : 0
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم آبشده با موفقیت به فاکتور اضافه شد.', 'success');
                } else {
                    App.UI.showMessage('ابتدا یک محاسبه معتبر انجام دهید.');
                }
            });
            
            document.getElementById('invoiceFromCalc7').addEventListener('click', () => {
                const U = App.Utils;
                const quantity = U.getInputValue('coin_quantity7');
                const totalPrice = U.getInputValue('display-total-price7');
                const transactionType = document.querySelector('input[name="transaction_type7"]:checked').value;
                const coinSelect = document.getElementById('coin_type7');
                const coinName = coinSelect.options[coinSelect.selectedIndex].text;
                
                if (totalPrice > 0) {
                    let description = `${transactionType === 'buy' ? 'خرید' : 'فروش'} ${U.formatNumber(quantity)} عدد ${coinName}`;
                    if (coinSelect.value === 'parsian') {
                        description += ` به وزن ${U.getInputValue('parsian_weight7')} گرم`;
                    }

                    const itemData = {
                        description: description,
                        weight: totalPrice, // Store total price in weight field for simplicity in invoice calculation
                        purity: 0,
                        gramPrice: 0,
                        itemType: 'coin'
                    };
                    App.UI.showTab('tab-column4');
                    App.Invoice.addGoldItemRow(itemData);
                    App.UI.showMessage('آیتم سکه با موفقیت به فاکتور اضافه شد.', 'success');
                }
            });

            const productForm = document.getElementById('product-form');
            productForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const product = {
                    name: document.getElementById('productName').value,
                    weight: this.Utils.getInputValue('productWeight'),
                    purity: this.Utils.getInputValue('productPurity'),
                    wage: this.Utils.getInputValue('productWage')
                };
                
                const productId = parseInt(document.getElementById('productId').value, 10);
                if (productId) product.id = productId;
                
                this.DB.saveProduct(product);
                productForm.reset();
                document.getElementById('productId').value = '';
                document.getElementById('product-form-title').textContent = 'افزودن جنس جدید';
                document.getElementById('product-form-submit-btn-text').textContent = 'ذخیره جنس';
                document.getElementById('cancelEditBtn').classList.add('hidden');
            });
            
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                 productForm.reset();
                 document.getElementById('productId').value = '';
                 document.getElementById('product-form-title').textContent = 'افزودن جنس جدید';
                 document.getElementById('product-form-submit-btn-text').textContent = 'ذخیره جنس';
                 document.getElementById('cancelEditBtn').classList.add('hidden');
            });

            document.getElementById('productSearch').addEventListener('input', (e) => {
                this.DB.searchProducts(e.target.value);
            });
            
            document.getElementById('productList').addEventListener('click', (e) => {
                const target = e.target;
                const action = target.dataset.action;
                const productId = parseInt(target.dataset.id, 10);
                if (!action || !productId) return;

                if (action === 'delete') {
                    this.UI.showConfirmation('آیا از حذف این جنس اطمینان دارید؟', () => {
                        this.DB.deleteProduct(productId);
                    });
                } else if (action === 'edit') {
                    this.DB.getProduct(productId, (product) => {
                        if (product) {
                            document.getElementById('productId').value = product.id;
                            document.getElementById('productName').value = product.name;
                            document.getElementById('productWeight').value = product.weight;
                            document.getElementById('productPurity').value = product.purity;
                            document.getElementById('productWage').value = product.wage;
                            document.getElementById('product-form-title').textContent = 'ویرایش جنس';
                            document.getElementById('product-form-submit-btn-text').textContent = 'بروزرسانی جنس';
                            document.getElementById('cancelEditBtn').classList.remove('hidden');
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                } else if (action === 'use') {
                    this.DB.getProduct(productId, (product) => {
                        if (product) {
                            this.UI.showTab('tab-column4');
                            this.Invoice.addGoldItemRow(product);
                            this.UI.showMessage(`جنس "${product.name}" به فاکتور اضافه شد.`, 'success');
                        }
                    });
                }
            });
            
            document.getElementById('logout-btn').addEventListener('click', () => {
                this.Auth.handleLogout();
            });
            
            document.getElementById('export-btn').addEventListener('click', () => {
                this.DB.exportToExcel();
            });

            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });

            document.getElementById('import-file-input').addEventListener('change', (event) => {
                this.DB.importFromCSV(event.target.files[0]);
                event.target.value = ''; // ریست کردن اینپوت تا بتوان دوباره همان فایل را انتخاب کرد
            });
        },
        
        // نقطه شروع اصلی برنامه
        init: function() {
            // در ابتدا فقط بخش احراز هویت فعال می‌شود. مابقی برنامه پس از ورود موفق اجرا خواهد شد.
            this.Auth.init();
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        App.init();
    });
</script>
</body>
</html>
